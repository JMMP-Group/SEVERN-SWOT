<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Liverpool Bay 180m NEMO configuration &#8212; NEMO-RELOC 0.1 documentation</title>
    
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="NEMO-RELOC 0.1 documentation" href="index.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="liverpool-bay-180m-nemo-configuration">
<h1>Liverpool Bay 180m NEMO configuration<a class="headerlink" href="#liverpool-bay-180m-nemo-configuration" title="Permalink to this headline">¶</a></h1>
<p><strong>BUILD LBAY MODEL USING BATHY AND COORDINATES FROM POLCOMS</strong></p>
<p>This was taken from the ORCHESTRA branch</p>
<p>URL:: <a class="reference external" href="http://nemo-reloc.readthedocs.io/en/latest/LBay_livljobs4.html">http://nemo-reloc.readthedocs.io/en/latest/LBay_livljobs4.html</a>
<em>Actually I&#8217;ve taken this off readthedocs as it is internal. However writing in</em>
<em>ReStrucTed text means it is trivial to deploy anywhere with whatever style</em></p>
<ul class="simple">
<li>Build notes with:: ~/GitLab/NEMO-RELOC/docs$ make html</li>
</ul>
<p>Notes use a pragmatic combination of livljobs4 and archer. Will run on ARCHER.</p>
<p>For this I use the ORCHESTRA realease of the trunk (&#64;r8395)</p>
<p>The summary procedure:
#. ARCHER: Get code. Build tools. Generate coordinates, bathymetry, domain_cfg.nc
#. ARCHER: Generate initial conditions and atmospheric forcings
#. LIVLJOBS4: Generate boundary conditions with NRCT/PyNEMO
#. ARCHER: Run simulation</p>
<div class="section" id="issues-that-arose">
<h2>Issues that arose<a class="headerlink" href="#issues-that-arose" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>...</li>
</ul>
</div>
<hr class="docutils" />
<div class="section" id="recipe-notes">
<h2>Recipe Notes<a class="headerlink" href="#recipe-notes" title="Permalink to this headline">¶</a></h2>
<p>In the following I build most stuff on ARCHER but the PyNEMO bits are done on livljobs4.
(There was a problem with some java bits working on ARCHER)
Starting on ARCHER:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="n">login</span><span class="o">.</span><span class="n">archer</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">uk</span>
</pre></div>
</div>
<p>It is quite convenient to define a temporary file with all the path names in.
The first line defines the configuration name (assuming bash):</p>
<p>cat &gt; ~/temporary_path_names_for_NEMO_build &lt;&lt; EOL
export CONFIG=LBay180
export WORK=/work/n01/n01
export WDIR=$WORK/$USER/$CONFIG
export INPUTS=$WDIR/INPUTS
export START_FILES=$WDIR/START_FILES
export CDIR=$WDIR/trunk_NEMOGCM_r8395/CONFIG
export TDIR=$WDIR/trunk_NEMOGCM_r8395/TOOLS
export EXP=$CDIR/$CONFIG/EXP00</p>
<p>module swap PrgEnv-cray PrgEnv-intel
module load cray-netcdf-hdf5parallel cray-hdf5-parallel
EOL</p>
<p>Execute path settings:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">.</span> <span class="o">~/</span><span class="n">temporary_path_names_for_NEMO_build</span>
</pre></div>
</div>
<p>&#8212;</p>
</div>
<div class="section" id="collect-essential-files">
<h2>Collect essential files<a class="headerlink" href="#collect-essential-files" title="Permalink to this headline">¶</a></h2>
<p>Note you might have to mkdir the odd directory or two...:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>mkdir $WDIR
mkdir $INPUTS
mkdir $START_FILES
</pre></div>
</div>
<p>If we were building from GEBCO and an ORCA12 grid we would also want:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cp $WDIR/../LBay/START_FILES/coordinates_ORCA_R12.nc $START_FILES/.
cp $WDIR/../LBay/INPUTS/namelist_reshape_bilin_gebco $START_FILES/.
</pre></div>
</div>
<p>Checkout and build NEMO (ORCHESTRA) trunk &#64; r8395 <a href="#id7"><span class="problematic" id="id8">`build_opa_orchestra.html`_</span></a>.
Or just build:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cd $CDIR
./makenemo -n $CONFIG -m XC_ARCHER_INTEL -j 10
</pre></div>
</div>
<p>&#8212;</p>
<p>Checkout and build XIOS2 &#64; r1080 <a href="#id9"><span class="problematic" id="id10">`build_XIOS2.html`_</span></a>:</p>
<p>Or just link XIOS executable to the EXP directory:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>ln -s  /work/n01/n01/$USER/xios-2.0_r1080/bin/xios_server.exe $EXP/xios_server.exe
</pre></div>
</div>
<p>&#8212;</p>
</div>
<div class="section" id="build-tools">
<h2>Build TOOLS<a class="headerlink" href="#build-tools" title="Permalink to this headline">¶</a></h2>
<p>To generate domain coords and rebuild tools we first need
to compile some of the NEMO TOOLS.</p>
<p>First build DOMAINcfg (which is relatively new and in NEMOv4). Use my XIOS1 file
(see userid and path in variable <code class="docutils literal"><span class="pre">%XIOS_HOME</span></code>). Copy from ARCH <em>store</em>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cp $WORK/$USER/ARCH/arch-XC_ARCHER_INTEL_XIOS1.fcm $CDIR/../ARCH/.
cd $TDIR

./maketools -m XC_ARCHER_INTEL_XIOS1 -n DOMAINcfg
./maketools -m XC_ARCHER_INTEL_XIOS1 -n REBUILD_NEMO
</pre></div>
</div>
<p>For the generation of bathymetry and met forcing weights files we need to patch
the code (to allow direct passing of arguments. NB this code has not been
updated in 7 years.):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cd $TDIR/WEIGHTS/src
patch -b &lt; $START_FILES/scripinterp_mod.patch
patch -b &lt; $START_FILES/scripinterp.patch
patch -b &lt; $START_FILES/scrip.patch
patch -b &lt; $START_FILES/scripshape.patch
patch -b &lt; $START_FILES/scripgrid.patch

cd $TDIR
./maketools -m XC_ARCHER_INTEL_XIOS1 -n WEIGHTS
</pre></div>
</div>
<div class="section" id="copy-bathymetry-and-coordinates-file">
<h3>0. Copy bathymetry and coordinates file<a class="headerlink" href="#copy-bathymetry-and-coordinates-file" title="Permalink to this headline">¶</a></h3>
<p>This is slight departure from the normal grid generate because we already have
target a bathymetry and coordinates file. By the end of the process we end up with
<code class="docutils literal"><span class="pre">bathy_meter.nc</span></code> and <code class="docutils literal"><span class="pre">coordinates.nc</span></code> in the INPUTS directory.</p>
<p>Jason converted old POLCOMS files into NEMO speak:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">ls</span> <span class="o">/</span><span class="mi">9900</span><span class="n">a</span><span class="o">/</span><span class="n">NEMO</span><span class="o">/</span><span class="n">jholt</span><span class="o">/</span><span class="n">mfiles</span><span class="o">/</span><span class="n">POLCOMS_2_NEMO</span>
<span class="n">bathy_meter</span><span class="o">.</span><span class="n">nc</span>  <span class="n">bathy</span><span class="o">.</span><span class="n">png</span>  <span class="n">coordinates</span><span class="o">.</span><span class="n">nc</span>  <span class="n">plocoms_2_nemo</span><span class="o">.</span><span class="n">m</span>  <span class="n">polcoms2nemo_func</span><span class="o">.</span><span class="n">m</span>
</pre></div>
</div>
<p>Copy these files to an EXP directory:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>livljobs4$
cd /9900a/NEMO/jholt/mfiles/POLCOMS_2_NEMO
scp coordinates.nc jelt@login.archer.ac.uk:/work/n01/n01/jelt/LBay180/INPUTS/4d_coordinates.nc
scp bathy_meter.nc jelt@login.archer.ac.uk:/work/n01/n01/jelt/LBay180/INPUTS/bathy_meter.nc
</pre></div>
</div>
<p>Back on <strong>ARCHER</strong></p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cd $INPUTS
ncdump -h 4d_coordinates.nc
x = 269 ;
y = 189 ;
z = 1 ;
time = 1 ;
...
</pre></div>
</div>
<p>Have to average over the depth and time dimensions to remove redundant dimensions.
Fix all the depth value to be postive:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">module</span> <span class="n">unload</span> <span class="n">cray</span><span class="o">-</span><span class="n">netcdf</span><span class="o">-</span><span class="n">hdf5parallel</span> <span class="n">cray</span><span class="o">-</span><span class="n">hdf5</span><span class="o">-</span><span class="n">parallel</span>
<span class="n">module</span> <span class="n">load</span> <span class="n">cray</span><span class="o">-</span><span class="n">netcdf</span> <span class="n">cray</span><span class="o">-</span><span class="n">hdf5</span>
<span class="n">module</span> <span class="n">load</span> <span class="n">nco</span><span class="o">/</span><span class="mf">4.5</span><span class="o">.</span><span class="mi">0</span>

<span class="n">ncwa</span> <span class="o">-</span><span class="n">a</span> <span class="n">time</span><span class="p">,</span><span class="n">z</span> <span class="mi">4</span><span class="n">d_coordinates</span><span class="o">.</span><span class="n">nc</span>  <span class="n">coordinates</span><span class="o">.</span><span class="n">nc</span>
<span class="n">ncap2</span> <span class="o">-</span><span class="n">s</span> <span class="s1">&#39;where(Bathymetry &lt; 0) Bathymetry=0&#39;</span> <span class="n">bathy_meter</span><span class="o">.</span><span class="n">nc</span> <span class="n">tmp</span><span class="o">.</span><span class="n">nc</span>

<span class="n">module</span> <span class="n">unload</span> <span class="n">nco</span> <span class="n">cray</span><span class="o">-</span><span class="n">netcdf</span> <span class="n">cray</span><span class="o">-</span><span class="n">hdf5</span>
<span class="n">module</span> <span class="n">load</span> <span class="n">cray</span><span class="o">-</span><span class="n">netcdf</span><span class="o">-</span><span class="n">hdf5parallel</span> <span class="n">cray</span><span class="o">-</span><span class="n">hdf5</span><span class="o">-</span><span class="n">parallel</span>
</pre></div>
</div>
<p>Remove 4d coordinates file:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>rm -f $INPUTS/4d_coordinates.nc
</pre></div>
</div>
<p>Overwrite the bathymetry file:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">mv</span> <span class="n">tmp</span><span class="o">.</span><span class="n">nc</span> <span class="n">bathy_meter</span><span class="o">.</span><span class="n">nc</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="generate-a-domain-configuration-file">
<h2>3. Generate a domain configuration file<a class="headerlink" href="#generate-a-domain-configuration-file" title="Permalink to this headline">¶</a></h2>
<p>The general idea is that you have to copy the <code class="docutils literal"><span class="pre">namelist_cfg</span></code> file into the <code class="docutils literal"><span class="pre">DOMAINcfg</span></code>
directory along with all the inputs files that would have previously been needed
get v3.6 running. The reason being that all the non-time stepping stuff, like
grid generating, has been abstracted from the core OPA code and is now done as
a pre-processing step, and output into an important file <code class="docutils literal"><span class="pre">domain_cfg.nc</span></code>.</p>
<p>Copy essential files into DOMAINcfg directory:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cp $INPUTS/coordinates.nc $TDIR/DOMAINcfg/.
cp $INPUTS/bathy_meter.nc $TDIR/DOMAINcfg/.
</pre></div>
</div>
<p>Edit the template namelist_cfg with only the essenetial domain building stuff.
Get the size of the new domain from <code class="docutils literal"><span class="pre">ncdump</span> <span class="pre">-h</span> <span class="pre">bathy_meter.nc</span></code>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">---</span>
</pre></div>
</div>
<p>Get namelist_cfg from <code class="docutils literal"><span class="pre">working</span></code> LBay experiment. (NB this may have changed).
Edit namelist_cfg for this domain:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cd $TDIR/DOMAINcfg
vi namelist_cfg

!-----------------------------------------------------------------------
&amp;namcfg        !   parameters of the configuration
!-----------------------------------------------------------------------
   !
   ln_e3_dep   = .false.    ! =T : e3=dk[depth] in discret sens.
   !                       !      ===&gt;&gt;&gt; will become the only possibility in v4.0
   !                       ! =F : e3 analytical derivative of depth function
   !                       !      only there for backward compatibility test with v3.6
   !                       !
   cp_cfg      =  &quot;orca&quot;   !  name of the configuration
   jp_cfg      =       0   !  resolution of the configuration
   jpidta      =     269               !  1st lateral dimension ( &gt;= jpi )
   jpjdta      =     189               !  2nd    &quot;         &quot;    ( &gt;= jpj )
   jpkdta      =      51               !  number of levels      ( &gt;= jpk )
   jpiglo      =     269               !  1st dimension of global domain --&gt; i =jpidta
   jpjglo      =     189               !  2nd    -                  -    --&gt; j  =jpjdta
   ...

!-----------------------------------------------------------------------
&amp;namzgr        !   vertical coordinate                                  (default: NO selection)
!-----------------------------------------------------------------------
  ln_zco      = .false.   !  z-coordinate - full    steps
  ln_zps      = .false.   !  z-coordinate - partial steps
  ln_sco      = .true.    !  s- or hybrid z-s-coordinate
  ln_isfcav   = .false.   !  ice shelf cavity
  ln_linssh   = .false.   !  linear free surface
/
!-----------------------------------------------------------------------
&amp;namzgr_sco    !   s-coordinate or hybrid z-s-coordinate
!-----------------------------------------------------------------------
  ln_s_sh94   = .false.    !  Song &amp; Haidvogel 1994 hybrid S-sigma   (T)|
  ln_s_sf12   = .true.   !  Siddorn &amp; Furner 2012 hybrid S-z-sigma (T)| if both are false the NEMO tanh stretching is applied
  ln_sigcrit  = .true.    !  use sigma coordinates below critical depth (T) or Z coordinates (F) for Siddorn &amp; Furner stretch
                          !  stretching coefficients for all functions
  rn_jpk      =  51       ! Number of S levels
  ln_eq_taper = .false.   !  Tapering of S coords near equator
  cn_coord_hgr = &#39;coordinates.nc&#39;  ! File containing gphit (latitude) coordinate for use if ln_eq_taper=.true.
  rn_sbot_min =   10.0    !  minimum depth of s-bottom surface (&gt;0) (m)
  rn_sbot_max = 7000.0    !  maximum depth of s-bottom surface (= ocean depth) (&gt;0) (m)
  rn_hc       =   50.0    !  critical depth for transition to stretched coordinates
                       !!!!!!!  Envelop bathymetry
  rn_rmax     =    0.3    !  maximum cut-off r-value allowed (0&lt;r_max&lt;1)
                       !!!!!!!  SH94 stretching coefficients  (ln_s_sh94 = .true.)
  rn_theta    =    6.0    !  surface control parameter (0&lt;=theta&lt;=20)
  rn_bb       =    0.8    !  stretching with SH94 s-sigma
                       !!!!!!!  SF12 stretching coefficient  (ln_s_sf12 = .true.)
  rn_alpha    =    4.4    !  stretching with SF12 s-sigma
  rn_efold    =    0.0    !  efold length scale for transition to stretched coord
  rn_zs       =    1.0    !  depth of surface grid box
                          !  bottom cell depth (Zb) is a linear function of water depth Zb = H*a + b
  rn_zb_a     =    0.024  !  bathymetry scaling factor for calculating Zb
  rn_zb_b     =   -0.2    !  offset for calculating Zb
                       !!!!!!!! Other stretching (not SH94 or SF12) [also uses rn_theta above]
  rn_thetb    =    1.0    !  bottom control parameter  (0&lt;=thetb&lt;= 1)
/
</pre></div>
</div>
<p>Write a runscript and submit:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>vi rs

#!/bin/bash
#PBS -N domain_cfg
#PBS -l walltime=00:04:00
#PBS -l select=1
#PBS -j oe
#PBS -A n01-NOCL
# mail alert at (b)eginning, (e)nd and (a)bortion of execution
#PBS -m bea
#PBS -M jelt@noc.ac.uk
#! -----------------------------------------------------------------------------

# Change to the directory that the job was submitted from
cd $PBS_O_WORKDIR

# Set the number of threads to 1
#   This prevents any system libraries from automatically
#   using threading.
export OMP_NUM_THREADS=1
# Change to the directory that the job was submitted from
ulimit -s unlimited

#===============================================================
# LAUNCH JOB
#===============================================================
echo `date` : Launch Job
aprun -n 1 -N 1 ./make_domain_cfg.exe &gt;&amp;  stdouterr_cfg

exit
</pre></div>
</div>
<p>Try running it:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cd $TDIR/DOMAINcfg
qsub -q short rs
</pre></div>
</div>
<dl class="docutils">
<dt>Copy domain_cfg.nc to the EXP directory (also copy it to the INPUTS directory, which stores</dt>
<dd><p class="first">the bits and bobs for a rebuild):</p>
<div class="last highlight-default"><div class="highlight"><pre><span></span>cp $TDIR/DOMAINcfg/domain_cfg.nc $EXP/.
cp $TDIR/DOMAINcfg/domain_cfg.nc $INPUTS/.
</pre></div>
</div>
</dd>
</dl>
<div class="section" id="generate-initial-conditions">
<h3>4. Generate initial conditions<a class="headerlink" href="#generate-initial-conditions" title="Permalink to this headline">¶</a></h3>
<p><strong>SKIP THIS FOR NOW</strong></p>
<p>This is a bit of a pain because PyNEMO wont work until tracers and on. However
much of the hard work setting up initial T,S conditions was done for a previous LBay
config using AMM60, so I will copy that recipe here. <em>(The caveat is that some *
*of the paths might assume I am working in the LBay not LBay180 config)</em></p>
<p>Copy <code class="docutils literal"><span class="pre">make.macro</span></code> file and edit the path if necessary::
<strong>FIX</strong> to the notes (copied from jdha instead): <code class="docutils literal"><span class="pre">cp</span> <span class="pre">$WDIR/INPUTS/make.macro</span> <span class="pre">./</span></code>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">jdha</span><span class="o">/</span><span class="n">sosie</span><span class="o">/</span><span class="n">make</span><span class="o">.</span><span class="n">macro</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">jelt</span><span class="o">/</span><span class="n">sosie</span><span class="o">/.</span>

<span class="n">vi</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">jelt</span><span class="o">/</span><span class="n">sosie</span><span class="o">/</span><span class="n">make</span><span class="o">.</span><span class="n">macro</span>
<span class="c1"># Directory to install binaries:</span>
<span class="n">INSTALL_DIR</span> <span class="o">=</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">jelt</span><span class="o">/</span><span class="n">local</span>
</pre></div>
</div>
<p>Proceed with Step 6 (of Lighhouse Reef Readthedocs):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cd ~
mkdir local
svn co svn://svn.code.sf.net/p/sosie/code/trunk sosie
cd sosie

make
make install
export PATH=~/local/bin:$PATH
cd $WDIR/INPUTS
</pre></div>
</div>
<p>Obtain the fields to interpolate. Interpolate AMM60
data. Get the namelists:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cp $INPUTS/initcd_votemper.namelist .
cp $INPUTS/initcd_vosaline.namelist .
</pre></div>
</div>
<p>Generate the actual files. Cut them out of something bigger. Use the same indices
as used in coordinates.nc (note that the nco tools don&#8217;t like the
parallel modules):</p>
<p>Insert new method to use AMM60 data for initial conditions.
/work/n01/n01/kariho40/NEMO/NEMOGCM_jdha/dev_r4621_NOC4_BDY_VERT_INTERP/NEMOGCM/CONFIG/AMM60smago/EXP_notradiff/OUTPUT
AMM60_5d_20131013_20131129_grid_T.nc</p>
<p>Find the AMM60 indices using FERRET on the bathy_meter.nc file: <code class="docutils literal"><span class="pre">shade</span> <span class="pre">log(Bathymetry[I=540:750,</span> <span class="pre">J=520:820])</span></code>
<em>(This is old. I assume that these coords are for the whole S Irish Sea..)</em></p>
<p>Note that the temperature and salinity variables are <code class="docutils literal"><span class="pre">thetao</span></code> and <code class="docutils literal"><span class="pre">so</span></code></p>
<div class="highlight-default"><div class="highlight"><pre><span></span>module unload cray-netcdf-hdf5parallel cray-hdf5-parallel
module load cray-netcdf cray-hdf5
module load nco/4.5.0
cd $WDIR/INPUTS

ncks -d x,560,620 -d y,720,800 /work/n01/n01/kariho40/NEMO/NEMOGCM_jdha/dev_r4621_NOC4_BDY_VERT_INTERP/NEMOGCM/CONFIG/AMM60smago/EXP_notradiff/OUTPUT/AMM60_5d_20131013_20131129_grid_T.nc $WDIR/INPUTS/cut_down_20131013_LBay_grid_T.nc
</pre></div>
</div>
<p>Average over time and restore the parallel modules:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>ncwa -a time_counter $WDIR/INPUTS/cut_down_20131013_LBay_grid_T.nc  $WDIR/INPUTS/cut_down_201310_LBay_grid_T.nc

module unload nco cray-netcdf cray-hdf5
module load cray-netcdf-hdf5parallel cray-hdf5-parallel
</pre></div>
</div>
<p>Edit namelists:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">vi</span> <span class="n">initcd_votemper</span><span class="o">.</span><span class="n">namelist</span>
<span class="n">cf_in</span>     <span class="o">=</span> <span class="s1">&#39;cut_down_201310_LBay_grid_T.nc&#39;</span>
<span class="n">cv_in</span>     <span class="o">=</span> <span class="s1">&#39;thetao&#39;</span>
<span class="n">cf_x_in</span>   <span class="o">=</span> <span class="s1">&#39;cut_down_201310_LBay_grid_T.nc&#39;</span>
<span class="n">cv_out</span>   <span class="o">=</span> <span class="s1">&#39;thetao&#39;</span>
<span class="n">csource</span>  <span class="o">=</span> <span class="s1">&#39;AMM60&#39;</span>
<span class="n">ctarget</span>  <span class="o">=</span> <span class="s1">&#39;LBay&#39;</span>

<span class="n">vi</span> <span class="n">initcd_vosaline</span><span class="o">.</span><span class="n">namelist</span>
<span class="o">...</span>
<span class="n">cv_out</span>   <span class="o">=</span> <span class="s1">&#39;so&#39;</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Do stuff. I think the intention was for SOSIE to flood fill the land:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">sosie</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span><span class="n">f</span> <span class="n">initcd_votemper</span><span class="o">.</span><span class="n">namelist</span>
</pre></div>
</div>
<p>Creates:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">thetao_AMM60</span><span class="o">-</span><span class="n">LBay_2013</span><span class="o">.</span><span class="n">nc4</span>
<span class="n">sosie_mapping_AMM60</span><span class="o">-</span><span class="n">LBay</span><span class="o">.</span><span class="n">nc</span>
</pre></div>
</div>
<p>Repeat for salinity:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">sosie</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span><span class="n">f</span> <span class="n">initcd_vosaline</span><span class="o">.</span><span class="n">namelist</span>
</pre></div>
</div>
<p>Creates:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">so_AMM60</span><span class="o">-</span><span class="n">LBay_2013</span><span class="o">.</span><span class="n">nc4</span>
</pre></div>
</div>
<p><em>15 Oct 2017 - this is where I actually pick up work done in LBay and copy to LBay180</em>
.. note: mkdir $INPUTS</p>
<blockquote>
<div>cd $INPUTS
cp $INPUTS/../../LBay/INPUTS/so_AMM60-LBay_2013.nc4 .
cp $INPUTS/../../LBay/INPUTS/thetao_AMM60-LBay_2013.nc4 .
cp $EXP/coordinates.nc .</div></blockquote>
<p>Now do interpolation as before. First copy the namelists:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cp $START_FILES/namelist_reshape_bilin_initcd_votemper $INPUTS/.
cp $START_FILES/namelist_reshape_bilin_initcd_vosaline $INPUTS/.
</pre></div>
</div>
<p>Edit the input files:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>vi $INPUTS/namelist_reshape_bilin_initcd_votemper
&amp;grid_inputs
  input_file = &#39;thetao_AMM60-LBay_2013.nc4&#39;
...

&amp;interp_inputs
  input_file = &quot;thetao_AMM60-LBay_2013.nc4&quot;
...
</pre></div>
</div>
<p>Simiarly for the <a href="#id1"><span class="problematic" id="id2">*</span></a>vosaline.nc file:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>vi $WDIR/INPUTS/namelist_reshape_bilin_initcd_vosaline
&amp;grid_inputs
  input_file = &#39;so_AMM60-LBay_2013.nc4&#39;
...

&amp;interp_inputs
  input_file = &quot;so_AMM60-LBay_2013.nc4&quot;
...
</pre></div>
</div>
<p>This is where I cheekily use prebuild tools:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>export OLD_TDIR=$WORK/$USER/LBay/dev_r4621_NOC4_BDY_VERT_INTERP/NEMOGCM/TOOLS
</pre></div>
</div>
<p>Produce the remap files:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$OLD_TDIR/WEIGHTS/scripgrid.exe namelist_reshape_bilin_initcd_votemper
</pre></div>
</div>
<p>Creates <code class="docutils literal"><span class="pre">remap_nemo_grid_R12.nc</span></code> and <code class="docutils literal"><span class="pre">remap_data_grid_R12.nc</span></code>. Then:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$OLD_TDIR/WEIGHTS/scrip.exe namelist_reshape_bilin_initcd_votemper
</pre></div>
</div>
<p>Creates <code class="docutils literal"><span class="pre">data_nemo_bilin_R12.nc</span></code>. Then:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$OLD_TDIR/WEIGHTS/scripinterp.exe namelist_reshape_bilin_initcd_votemper
</pre></div>
</div>
<p>Creates <code class="docutils literal"><span class="pre">initcd_votemper.nc</span></code>. Then:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$OLD_TDIR/WEIGHTS/scripinterp.exe namelist_reshape_bilin_initcd_vosaline
</pre></div>
</div>
<p>Creates <code class="docutils literal"><span class="pre">initcd_vosaline.nc</span></code>.</p>
<p>THIS IS WHERE START WITH <strong>LIVLJOBS4</strong> to create boundary files with PyNEMO <em>(20 Sept 2017)</em>
If all the files are ready to go jump straight to <a class="reference internal" href="#generate-boundary-conditions-with-pynemo-run-pynemo">7. Generate boundary conditions with PyNEMO: Run PyNEMO</a></p>
</div>
</div>
<div class="section" id="set-up-directory-structure-and-files-in-livljobs4">
<h2>Set up directory structure and files in livljobs4<a class="headerlink" href="#set-up-directory-structure-and-files-in-livljobs4" title="Permalink to this headline">¶</a></h2>
<p>Define paths:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cat &gt; ~/temporary_path_names_for_NEMO_build &lt;&lt; EOL
export CONFIG=LBay180
export WORK=/work
export WDIR=\$WORK/$USER/NEMO/\$CONFIG
export INPUTS=\$WDIR/INPUTS
export START_FILES=\$WDIR/START_FILES
#export CDIR=\$WDIR/trunk_NEMOGCM_r8395/CONFIG
#export TDIR=\$WDIR/trunk_NEMOGCM_r8395/TOOLS
#export EXP=\$CDIR/\$CONFIG/EXP00

EOL
</pre></div>
</div>
<p>Execute path settings:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">.</span> <span class="o">~/</span><span class="n">temporary_path_names_for_NEMO_build</span>
</pre></div>
</div>
<p>Synchronise with key files from ARCHER:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>rsync -utv $USER@login.archer.ac.uk:/work/n01/n01/$USER/$CONFIG/INPUTS/bathy_meter.nc $INPUTS/.
rsync -utv $USER@login.archer.ac.uk:/work/n01/n01/$USER/$CONFIG/INPUTS/coordinates.nc $INPUTS/.
rsync -utv $USER@login.archer.ac.uk:/work/n01/n01/$USER/$CONFIG/INPUTS/domain_cfg.nc  $INPUTS/.

rsync -utv $USER@login.archer.ac.uk:/work/n01/n01/$USER/$CONFIG/START_FILES/mask_AMM60.nc  $START_FILES/.
rsync -utv $USER@login.archer.ac.uk:/work/n01/n01/$USER/$CONFIG/START_FILES/mesh_zgr_AMM60.nc  $START_FILES/.
rsync -utv $USER@login.archer.ac.uk:/work/n01/n01/$USER/$CONFIG/START_FILES/mesh_hgr_AMM60.nc  $START_FILES/.
</pre></div>
</div>
</div>
<div class="section" id="statement-about-external-forcing">
<h2>Statement about external forcing<a class="headerlink" href="#statement-about-external-forcing" title="Permalink to this headline">¶</a></h2>
<p>Uses AMM60 data via a thredds server.
I have the AMM60 mesh and mask files <code class="docutils literal"><span class="pre">mask_src.nc</span>&#160; <span class="pre">mesh_hgr_src.nc</span>&#160; <span class="pre">mesh_zgr_src.nc</span></code></p>
<blockquote>
<div><p>stored locally.</p>
<p>Copy necessary files into INPUTS:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>ln -s $START_FILES/mask_AMM60.nc     $INPUTS/mask_src.nc
ln -s $START_FILES/mesh_hgr_AMM60.nc $INPUTS/mesh_hgr_src.nc
ln -s $START_FILES/mesh_zgr_AMM60.nc $INPUTS/mesh_zgr_src.nc

ls -lh $INPUTS/bathy_meter.nc
ls -lh $INPUTS/coordinates.nc
ls -lh $INPUTS/domain_cfg.nc
</pre></div>
</div>
</div></blockquote>
<p>Need to generate 3 more files: A <code class="docutils literal"><span class="pre">thredds_namelist.bdy</span></code> which drives PyNEMO and which
has two input files: <code class="docutils literal"><span class="pre">inputs_src.ncml</span></code> which points to the data source and
<code class="docutils literal"><span class="pre">inputs_dst.ncml</span></code> which remaps some variable names in the destination files.</p>
<div class="section" id="generate-boundary-conditions-with-nrct-pynemo-create-netcdf-abstraction-wrapper">
<h3>6. Generate boundary conditions with NRCT/PyNEMO: Create netcdf abstraction wrapper<a class="headerlink" href="#generate-boundary-conditions-with-nrct-pynemo-create-netcdf-abstraction-wrapper" title="Permalink to this headline">¶</a></h3>
<p>First install PyNEMO <a href="#id11"><span class="problematic" id="id12">`install_nrct`_</span></a> if not already done so.</p>
</div>
<div class="section" id="a-generate-ncml-file-that-points-to-the-external-data">
<h3>6a. Generate ncml file that points to the external data<a class="headerlink" href="#a-generate-ncml-file-that-points-to-the-external-data" title="Permalink to this headline">¶</a></h3>
<p>This can be done with the automatic generator (<em>pynemo_ncml_generator</em>) or manually</p>
<p>Here the object is to generate a ncml file that is read in by PyNEMO as the <code class="docutils literal"><span class="pre">sn_src_dir</span></code>
(in the <code class="docutils literal"><span class="pre">namelist.bdy</span></code> file)</p>
<dl class="docutils">
<dt>Note need to set the time variables and new <code class="docutils literal"><span class="pre">sn_src_dir</span></code> in namelist.bdy.</dt>
<dd><p class="first">(Note, need the time variables corresponding to simulation window and the time_origin
which are set in namelist.bdy):</p>
<div class="last highlight-default"><div class="highlight"><pre><span></span>cd $INPUTS
vi inputs_src.ncml

&lt;ns0:netcdf xmlns:ns0=&quot;http://www.unidata.ucar.edu/namespaces/netcdf/ncml-2.2&quot; title=&quot;NEMO aggregation&quot;&gt;
&lt;ns0:aggregation type=&quot;union&quot;&gt;
  &lt;ns0:netcdf&gt;
    &lt;ns0:aggregation dimName=&quot;time_counter&quot; name=&quot;temperature&quot; type=&quot;joinExisting&quot;&gt;
        &lt;ns0:netcdf location=&quot;http://gws-access.ceda.ac.uk/public/nemo/vol5-public/AMM60/pycnmix/AMM60_5d_20130814_20131012_grid_T.nc&quot; /&gt;
    &lt;/ns0:aggregation&gt;
  &lt;/ns0:netcdf&gt;
  &lt;ns0:netcdf&gt;
    &lt;ns0:aggregation dimName=&quot;time_counter&quot; name=&quot;salinity&quot; type=&quot;joinExisting&quot;&gt;
        &lt;ns0:netcdf location=&quot;http://gws-access.ceda.ac.uk/public/nemo/vol5-public/AMM60/pycnmix/AMM60_5d_20130814_20131012_grid_T.nc&quot; /&gt;
    &lt;/ns0:aggregation&gt;
  &lt;/ns0:netcdf&gt;
  &lt;ns0:netcdf&gt;
    &lt;ns0:aggregation dimName=&quot;time_counter&quot; name=&quot;zonal_velocity&quot; type=&quot;joinExisting&quot;&gt;
        &lt;ns0:netcdf location=&quot;http://gws-access.ceda.ac.uk/public/nemo/vol5-public/AMM60/pycnmix/AMM60_5d_20130814_20131012_grid_U.nc&quot; /&gt;
    &lt;/ns0:aggregation&gt;
  &lt;/ns0:netcdf&gt;
  &lt;ns0:netcdf&gt;
    &lt;ns0:aggregation dimName=&quot;time_counter&quot; name=&quot;meridian_velocity&quot; type=&quot;joinExisting&quot;&gt;
        &lt;ns0:netcdf location=&quot;http://gws-access.ceda.ac.uk/public/nemo/vol5-public/AMM60/pycnmix/AMM60_5d_20130814_20131012_grid_V.nc&quot; /&gt;
    &lt;/ns0:aggregation&gt;
  &lt;/ns0:netcdf&gt;
  &lt;ns0:netcdf&gt;
    &lt;ns0:aggregation dimName=&quot;time_counter&quot; name=&quot;sea_surface_height&quot; type=&quot;joinExisting&quot;&gt;
        &lt;ns0:netcdf location=&quot;http://gws-access.ceda.ac.uk/public/nemo/vol5-public/AMM60/pycnmix/AMM60_5d_20130814_20131012_grid_T.nc&quot; /&gt;
    &lt;/ns0:aggregation&gt;
  &lt;/ns0:netcdf&gt;
&lt;/ns0:aggregation&gt;
&lt;/ns0:netcdf&gt;
</pre></div>
</div>
</dd>
</dl>
</div>
<div class="section" id="b-generate-the-namelist-bdy-file-for-pynemo-nrct">
<h3>6b. Generate the namelist.bdy file for PyNEMO / NRCT<a class="headerlink" href="#b-generate-the-namelist-bdy-file-for-pynemo-nrct" title="Permalink to this headline">¶</a></h3>
<p>Copy the NRCT template namelist.bdy from the START_FILES:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cd $INPUTS
cp $START_FILES/namelist.bdy $INPUTS/.
</pre></div>
</div>
<p>Edit namelist.bdy to for the configuration name and <code class="docutils literal"><span class="pre">ncml</span></code> file name. Also edit
the time variables corresponding to the input variables in <code class="docutils literal"><span class="pre">inputs_src.ncml</span></code>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>vi namelist.bdy
...
  sn_src_dir = &#39;./inputs_src.ncml&#39;       ! src_files/&#39;
  sn_dst_dir = &#39;/work/n01/n01/jelt/LBay180/INPUTS/&#39;
  sn_fn      = &#39;LBay180&#39;                 ! prefix for output files
...
!-----------------------------------------------------------------------
!  Time information
!-----------------------------------------------------------------------
    nn_year_000     = 2013        !  year start
    nn_year_end     = 2013        !  year end
    nn_month_000    = 09          !  month start (default = 1 is years&gt;1)
    nn_month_end    = 09          !  month end (default = 12 is years&gt;1)
    sn_dst_calendar = &#39;gregorian&#39; !  output calendar format
    nn_base_year    = 1950        !  base year for time counter
    sn_tide_grid    = &#39;/work/jelt/tpxo7.2/grid_tpxo7.2.nc&#39;
</pre></div>
</div>
<p>Turn off as many things as possible to help it along.
Turned off <code class="docutils literal"><span class="pre">ln_mask_file</span></code>. James said it was for outputting a new mask file
but it might have given me trouble. <em>Actually I also turn off all the ORCA inputs</em>.</p>
<dl class="docutils">
<dt>Point to the correct source and destination mesh and mask files/variables.</dt>
<dd><div class="first last highlight-default"><div class="highlight"><pre><span></span>vi namelist.bdy

!!&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
!! NEMO/OPA  : namelist for BDY generation tool
!!
!!             User inputs for generating open boundary conditions
!!             employed by the BDY module in NEMO. Boundary data
!!             can be set up for v3.2 NEMO and above.
!!
!!             More info here.....
!!
!!&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;

!-----------------------------------------------------------------------
!   vertical coordinate
!-----------------------------------------------------------------------
   ln_zco      = .false.   !  z-coordinate - full    steps   (T/F)
   ln_zps      = .true.    !  z-coordinate - partial steps   (T/F)
   ln_sco      = .false.   !  s- or hybrid z-s-coordinate    (T/F)
   rn_hmin     =   -10     !  min depth of the ocean (&gt;0) or
                           !  min number of ocean level (&lt;0)

!-----------------------------------------------------------------------
!   s-coordinate or hybrid z-s-coordinate
!-----------------------------------------------------------------------
   rn_sbot_min =   10.     !  minimum depth of s-bottom surface (&gt;0) (m)
   rn_sbot_max = 7000.     !  maximum depth of s-bottom surface
                           !  (= ocean depth) (&gt;0) (m)
   ln_s_sigma  = .true.   !  hybrid s-sigma coordinates
   rn_hc       =  50.0    !  critical depth with s-sigma

!-----------------------------------------------------------------------
!  grid information
!-----------------------------------------------------------------------
   sn_src_hgr = &#39;./mesh_hgr_src.nc&#39;   !  parent /grid/
   sn_src_zgr = &#39;./mesh_zgr_src.nc&#39;   !  parent
   sn_dst_hgr = &#39;./domain_cfg.nc&#39;
   sn_dst_zgr = &#39;./inputs_dst.ncml&#39; ! rename output variables
   sn_src_msk = &#39;./mask_src.nc&#39;       ! parent
   sn_bathy   = &#39;./bathy_meter.nc&#39;

!-----------------------------------------------------------------------
!  I/O
!-----------------------------------------------------------------------
   sn_src_dir = &#39;./inputs_src.ncml&#39;       ! src_files/&#39;
   sn_dst_dir = &#39;/work/jelt/NEMO/LBay180/INPUTS/&#39;
   sn_fn      = &#39;LBay180&#39;                 ! prefix for output files
   nn_fv      = -1e20                     !  set fill value for output files
   nn_src_time_adj = 0                                    ! src time adjustment
   sn_dst_metainfo = &#39;metadata info: jelt&#39;

!-----------------------------------------------------------------------
!  unstructured open boundaries
!-----------------------------------------------------------------------
    ln_coords_file = .true.               !  =T : produce bdy coordinates files
    cn_coords_file = &#39;coordinates.bdy.nc&#39; !  name of bdy coordinates files (if ln_coords_file=.TRUE.)
    ln_mask_file   = .false.              !  =T : read mask from file
    cn_mask_file   = &#39;./bdy_mask.nc&#39;                   !  name of mask file (if ln_mask_file=.TRUE.)
    ln_dyn2d       = .false.               !  boundary conditions for barotropic fields
    ln_dyn3d       = .false.               !  boundary conditions for baroclinic velocities
    ln_tra         = .false.               !  boundary conditions for T and S
    ln_ice         = .false.               !  ice boundary condition
    nn_rimwidth    = 9                    !  width of the relaxation zone

!-----------------------------------------------------------------------
!  unstructured open boundaries tidal parameters
!-----------------------------------------------------------------------
    ln_tide        = .true.               !  =T : produce bdy tidal conditions
    clname(1)      = &#39;M2&#39;                 ! constituent name
    clname(2)      = &#39;S2&#39;
    clname(3)      = &#39;K2&#39;
    ln_trans       = .false.
    sn_tide_h     = &#39;/work/jelt/tpxo7.2/h_tpxo7.2.nc&#39;
    sn_tide_u     = &#39;/work/jelt/tpxo7.2/u_tpxo7.2.nc&#39;

!-----------------------------------------------------------------------
!  Time information
!-----------------------------------------------------------------------
    nn_year_000     = 2013        !  year start
    nn_year_end     = 2013        !  year end
    nn_month_000    = 09          !  month start (default = 1 is years&gt;1)
    nn_month_end    = 09          !  month end (default = 12 is years&gt;1)
    sn_dst_calendar = &#39;gregorian&#39; !  output calendar format
    nn_base_year    = 1950        !  base year for time counter
    sn_tide_grid    = &#39;/work/jelt/tpxo7.2/grid_tpxo7.2.nc&#39;

!-----------------------------------------------------------------------
!  Additional parameters
!-----------------------------------------------------------------------
    nn_wei  = 1                   !  smoothing filter weights
    rn_r0   = 0.041666666         !  decorrelation distance use in gauss
                                  !  smoothing onto dst points. Need to
                                  !  make this a funct. of dlon
    sn_history  = &#39;bdy files produced by jelt from ORCA0083-N01&#39;
                                  !  history for netcdf file
    ln_nemo3p4  = .true.          !  else presume v3.2 or v3.3
    nn_alpha    = 0               !  Euler rotation angle
    nn_beta     = 0               !  Euler rotation angle
    nn_gamma    = 0               !  Euler rotation angle
    rn_mask_max_depth = 300.0     !  Maximum depth to be ignored for the mask
    rn_mask_shelfbreak_dist = 60    !  Distance from the shelf break
</pre></div>
</div>
</dd>
</dl>
<p>Also had to check/create <code class="docutils literal"><span class="pre">inputs_dst.ncml</span></code>, that it has the correct file name within:
<em>Now domain_cfg.nc, formerly mesh_zgr.nc</em>. Note also that some variables in</p>
<blockquote>
<div><p>domain_cfg.nc have different names e.g. <code class="docutils literal"><span class="pre">mbathy</span></code> &#8211;&gt; <code class="docutils literal"><span class="pre">bottom_level</span></code>. Check the mapping
in <code class="docutils literal"><span class="pre">inputs_dst.ncml</span></code>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">vi</span> <span class="n">inputs_dst</span><span class="o">.</span><span class="n">ncml</span>

<span class="o">&lt;</span><span class="n">ns0</span><span class="p">:</span><span class="n">netcdf</span> <span class="n">xmlns</span><span class="p">:</span><span class="n">ns0</span><span class="o">=</span><span class="s2">&quot;http://www.unidata.ucar.edu/namespaces/netcdf/ncml-2.2&quot;</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;NEMO aggregation&quot;</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">ns0</span><span class="p">:</span><span class="n">aggregation</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;union&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">ns0</span><span class="p">:</span><span class="n">netcdf</span> <span class="n">location</span><span class="o">=</span><span class="s2">&quot;file:domain_cfg.nc&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">ns0</span><span class="p">:</span><span class="n">variable</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;mbathy&quot;</span> <span class="n">orgName</span><span class="o">=</span><span class="s2">&quot;top_level&quot;</span> <span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="n">ns0</span><span class="p">:</span><span class="n">variable</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;gdept&quot;</span> <span class="n">orgName</span><span class="o">=</span><span class="s2">&quot;gdept_0&quot;</span> <span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="n">ns0</span><span class="p">:</span><span class="n">variable</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;gdepw&quot;</span> <span class="n">orgName</span><span class="o">=</span><span class="s2">&quot;gdepw_0&quot;</span> <span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="n">ns0</span><span class="p">:</span><span class="n">variable</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;e3u&quot;</span> <span class="n">orgName</span><span class="o">=</span><span class="s2">&quot;e3u_0&quot;</span> <span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="n">ns0</span><span class="p">:</span><span class="n">variable</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;e3v&quot;</span> <span class="n">orgName</span><span class="o">=</span><span class="s2">&quot;e3v_0&quot;</span> <span class="o">/&gt;</span>
    <span class="o">&lt;/</span><span class="n">ns0</span><span class="p">:</span><span class="n">netcdf</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">ns0</span><span class="p">:</span><span class="n">aggregation</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">ns0</span><span class="p">:</span><span class="n">netcdf</span><span class="o">&gt;</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="run-pynemo-nrct-to-generate-boundary-conditions">
<h3>Run PyNEMO / NRCT to generate boundary conditions<a class="headerlink" href="#run-pynemo-nrct-to-generate-boundary-conditions" title="Permalink to this headline">¶</a></h3>
<p>First install PyNEMO <a href="#id13"><span class="problematic" id="id14">`install_nrct`_</span></a> if not already done so.</p>
<p>Generate the boundary conditions with PyNEMO</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>module load anaconda/2.1.0  # Want python2
source activate nrct_env
cd $INPUTS
export LD_LIBRARY_PATH=/usr/lib/jvm/jre-1.7.0-openjdk.x86_64/lib/amd64/server:$LD_LIBRARY_PATH

pynemo -s namelist.bdy
</pre></div>
</div>
<dl class="docutils">
<dt>This generates::</dt>
<dd><dl class="first last docutils">
<dt>ls -1 $INPUTS</dt>
<dd>...</dd>
</dl>
</dd>
</dl>
<p>&#8212;</p>
<p>Some thing funny going on with the bathymetry and domain_cfg.nc files:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">module</span> <span class="n">load</span> <span class="n">nco</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="mf">4.4</span><span class="o">.</span><span class="mf">2.</span><span class="n">ncwa</span>
<span class="n">ncks</span> <span class="o">-</span><span class="n">v</span> <span class="n">top_level</span> <span class="n">domain_cfg</span><span class="o">.</span><span class="n">nc</span> <span class="n">tmp</span><span class="o">.</span><span class="n">nc</span>
<span class="n">ncrename</span> <span class="o">-</span><span class="n">h</span> <span class="o">-</span><span class="n">v</span> <span class="n">top_level</span><span class="p">,</span><span class="n">mask</span> <span class="n">tmp</span><span class="o">.</span><span class="n">nc</span> <span class="n">bdy_mask</span><span class="o">.</span><span class="n">nc</span>
<span class="n">rm</span> <span class="n">tmp</span><span class="o">.</span><span class="n">nc</span>

<span class="n">ferret</span>
<span class="n">top_level</span>
<span class="n">bottom_level</span>
<span class="n">e3t_0</span><span class="p">[</span><span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">]</span>

<span class="n">are</span> <span class="nb">all</span> <span class="n">odd</span><span class="o">.</span>
</pre></div>
</div>
<p>Things are less odd if I carefully create the domain_cfg.nc files using SIREN tools
Though there does not appear to be any land masking in the spacing variables but
there is in the top_levels and bottom_levels variables.</p>
</div>
<hr class="docutils" />
<div class="section" id="id3">
<h3>6. Generate boundary conditions with NRCT/PyNEMO: Create netcdf abstraction wrapper<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>In this section there are two stages.
* generate a ncml file which describes the files needed to create boundary conditions
* generate a namelist.bdy file which controls the actual boundary condition generation.</p>
<p>For each parent data set a new pair of (<code class="docutils literal"><span class="pre">*.ncml</span></code>, <code class="docutils literal"><span class="pre">namelist.bdy</span></code>) are needed.
Here I attempt to use parent data from NNA. I could use data from:
* AMM60 local data (might not yet work because of the sigma levels)
* thredds server (as in the LH_REEF example, though this is turned off!)
* NNA local data (easiest ?)</p>
<p>First install PyNEMO if not already done so. Full description (If this is already
installed then follow through anyway but skip the mkdir / create / install / clone</p>
<blockquote>
<div><p>and build commands):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>ssh -Y livljobs4

export CONFIG=LBay180
export WORK=/work
export WDIR=$WORK/$USER/NEMO/$CONFIG
export INPUTS=$WDIR/INPUTS
export START_FILES=$WDIR/START_FILES
#export CDIR=$WDIR/trunk_NEMOGCM_r8395/CONFIG
#export TDIR=$WDIR/trunk_NEMOGCM_r8395/TOOLS
#export EXP=$CDIR/$CONFIG/EXP00

cd $WORK/$USER
mkdir $WDIR
module load anaconda/2.1.0  # Want python2
conda create --name nrct_env scipy=0.16.0 numpy matplotlib=1.5.1 basemap netcdf4 libgfortran=1.0.0
source activate nrct_env
conda install -c https://conda.anaconda.org/conda-forge seawater=3.3.4 # Note had to add https path
conda install -c https://conda.anaconda.org/srikanthnagella thredds_crawler
conda install -c https://conda.anaconda.org/srikanthnagella pyjnius
</pre></div>
</div>
</div></blockquote>
<p>Find java object by doing a which java and then following the trail
find  /usr/lib/jvm/jre-1.7.0-openjdk.x86_64/ -name libjvm.so -print</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>export LD_LIBRARY_PATH=/usr/lib/jvm/jre-1.7.0-openjdk.x86_64/lib/amd64/server:$LD_LIBRARY_PATH
unset SSH_ASKPASS # Didn&#39;t need this on ARCHER...
git clone https://jpolton@bitbucket.org/jdha/nrct.git nrct  # Give jpolton@bitbucket passwd
cd nrct/Python
python setup.py build
export PYTHONPATH=/login/$USER/.conda/envs/nrct_env/lib/python2.7/site-packages/:$PYTHONPATH
python setup.py install --prefix ~/.conda/envs/nrct_env
cd $INPUTS
</pre></div>
</div>
<dl class="docutils">
<dt>I suggest managing the namelist.bdy file after the <code class="docutils literal"><span class="pre">ncml</span></code> file is generated.</dt>
<dd>A fresh <code class="docutils literal"><span class="pre">ncml</span></code> file can be generated automatically or an existing one can be edited.</dd>
</dl>
</div>
<div class="section" id="a-generate-ncml-files">
<h3>6a. Generate ncml files<a class="headerlink" href="#a-generate-ncml-files" title="Permalink to this headline">¶</a></h3>
<p>Activate generator:</p>
<p>Start up pynemo and generate boundary conditions. First we need to create a
few ncml files to gather input data and map variable names. Then using pynemo
we define the area we want to model.
Redefine <code class="docutils literal"><span class="pre">WDIR</span></code>. Launch from WDIR:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>ssh -Y espp1
module load anaconda
source activate pynemo_env
#  export LD_LIBRARY_PATH=/opt/java/jdk1.7.0_45/jre/lib/amd64/server:$LD_LIBRARY_PATH
#  export PYTHONPATH=/home/n01/n01/jelt/.conda/envs/pynemo_env/lib/python2.7/site-packages/:$PYTHONPATH
cd $WDIR/INPUTS
pynemo_ncml_generator
</pre></div>
</div>
<p>Here the object is to generate a ncml file that is read in by PyNEMO as the <code class="docutils literal"><span class="pre">sn_src_dir</span></code>
(in the <code class="docutils literal"><span class="pre">namelist.bdy</span></code> file)</p>
<p>Fill in the Tracer and Dynamics for T,S,U,V,Z tabs: using T,T &amp; U,V,T in the reg
expressions e.g. .*T.nc$
To generate a e.g. <code class="docutils literal"><span class="pre">inputs_src.ncml</span></code> file click  <strong>generate</strong>. Defining the
filename seems to work better with the file selector rather than direct typing.</p>
<p>In <code class="docutils literal"><span class="pre">$INPUTS</span></code> I have three ncml files.
* One for using the thredds server to get remote ORCA12 data.
* One for using local AMM60 data, with ackward s-sigma levels
* One for using local NNA data</p>
<p>The first two are work in progress / templates. The latter is used here.</p>
</div>
<div class="section" id="nna-inputs-src-ncml">
<h3>NNA_inputs_src.ncml<a class="headerlink" href="#nna-inputs-src-ncml" title="Permalink to this headline">¶</a></h3>
<p>Note need to set the time variables and new <code class="docutils literal"><span class="pre">sn_src_dir</span></code> in namelist.bdy.
Actually upated the following with all the Jan 2000 files:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cd $INPUTS
vi NNA_inputs_src.ncml

&lt;ns0:netcdf xmlns:ns0=&quot;http://www.unidata.ucar.edu/namespaces/netcdf/ncml-2.2&quot; title=&quot;NEMO aggregation&quot;&gt;
  &lt;ns0:aggregation type=&quot;union&quot;&gt;
    &lt;ns0:netcdf&gt;
      &lt;ns0:aggregation dimName=&quot;time_counter&quot; name=&quot;votemper&quot; type=&quot;joinExisting&quot;&gt;
        &lt;ns0:scan location=&quot;file://work/n01/n01/jdha/LBay/INPUTS/NNA&quot; regExp=&quot;.*T\.nc$&quot; /&gt;
      &lt;/ns0:aggregation&gt;
    &lt;/ns0:netcdf&gt;
    &lt;ns0:netcdf&gt;
      &lt;ns0:aggregation dimName=&quot;time_counter&quot; name=&quot;vosaline&quot; type=&quot;joinExisting&quot;&gt;
        &lt;ns0:scan location=&quot;file://work/n01/n01/jdha/LBay/INPUTS/NNA&quot; regExp=&quot;.*T\.nc$&quot; /&gt;
      &lt;/ns0:aggregation&gt;
    &lt;/ns0:netcdf&gt;
    &lt;ns0:netcdf&gt;
      &lt;ns0:aggregation dimName=&quot;time_counter&quot; name=&quot;vozocrtx&quot; type=&quot;joinExisting&quot;&gt;
        &lt;ns0:scan location=&quot;file://work/n01/n01/jdha/LBay/INPUTS/NNA&quot; regExp=&quot;.*U\.nc$&quot; /&gt;
      &lt;/ns0:aggregation&gt;
    &lt;/ns0:netcdf&gt;
    &lt;ns0:netcdf&gt;
      &lt;ns0:aggregation dimName=&quot;time_counter&quot; name=&quot;vomecrty&quot; type=&quot;joinExisting&quot;&gt;
        &lt;ns0:scan location=&quot;file://work/n01/n01/jdha/LBay/INPUTS/NNA&quot; regExp=&quot;.*V\.nc$&quot; /&gt;
      &lt;/ns0:aggregation&gt;
    &lt;/ns0:netcdf&gt;
    &lt;ns0:netcdf&gt;
      &lt;ns0:aggregation dimName=&quot;time_counter&quot; name=&quot;sossheig&quot; type=&quot;joinExisting&quot;&gt;
        &lt;ns0:scan location=&quot;file://work/n01/n01/jdha/LBay/INPUTS/NNA&quot; regExp=&quot;.*T\.nc$&quot; /&gt;
      &lt;/ns0:aggregation&gt;
    &lt;/ns0:netcdf&gt;
  &lt;/ns0:aggregation&gt;
&lt;/ns0:netcdf&gt;
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h3>6b. Generate the namelist.bdy file for PyNEMO / NRCT<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>Copy the NRCT template namelist.bdy from the START_FILES.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cd $INPUTS
cp $START_FILES/namelist.bdy $INPUTS/.
</pre></div>
</div>
<p>Edit namelist.bdy to for the configuration name and <code class="docutils literal"><span class="pre">ncml</span></code> file name. <strong>Note
need the slash following OUTPUT</strong>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>vi namelist.bdy
sn_src_dir = &#39;./inputs_src.ncml&#39;       ! src_files/&#39;
sn_dst_dir = &#39;/work/n01/n01/jelt/LBay/OUTPUT/&#39;
sn_fn      = &#39;LBay&#39;                 ! prefix for output files
...
cn_mask_file   = &#39;./mask.nc&#39;                   !  name of mask file (if ln_mask_file=.TRUE.)
</pre></div>
</div>
<dl class="docutils">
<dt>Now edit the pynemo namelist file. Add location of grid information. Note had to</dt>
<dd><p class="first">hunt for a mesh.nc file. Incase this doesn&#8217;t work, there were a couple of
options. (Tried both) Note also that mesh_zgr includes gdept_0, gdepw_0, e3t_0, e3u_0,
e3v_0, e3w_0, so use ncml to convert to variables without <a href="#id5"><span class="problematic" id="id6">*</span></a>_0. (Also didn&#8217;t convert e3w_0).</p>
<p class="last">Make sure the timestamps correspond to the input data.</p>
</dd>
</dl>
<p>Turn off as many things as possible to help it along.
Turned off <code class="docutils literal"><span class="pre">ln_mask_file</span></code>. James said it was for outputting a new mask file
but it might have given me trouble.</p>
<p>I have a namelist.bdy file for each ncml configuration
* namelist.bdy_AMM60
* namelist.bdy_thredds (uses global 1/12 degree data)
* namelist.bdy_NNA</p>
</div>
<div class="section" id="generate-boundary-conditions-with-pynemo-run-pynemo">
<h3>7. Generate boundary conditions with PyNEMO: Run PyNEMO<a class="headerlink" href="#generate-boundary-conditions-with-pynemo-run-pynemo" title="Permalink to this headline">¶</a></h3>
<p>Using livljobs4</p>
<p><em>(20/21 Sept 2017)</em></p>
<p><strong>Start the process again on livljobs4: LBay_livljobs4.rst</strong></p>
<dl class="docutils">
<dt>Need to grab some INPUT files. (File bathy_meter.nc and domain_cfg.nc should be</dt>
<dd><dl class="first last docutils">
<dt>there already). Might need to check that START_FILES is properly populated, or</dt>
<dd><p class="first">copy from <em>LBay</em> version:</p>
<p class="last">cp $START_FILES/namelist.bdy_NNA    $INPUTS/.
cp $START_FILES/NNA_inputs_src.ncml $INPUTS/.
cp $START_FILES/inputs_dst.ncml     $INPUTS/.
cd $INPUTS</p>
</dd>
</dl>
</dd>
</dl>
<p>Get the domain_cfg.nc and bathy_meter.nc if they are not there:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">scp</span> <span class="n">jelt</span><span class="nd">@login</span><span class="o">.</span><span class="n">archer</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">uk</span><span class="p">:</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">jelt</span><span class="o">/</span><span class="n">LBay180</span><span class="o">/</span><span class="n">trunk_NEMOGCM_r8395</span><span class="o">/</span><span class="n">CONFIG</span><span class="o">/</span><span class="n">LBay180</span><span class="o">/</span><span class="n">EXP00</span><span class="o">/</span><span class="n">coordinates</span><span class="o">.</span><span class="n">nc</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">nc</span>
<span class="n">scp</span> <span class="n">jelt</span><span class="nd">@login</span><span class="o">.</span><span class="n">archer</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">uk</span><span class="p">:</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">jelt</span><span class="o">/</span><span class="n">LBay180</span><span class="o">/</span><span class="n">trunk_NEMOGCM_r8395</span><span class="o">/</span><span class="n">CONFIG</span><span class="o">/</span><span class="n">LBay180</span><span class="o">/</span><span class="n">EXP00</span><span class="o">/</span><span class="n">bathy_meter</span><span class="o">.</span><span class="n">nc</span> <span class="n">bathy_meter</span><span class="o">.</span><span class="n">nc</span>
<span class="n">scp</span> <span class="n">jelt</span><span class="nd">@login</span><span class="o">.</span><span class="n">archer</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">uk</span><span class="p">:</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">jelt</span><span class="o">/</span><span class="n">LBay180</span><span class="o">/</span><span class="n">trunk_NEMOGCM_r8395</span><span class="o">/</span><span class="n">CONFIG</span><span class="o">/</span><span class="n">LBay180</span><span class="o">/</span><span class="n">EXP00</span><span class="o">/</span><span class="n">domain_cfg</span><span class="o">.</span><span class="n">nc</span>  <span class="n">domain_cfg</span><span class="o">.</span><span class="n">nc</span>
</pre></div>
</div>
<p>Get the initial T,S fields if they are not there:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>scp jelt@login.archer.ac.uk:/work/n01/n01/jelt/LBay180/INPUTS/initcd_vosaline.nc $INPUTS/.
scp jelt@login.archer.ac.uk:/work/n01/n01/jelt/LBay180/INPUTS/initcd_votemper.nc $INPUTS/.
</pre></div>
</div>
<p>Make sure the NNA data is available:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>mkdir $WDIR/INPUTS/NNA
scp jelt@login.archer.ac.uk:/work/n01/n01/jdha/LBay/INPUTS/NNA/mesh_hgr.nc $WDIR/INPUTS/NNA/.
scp jelt@login.archer.ac.uk:/work/n01/n01/jdha/LBay/INPUTS/NNA/mesh_hgr.nc $WDIR/INPUTS/NNA/.
scp jelt@login.archer.ac.uk:/work/n01/n01/jdha/LBay/INPUTS/NNA/mask.nc $WDIR/INPUTS/NNA/.
for file in NNA_*200001*nc ; do scp jelt@login.archer.ac.uk:/work/n01/n01/jdha/LBay/INPUTS/NNA/$file $WDIR/INPUTS/NNA/. ; done
</pre></div>
</div>
<p>Or link from existing location:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>ln -s /work/jelt/NEMO/LBay/INPUTS/NNA $INPUTS/NNA
</pre></div>
</div>
</div>
<div class="section" id="namelist-bdy-nna">
<h3>namelist.bdy_NNA<a class="headerlink" href="#namelist-bdy-nna" title="Permalink to this headline">¶</a></h3>
<p>Edit namelist.bdy_NNA to reflect locally stored mesh and mask files. Also
inputs_dst.ncml. Set the date info back to (Nov?) 1979. Here it is tides only. No T,S.</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span>vi namelist.bdy_NNA

!!&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
!! NEMO/OPA  : namelist for BDY generation tool
!!
!!             User inputs for generating open boundary conditions
!!             employed by the BDY module in NEMO. Boundary data
!!             can be set up for v3.2 NEMO and above.
!!
!!             More info here.....
!!
!!&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;

!-----------------------------------------------------------------------
!   vertical coordinate
!-----------------------------------------------------------------------
   ln_zco      = .false.   !  z-coordinate - full    steps   (T/F)
   ln_zps      = .true.    !  z-coordinate - partial steps   (T/F)
   ln_sco      = .false.   !  s- or hybrid z-s-coordinate    (T/F)
   rn_hmin     =   -10     !  min depth of the ocean (&gt;0) or
                           !  min number of ocean level (&lt;0)

!-----------------------------------------------------------------------
!   s-coordinate or hybrid z-s-coordinate
!-----------------------------------------------------------------------
   rn_sbot_min =   10.     !  minimum depth of s-bottom surface (&gt;0) (m)
   rn_sbot_max = 7000.     !  maximum depth of s-bottom surface
                           !  (= ocean depth) (&gt;0) (m)
   ln_s_sigma  = .true.   !  hybrid s-sigma coordinates
   rn_hc       =  150.0    !  critical depth with s-sigma

!-----------------------------------------------------------------------
!  grid information
!-----------------------------------------------------------------------
   sn_src_hgr = &#39;/work/jelt/NEMO/LBay180/INPUTS/NNA/mesh_hgr.nc&#39;   !  /grid/
   sn_src_zgr = &#39;/work/jelt/NEMO/LBay180/INPUTS/NNA/mesh_zgr.nc&#39;
   sn_dst_hgr = &#39;./domain_cfg.nc&#39;
   sn_dst_zgr = &#39;./inputs_dst.ncml&#39; ! rename output variables
   sn_src_msk = &#39;/work/jelt/NEMO/LBay180/INPUTS/NNA/mask.nc&#39;
   sn_bathy   = &#39;./bathy_meter.nc&#39;

!-----------------------------------------------------------------------
!  I/O
!-----------------------------------------------------------------------
   sn_src_dir = &#39;./NNA_inputs_src.ncml&#39;       ! src_files/&#39;
   sn_dst_dir = &#39;/work/jelt/NEMO/LBay180/INPUTS/&#39;
   sn_fn      = &#39;LBay&#39;                 ! prefix for output files
   nn_fv      = -1e20                     !  set fill value for output files
   nn_src_time_adj = 0                                    ! src time adjustment
   sn_dst_metainfo = &#39;metadata info: jelt&#39;

!-----------------------------------------------------------------------
!  unstructured open boundaries
!-----------------------------------------------------------------------
    ln_coords_file = .true.               !  =T : produce bdy coordinates files
    cn_coords_file = &#39;coordinates.bdy.nc&#39; !  name of bdy coordinates files (if ln_coords_file=.TRUE.)
    ln_mask_file   = .false.              !  =T : read mask from file
    cn_mask_file   = &#39;./mask.nc&#39;                   !  name of mask file (if ln_mask_file=.TRUE.)
    ln_dyn2d       = .true.               !  boundary conditions for barotropic fields
    ln_dyn3d       = .false.               !  boundary conditions for baroclinic velocities
    ln_tra         = .true.               !  boundary conditions for T and S
    ln_ice         = .false.               !  ice boundary condition
    nn_rimwidth    = 9                    !  width of the relaxation zone

!-----------------------------------------------------------------------
!  unstructured open boundaries tidal parameters
!-----------------------------------------------------------------------
    ln_tide        = .true.               !  =T : produce bdy tidal conditions
    clname(1)      = &#39;M2&#39;                  ! constituent name
    clname(2)      = &#39;S2&#39;
    clname(3)      = &#39;N2&#39;
    clname(4)      = &#39;K2&#39;
    clname(5)      = &#39;K1&#39;
    clname(6)      = &#39;O1&#39;
    clname(7)      = &#39;P1&#39;
    clname(8)      = &#39;Q1&#39;
    clname(9)      = &#39;MF&#39;
    clname(10)     = &#39;MM&#39;
    clname(11)     = &#39;M4&#39;
    clname(12)     = &#39;MS4&#39;
    clname(13)     = &#39;MN4&#39;
    ln_trans       = .false.
    sn_tide_h     = &#39;/work/jelt/tpxo7.2/h_tpxo7.2.nc&#39;
    sn_tide_u     = &#39;/work/jelt/tpxo7.2/u_tpxo7.2.nc&#39;


!-----------------------------------------------------------------------
!  Time information
!-----------------------------------------------------------------------
    nn_year_000     = 2000        !  year start
    nn_year_end     = 2000        !  year end
    nn_month_000    = 01          !  month start (default = 1 is years&gt;1)
    nn_month_end    = 01          !  month end (default = 12 is years&gt;1)
    sn_dst_calendar = &#39;gregorian&#39; !  output calendar format
    nn_base_year    = 1979        !  base year for time counter
    sn_tide_grid    = &#39;/work/jelt/tpxo7.2/grid_tpxo7.2.nc&#39;

!-----------------------------------------------------------------------
!  Additional parameters
!-----------------------------------------------------------------------
    nn_wei  = 1                   !  smoothing filter weights
    rn_r0   = 0.041666666         !  decorrelation distance use in gauss
                                  !  smoothing onto dst points. Need to
                                  !  make this a funct. of dlon
    sn_history  = &#39;bdy files produced by jelt from AMM60 for testing&#39;
                                  !  history for netcdf file
    ln_nemo3p4  = .true.          !  else presume v3.2 or v3.3
    nn_alpha    = 0               !  Euler rotation angle
    nn_beta     = 0               !  Euler rotation angle
    nn_gamma    = 0               !  Euler rotation angle
    rn_mask_max_depth = 300.0     !  Maximum depth to be ignored for the mask
    rn_mask_shelfbreak_dist = 60    !  Distance from the shelf break
</pre></div>
</div>
</div></blockquote>
<dl class="docutils">
<dt>Also had to check that <code class="docutils literal"><span class="pre">inputs_dst.ncml</span></code> has the correct file name within:</dt>
<dd><dl class="first last docutils">
<dt><em>Now domain_cfg.nc, formerly mesh_zgr.nc</em>. Note also that some variables in</dt>
<dd><p class="first">domain_cfg.nc have different names e.g. <code class="docutils literal"><span class="pre">mbathy</span></code> &#8211;&gt; <code class="docutils literal"><span class="pre">bottom_level</span></code>. Check the mapping
in <code class="docutils literal"><span class="pre">inputs_dst.ncml</span></code>:</p>
<div class="last highlight-default"><div class="highlight"><pre><span></span><span class="n">vi</span> <span class="n">inputs_dst</span><span class="o">.</span><span class="n">ncml</span>

<span class="o">&lt;</span><span class="n">ns0</span><span class="p">:</span><span class="n">netcdf</span> <span class="n">xmlns</span><span class="p">:</span><span class="n">ns0</span><span class="o">=</span><span class="s2">&quot;http://www.unidata.ucar.edu/namespaces/netcdf/ncml-2.2&quot;</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;NEMO aggregation&quot;</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">ns0</span><span class="p">:</span><span class="n">aggregation</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;union&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">ns0</span><span class="p">:</span><span class="n">netcdf</span> <span class="n">location</span><span class="o">=</span><span class="s2">&quot;file:domain_cfg.nc&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">ns0</span><span class="p">:</span><span class="n">variable</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;mbathy&quot;</span> <span class="n">orgName</span><span class="o">=</span><span class="s2">&quot;bottom_level&quot;</span> <span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="n">ns0</span><span class="p">:</span><span class="n">variable</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;gdept&quot;</span> <span class="n">orgName</span><span class="o">=</span><span class="s2">&quot;gdept_0&quot;</span> <span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="n">ns0</span><span class="p">:</span><span class="n">variable</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;gdepw&quot;</span> <span class="n">orgName</span><span class="o">=</span><span class="s2">&quot;gdepw_0&quot;</span> <span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="n">ns0</span><span class="p">:</span><span class="n">variable</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;e3u&quot;</span> <span class="n">orgName</span><span class="o">=</span><span class="s2">&quot;e3u_0&quot;</span> <span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="n">ns0</span><span class="p">:</span><span class="n">variable</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;e3v&quot;</span> <span class="n">orgName</span><span class="o">=</span><span class="s2">&quot;e3v_0&quot;</span> <span class="o">/&gt;</span>
    <span class="o">&lt;/</span><span class="n">ns0</span><span class="p">:</span><span class="n">netcdf</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">ns0</span><span class="p">:</span><span class="n">aggregation</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">ns0</span><span class="p">:</span><span class="n">netcdf</span><span class="o">&gt;</span>
</pre></div>
</div>
</dd>
</dl>
</dd>
</dl>
<p>Generate the boundary conditions again, with PyNEMO</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>module load anaconda/2.1.0  # Want python2
source activate nrct_env
cd $INPUTS
export LD_LIBRARY_PATH=/usr/lib/jvm/jre-1.7.0-openjdk.x86_64/lib/amd64/server:$LD_LIBRARY_PATH

pynemo -s namelist.bdy_NNA
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>pynemo -s namelist.bdy_NNA
Didn&#39;t find a proxy environment variable
INFO:pynemo.profile:START
INFO:pynemo.profile:0.0
INFO:pynemo.profile:0.0
INFO:pynemo.profile:ice = False
INFO:pynemo.profile:Done Setup
WARNING:pynemo.profile:Using default mask with bathymetry!!!!
INFO:pynemo.profile:0.02
INFO:pynemo.profile:Done Mask
INFO:pynemo.profile:start bdy_t
Traceback (most recent call last):
  File &quot;/login/jelt/.conda/envs/nrct_env/bin/pynemo&quot;, line 11, in &lt;module&gt;
    load_entry_point(&#39;pynemo==0.2&#39;, &#39;console_scripts&#39;, &#39;pynemo&#39;)()
  File &quot;/login/jelt/.conda/envs/nrct_env/lib/python2.7/site-packages/pynemo-0.2-py2.7.egg/pynemo/pynemo_exe.py&quot;, line 44, in main
    profile.process_bdy(setup_file, mask_gui)
  File &quot;/login/jelt/.conda/envs/nrct_env/lib/python2.7/site-packages/pynemo-0.2-py2.7.egg/pynemo/profile.py&quot;, line 100, in process_bdy
    grid_t = gen_grid.Boundary(bdy_msk, settings, &#39;t&#39;)
  File &quot;/login/jelt/.conda/envs/nrct_env/lib/python2.7/site-packages/pynemo-0.2-py2.7.egg/pynemo/nemo_bdy_gen_c.py&quot;, line 109, in __init__
    bdy_i, bdy_r = self._remove_duplicate_points(bdy_i, bdy_r)
  File &quot;/login/jelt/.conda/envs/nrct_env/lib/python2.7/site-packages/pynemo-0.2-py2.7.egg/pynemo/nemo_bdy_gen_c.py&quot;, line 161, in _remove_duplicate_points
    uniqind = self._unique_rows(bdy_i2)
  File &quot;/login/jelt/.conda/envs/nrct_env/lib/python2.7/site-packages/pynemo-0.2-py2.7.egg/pynemo/nemo_bdy_gen_c.py&quot;, line 214, in _unique_rows
    indx = zip(*sorted([(val, i) for i,val in enumerate(tlist)]))[1]
IndexError: list index out of range
</pre></div>
</div>
<p><strong>GOT THIS FAR</strong>
I think that perhaps the TPXO data is too course to be resolved in this small domain..</p>
<dl class="docutils">
<dt>This generates::</dt>
<dd><p class="first">ls -1 $INPUTS</p>
<p class="last">coordinates.bdy.nc
LBay_bdytide_rotT_M4_grid_T.nc
LBay_bdytide_rotT_MM_grid_T.nc
LBay_bdytide_rotT_MN4_grid_T.nc
LBay_bdytide_rotT_MS4_grid_T.nc
LBay_bdytide_rotT_M2_grid_T.nc
LBay_bdytide_rotT_N2_grid_T.nc
LBay_bdytide_rotT_S2_grid_T.nc
LBay_bdytide_rotT_K1_grid_T.nc
LBay_bdytide_rotT_K2_grid_T.nc
LBay_bdytide_rotT_P1_grid_T.nc
LBay_bdytide_rotT_O1_grid_T.nc
LBay_bdytide_rotT_MF_grid_T.nc
LBay_bdytide_rotT_Q1_grid_T.nc
LBay_bdytide_rotT_M4_grid_U.nc
LBay_bdytide_rotT_MM_grid_U.nc
LBay_bdytide_rotT_MN4_grid_U.nc
LBay_bdytide_rotT_MS4_grid_U.nc
LBay_bdytide_rotT_M2_grid_U.nc
LBay_bdytide_rotT_N2_grid_U.nc
LBay_bdytide_rotT_S2_grid_U.nc
LBay_bdytide_rotT_K1_grid_U.nc
LBay_bdytide_rotT_K2_grid_U.nc
LBay_bdytide_rotT_P1_grid_U.nc
LBay_bdytide_rotT_O1_grid_U.nc
LBay_bdytide_rotT_MF_grid_U.nc
LBay_bdytide_rotT_Q1_grid_U.nc
LBay_bdytide_rotT_M4_grid_V.nc
LBay_bdytide_rotT_MM_grid_V.nc
LBay_bdytide_rotT_MN4_grid_V.nc
LBay_bdytide_rotT_MS4_grid_V.nc
LBay_bdytide_rotT_M2_grid_V.nc
LBay_bdytide_rotT_N2_grid_V.nc
LBay_bdytide_rotT_S2_grid_V.nc
LBay_bdytide_rotT_K1_grid_V.nc
LBay_bdytide_rotT_K2_grid_V.nc
LBay_bdytide_rotT_P1_grid_V.nc
LBay_bdytide_rotT_O1_grid_V.nc
LBay_bdytide_rotT_MF_grid_V.nc
LBay_bdytide_rotT_Q1_grid_V.nc
LBay_bdyT_y2000m01.nc
LBay_bt_bdyT_y2000m01.nc
LBay_bdyU_y2000m01.nc
LBay_bdyV_y2000m01.nc</p>
</dd>
</dl>
<p>Prepare the boundary files (need to fix some variable names):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cd $INPUTS

module load nco/gcc/4.4.2.ncwa

ncrename -v depthu,gdepu LBay_bdyU_y2000m01.nc
ncrename -v depthv,gdepv LBay_bdyV_y2000m01.nc
ncrename -v deptht,gdept initcd_votemper.nc
ncrename -v deptht,gdept initcd_vosaline.nc
module unload nco
</pre></div>
</div>
<p>Copy the new files back onto ARCHER</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>livljobs4$
cd $INPUTS
for file in LBay*nc; do scp $file jelt@login.archer.ac.uk:/work/n01/n01/jelt/LBay/INPUTS/. ; done
for file in initcd_vo*nc; do scp $file jelt@login.archer.ac.uk:/work/n01/n01/jelt/LBay/INPUTS/. ; done
scp coordinates.bdy.nc jelt@login.archer.ac.uk:/work/n01/n01/jelt/LBay/INPUTS/.
</pre></div>
</div>
</div>
<div class="section" id="run-the-configuration-on-archer-turn-on-the-tides">
<h3>8. Run the configuration ON ARCHER. Turn on the tides<a class="headerlink" href="#run-the-configuration-on-archer-turn-on-the-tides" title="Permalink to this headline">¶</a></h3>
<p><em>(21 Sept 2017 / 6 Oct 17)</em></p>
<p>Open a terminal on <strong>ARCHER</strong>. Redefine PATHS. Reload modules:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>export CONFIG=LBay
export WORK=/work/n01/n01
export WDIR=$WORK/$USER/$CONFIG
export INPUTS=$WORK/$USER/$CONFIG/INPUTS
export CDIR=$WDIR/trunk_NEMOGCM_r8395/CONFIG
export TDIR=$WDIR/trunk_NEMOGCM_r8395/TOOLS
export EXP=$CDIR/$CONFIG/EXP00

module swap PrgEnv-cray PrgEnv-intel
module load cray-netcdf-hdf5parallel cray-hdf5-parallel
</pre></div>
</div>
<p>OPA and XIOS are already built.</p>
<p>Link the boundary data to the EXP direcory:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cd $EXP
ln -s $INPUTS/coordinates.bdy.nc       $EXP/coordinates.bdy.nc
ln -s $INPUTS/LBay_bdyT_y2000m01.nc    $EXP/LBay_bdyT_y2000m01.nc
ln -s $INPUTS/LBay_bdyU_y2000m01.nc    $EXP/LBay_bdyU_y2000m01.nc
ln -s $INPUTS/LBay_bdyV_y2000m01.nc    $EXP/LBay_bdyV_y2000m01.nc
ln -s $INPUTS/LBay_bt_bdyT_y2000m01.nc $EXP/LBay_bt_bdyT_y2000m01.nc
ln -s $INPUTS                          $EXP/bdydta
</pre></div>
</div>
<p>There was a problem running with the namelist_cfg fresh from DOMAINcfg. First with
with namcfg group. So I cut it back to just reading the cfg file:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>vi namelist_cfg

!-----------------------------------------------------------------------
&amp;namcfg        !   parameters of the configuration
!-----------------------------------------------------------------------
   ln_read_cfg = .true.   !  (=T) read the domain configuration file
   cn_domcfg = &quot;domain_cfg&quot;         ! domain configuration filename
</pre></div>
</div>
<p>Then there was an extra variable in namdom. Comment out ldbletanh (which was essential in DOMAINcfg):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>!-----------------------------------------------------------------------
&amp;namdom        !   space and time domain (bathymetry, mesh, timestep)
!-----------------------------------------------------------------------
...
!    ldbletanh   =    .false.             !  Use/do not use double tanf function for vertical coordinates
</pre></div>
</div>
<p>Also noted that the sbc namelist variables have changed. Now use <code class="docutils literal"><span class="pre">ln_blk</span></code> and <code class="docutils literal"><span class="pre">ln_COARE_3p5=</span> <span class="pre">.true.</span></code>
instead of <code class="docutils literal"><span class="pre">ln_blk_core</span></code></p>
<dl class="docutils">
<dt>Also need to make sure the harmonic tidal boundary files are consistent with the</dt>
<dd><p class="first">harmonics expected e.g.:</p>
<div class="last highlight-default"><div class="highlight"><pre><span></span>!-----------------------------------------------------------------------
&amp;nam_tide      !   tide parameters (#ifdef key_tide)
!-----------------------------------------------------------------------
clname(1)    = &#39;Q1&#39;   !  name of constituent - all tidal components must be set in namelist_cfg
clname(2)    = &#39;O1&#39;   !  name of constituent - all tidal components must be set in namelist_cfg
clname(3)    = &#39;P1&#39;   !  name of constituent - all tidal components must be set in namelist_cfg
clname(4)    = &#39;K1&#39;   !  name of constituent - all tidal components must be set in namelist_cfg
clname(5)    = &#39;N2&#39;   !  name of constituent - all tidal components must be set in namelist_cfg
clname(6)   =  &#39;M2&#39;   !  name of constituent - all tidal components must be set in namelist_cfg
clname(7)   = &#39;S2&#39;   !  name of constituent - all tidal components must be set in namelist_cfg
clname(8)   = &#39;K2&#39;   !  name of constituent - all tidal components must be set in namelist_cfg
clname(9)   = &#39;M4&#39;   !  name of constituent - all tidal components must be set in namelist_cfg
</pre></div>
</div>
</dd>
</dl>
<p>Edit the output to have 1hrly SSH:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>vi file_def_nemo.xml
...
&lt;file_group id=&quot;1h&quot; output_freq=&quot;1h&quot;  output_level=&quot;10&quot; enabled=&quot;.TRUE.&quot;&gt; &lt;!-- 1h files --&gt;
 &lt;file id=&quot;file19&quot; name_suffix=&quot;_SSH&quot; description=&quot;ocean T grid variables&quot; &gt;
   &lt;field field_ref=&quot;ssh&quot;          name=&quot;zos&quot;   /&gt;
 &lt;/file&gt;
&lt;/file_group&gt;
</pre></div>
</div>
<p>Create a short queue runscript:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>vi runscript
#!/bin/bash
#PBS -N LBay
#PBS -l select=5
#PBS -l walltime=00:20:00
#PBS -A n01-NOCL
# mail alert at (b)eginning, (e)nd and (a)bortion of execution
#PBS -m bea
#PBS -M jelt@noc.ac.uk


module swap PrgEnv-cray PrgEnv-intel
module load cray-netcdf-hdf5parallel
module load cray-hdf5-parallel

export PBS_O_WORKDIR=$(readlink -f $PBS_O_WORKDIR)
#  echo $(readlink -f $PBS_O_WORKDIR)
# export OMP_NUM_THREADS=1

cd $PBS_O_WORKDIR
#
  echo &quot; &quot;;
  OCEANCORES=96
  XIOCORES=1
ulimit -c unlimited
ulimit -s unlimited

rm -f core

#aprun -n $OCEANCORES -N 24 ./opa
aprun -b -n 5 -N 5 ./xios_server.exe : -n $OCEANCORES -N 24 ./opa
#aprun -b -n $XIOCORES -N 1 ./xios_server.exe : -n $OCEANCORES -N 24 ./opa

exit
</pre></div>
</div>
<p>Then submit:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cd $EXP
qsub -q short runscript

4806706.sdb
</pre></div>
</div>
<p>&#8212;</p>
<p><strong>ERROR</strong>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">CAttributeMap</span><span class="p">::</span><span class="n">operator</span><span class="p">[](</span><span class="n">const</span> <span class="n">StdString</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">)]</span> <span class="p">:</span> <span class="n">In</span> <span class="n">file</span> <span class="s1">&#39;/work/n01/n01/jelt/xios-2.0_r1080/src/attribute_m</span>
<span class="n">ap</span><span class="o">.</span><span class="n">cpp</span><span class="s1">&#39;, line 56 -&gt; [ key = time_origin] key not found !</span>
<span class="o">&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">CAttributeMap</span><span class="p">::</span><span class="n">operator</span><span class="p">[](</span><span class="n">const</span> <span class="n">StdString</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">)]</span> <span class="p">:</span> <span class="n">In</span> <span class="n">file</span> <span class="s1">&#39;/work/n01/n01/jelt/xios-2.0_r1080/src/attribute_m</span>
<span class="n">ap</span><span class="o">.</span><span class="n">cpp</span><span class="s1">&#39;, line 56 -&gt; [ key = time_origin] key not found !</span>
<span class="o">&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">CAttributeMap</span><span class="p">::</span><span class="n">operator</span><span class="p">[](</span><span class="n">const</span> <span class="n">StdString</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">)]</span> <span class="p">:</span> <span class="n">In</span> <span class="n">file</span> <span class="s1">&#39;/work/n01/n01/jelt/xios-2.0_r1080/src/attribute_m</span>
<span class="n">ap</span><span class="o">.</span><span class="n">cpp</span><span class="s1">&#39;, line 56 -&gt; [ key = time_origin] key not found !</span>
</pre></div>
</div>
<p>&#8212;</p>
<p>Looks like a XML problem. Copy working XML files from EAfrica</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>export CONFIG=LBay
export WORK=/work/n01/n01
export WDIR=$WORK/$USER/$CONFIG
export INPUTS=$WORK/$USER/$CONFIG/INPUTS
export CDIR=$WDIR/trunk_NEMOGCM_r8395/CONFIG
export TDIR=$WDIR/trunk_NEMOGCM_r8395/TOOLS
export EXP=$CDIR/$CONFIG/EXP00


module swap PrgEnv-cray PrgEnv-intel
module load cray-netcdf-hdf5parallel cray-hdf5-parallel

export JINPUTS=/work/n01/n01/jdha/2017/INPUTS/ODA/E-AFRICA
export JEXP=/work/n01/n01/jdha/2017/nemo/trunk/NEMOGCM/CONFIG/ODA_E-AFRICA/EXP00/
</pre></div>
</div>
<p>&#8212;</p>
<p>Copy working XML files from EAfrica:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cd $EXP
mv *.xml XML/.
cp /work/n01/n01/jelt/ACCORD/trunk_NEMOGCM_r8395/CONFIG/ACCORD/EXP_EAFRICA/*xml .
</pre></div>
</div>
<p>This works. Highlights missing EOS choice in namelist_cfg. Add in:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>vi namelist_cfg

!-----------------------------------------------------------------------
&amp;nameos        !   ocean physical parameters
!-----------------------------------------------------------------------
ln_teos10   = .false.         !  = Use TEOS-10 equation of state
ln_eos80    = .true.         !  = Use EOS80 equation of state
ln_seos     = .false.         !  = Use simplified equation of state (S-EOS)
                             !
!                     ! S-EOS coefficients (ln_seos=T):
!                             !  rd(T,S,Z)*rau0 = -a0*(1+.5*lambda*dT+mu*Z+nu*dS)*dT+b0*dS
rn_a0       =  1.6550e-1      !  thermal expension coefficient
rn_b0       =  7.6554e-1      !  saline  expension coefficient
rn_lambda1  =  5.9520e-2      !  cabbeling coeff in T^2  (=0 for linear eos)
rn_lambda2  =  7.4914e-4      !  cabbeling coeff in S^2  (=0 for linear eos)
rn_mu1      =  1.4970e-4      !  thermobaric coeff. in T (=0 for linear eos)
rn_mu2      =  1.1090e-5      !  thermobaric coeff. in S (=0 for linear eos)
rn_nu       =  2.4341e-3      !  cabbeling coeff in T*S  (=0 for linear eos)
</pre></div>
</div>
<p>Odd conflict in notation between namelist_ref in my new build and in JAmes&#8217;
Copy James&#8217; here:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cp /work/n01/n01/jdha/2017/nemo/trunk/NEMOGCM/CONFIG/ODA_E-AFRICA/EXP00/namelist_ref $EXP/namelist_ref


vi namelist_ref
!-----------------------------------------------------------------------
&amp;nameos        !   ocean physical parameters
!-----------------------------------------------------------------------
   ln_teos10   = .false.         !  = Use TEOS-10 equation of state
   ln_eos80    = .false.         !  = Use EOS80 equation of state
   ln_seos     = .false.         !  = Use simplified equation of state (S-EOS)
</pre></div>
</div>
<p>(Other other format had integers to choose the scheme.)</p>
<p>Problem in namdom</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">The</span> <span class="n">IOIPSL</span> <span class="n">calendar</span> <span class="ow">is</span> <span class="s2">&quot;gregorian&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">e</span><span class="o">.</span> <span class="n">leap</span> <span class="n">year</span>

<span class="o">===&gt;&gt;&gt;</span> <span class="p">:</span> <span class="n">E</span> <span class="n">R</span> <span class="n">R</span> <span class="n">O</span> <span class="n">R</span>
     <span class="o">===========</span>

<span class="n">misspelled</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">namelist</span> <span class="n">namdom</span> <span class="ow">in</span> <span class="n">configuration</span> <span class="n">namelist</span> <span class="n">iostat</span> <span class="o">=</span>    <span class="mi">19</span>

<span class="n">Namelist</span> <span class="n">namdom</span> <span class="p">:</span> <span class="n">space</span> <span class="o">&amp;</span> <span class="n">time</span> <span class="n">domain</span>
   <span class="n">linear</span> <span class="n">free</span> <span class="n">surface</span> <span class="p">(</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>              <span class="n">ln_linssh</span>  <span class="o">=</span>  <span class="n">F</span>
   <span class="n">suppression</span> <span class="n">of</span> <span class="n">closed</span> <span class="n">seas</span> <span class="p">(</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>       <span class="n">nn_closea</span>  <span class="o">=</span>            <span class="mi">0</span>
   <span class="n">create</span> <span class="n">mesh</span><span class="o">/</span><span class="n">mask</span> <span class="n">file</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>              <span class="n">nn_msh</span>     <span class="o">=</span>            <span class="mi">0</span>
        <span class="o">=</span> <span class="mi">0</span>   <span class="n">no</span> <span class="n">file</span> <span class="n">created</span>
        <span class="o">=</span> <span class="mi">1</span>   <span class="n">mesh_mask</span>
        <span class="o">=</span> <span class="mi">2</span>   <span class="n">mesh</span> <span class="ow">and</span> <span class="n">mask</span>
        <span class="o">=</span> <span class="mi">3</span>   <span class="n">mesh_hgr</span><span class="p">,</span> <span class="n">msh_zgr</span> <span class="ow">and</span> <span class="n">mask</span>
   <span class="n">treshold</span> <span class="n">to</span> <span class="nb">open</span> <span class="n">the</span> <span class="n">isf</span> <span class="n">cavity</span>       <span class="n">rn_isfhmin</span> <span class="o">=</span>
<span class="mf">1.00000000000000</span>       <span class="p">(</span><span class="n">m</span><span class="p">)</span>
   <span class="n">ocean</span> <span class="n">time</span> <span class="n">step</span>                       <span class="n">rn_rdt</span>     <span class="o">=</span>
<span class="mf">60.0000000000000</span>
   <span class="n">asselin</span> <span class="n">time</span> <span class="nb">filter</span> <span class="n">parameter</span>         <span class="n">rn_atfp</span>    <span class="o">=</span>
<span class="mf">0.100000000000000</span>
   <span class="n">online</span> <span class="n">coarsening</span> <span class="n">of</span> <span class="n">dynamical</span> <span class="n">fields</span> <span class="n">ln_crs</span>     <span class="o">=</span>  <span class="n">F</span>
</pre></div>
</div>
<p>Try the new format:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>!-----------------------------------------------------------------------
&amp;namdom        !   space and time domain (bathymetry, mesh, timestep)
!-----------------------------------------------------------------------
 ln_linssh   = .false.   !  =T  linear free surface  ==&gt;&gt;  model level are fixed in time
 nn_closea   =    0      !  remove (=0) or keep (=1) closed seas and lakes (ORCA)
 !
 nn_msh      =    0      !  create (&gt;0) a mesh file or not (=0)
 rn_isfhmin  =    1.00   !  treshold (m) to discriminate grounding ice to floating ice
 !
 rn_rdt      =  60.     !  time step for the dynamics (and tracer if nn_acc=0)
 rn_atfp     =    0.1    !  asselin time filter parameter
 !
 ln_crs      = .false.   !  Logical switch for coarsening module
</pre></div>
</div>
<p>The vertical coordintes choice thing seems to have disappeared in the new build:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>!-----------------------------------------------------------------------
&amp;namzgr        !   vertical coordinate
!-----------------------------------------------------------------------
   ln_zps      = .false.   !  z-coordinate - partial steps   (T/F)
   ln_sco      = .true.    !  s- or hybrid z-s-coordinate    (T/F)
/
!-----------------------------------------------------------------------
&amp;namzgr_sco    !   s-coordinate or hybrid z-s-coordinate
!-----------------------------------------------------------------------
   ln_s_sh94   = .false.   !  Song &amp; Haidvogel 1994 hybrid S-sigma   (T)|
   ln_s_sf12   = .true.    !  Siddorn &amp; Furner 2012 hybrid S-z-sigma (T)| if both are false the NEMO tanh stretching is applied
   ln_sigcrit  = .true.    !  use sigma coordinates below critical depth (T) or Z coordinates (F) for Siddorn &amp; Furner stretch
                           !  stretching coefficients for all functions
   rn_hc       =   50.0    !  critical depth for transition to stretched coordinates
</pre></div>
</div>
<p>There are a few references to s-coordinates in the HPG and later diffusion variables.</p>
<p>Hmm. Try the other way around start with James&#8217; namelist_cfg_R12 and change bits to
match my LBay (old working) example</p>
<p>Update boundary mask file name:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>/
!-----------------------------------------------------------------------
&amp;nambdy        !  unstructured open boundaries
!-----------------------------------------------------------------------
    ln_bdy         = .true.              !  Use unstructured open boundaries
    nb_bdy         = 1                    !  number of open boundary sets
    ln_coords_file = .true.               !  =T : read bdy coordinates from file
    cn_coords_file = &#39;coordinates.bdy.nc&#39; !  bdy coordinates files
    ln_mask_file   = .true.              !  =T : read mask from file
    cn_mask_file   = &#39;bdydta/LBay_bdyT_y2000m01.nc&#39;     !  name of mask file (if ln_mask_file=.TRUE.)
    cn_dyn2d       = &#39;flather&#39;               !
</pre></div>
</div>
<p>Automatically set the processor decomposition (not sure if it is used):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>&amp;nammpp        !   Massively Parallel Processing                        (&quot;key_mpp_mpi)
</pre></div>
</div>
<p>Switch the vertical grid thing off. Comment it out as the default is .true. BTW
the run really doesn&#8217;t work without this action:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>vi namelist_cfg
...
!-----------------------------------------------------------------------
&amp;namcfg        !   parameters of the configuration
!-----------------------------------------------------------------------
!   ln_e3_dep   = .false.    ! This will be obsolete soon. See namelist_ref
</pre></div>
</div>
<p>Change some lateral diffusion settings:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>!-----------------------------------------------------------------------
&amp;namtra_ldf    !   lateral diffusion scheme for tracers                 (default: NO diffusion)
!-----------------------------------------------------------------------
   !                       !  Operator type:
   !                           !  no diffusion: set ln_traldf_lap=..._blp=F
   ln_traldf_lap   =  .true.  !    laplacian operator
   ln_traldf_blp   =  .false.  !  bilaplacian operator
   !
   !                       !  Direction of action:
   ln_traldf_lev   =  .false.  !  iso-level
   ln_traldf_hor   =  .false.  !  horizontal (geopotential)
   ln_traldf_iso   =  .true.  !  iso-neutral (standard operator)
</pre></div>
</div>
<p>Gets further. Now the ocean.output ends with:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">dia_25h_init</span> <span class="p">:</span> <span class="n">Output</span> <span class="mi">25</span> <span class="n">hour</span> <span class="n">mean</span> <span class="n">diagnostics</span>
<span class="o">~~~~~~~~~~~~</span>
<span class="n">Namelist</span> <span class="n">nam_dia25h</span> <span class="p">:</span> <span class="nb">set</span> <span class="mi">25</span><span class="n">h</span> <span class="n">outputs</span>
<span class="n">Switch</span> <span class="k">for</span> <span class="mi">25</span><span class="n">h</span> <span class="n">diagnostics</span> <span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="n">F</span><span class="p">)</span>  <span class="n">ln_dia25h</span>  <span class="o">=</span>  <span class="n">F</span>

<span class="n">AAAAAAAA</span>


<span class="n">sbc_tide</span> <span class="p">:</span> <span class="n">Update</span> <span class="n">of</span> <span class="n">the</span> <span class="n">components</span> <span class="ow">and</span> <span class="p">(</span><span class="n">re</span><span class="p">)</span><span class="n">Init</span><span class="o">.</span> <span class="n">the</span> <span class="n">potential</span> <span class="n">at</span> <span class="n">kt</span><span class="o">=</span>
          <span class="mi">1</span>
<span class="o">~~~~~~~~</span>
<span class="n">Q1</span>    <span class="o">-</span><span class="mf">12.3894431662406</span>       <span class="mf">0.908086877990601</span>      <span class="o">-</span><span class="mf">0.702799902800797</span>
 <span class="mf">6.495854101908828E-005</span>
<span class="n">O1</span>    <span class="o">-</span><span class="mf">12.3894431662406</span>       <span class="mf">0.908086877990601</span>        <span class="mf">1.76695796869312</span>
 <span class="mf">6.759774402887834E-005</span>
<span class="n">P1</span>    <span class="mf">0.000000000000000E+000</span>   <span class="mf">1.00000000000000</span>      <span class="o">-</span><span class="mf">0.189080734230733</span>
 <span class="mf">7.252294578606445E-005</span>
<span class="n">S1</span>    <span class="mf">0.000000000000000E+000</span>   <span class="mf">1.00000000000000</span>        <span class="mf">3.14377431515479</span>
 <span class="mf">7.272205216643040E-005</span>
<span class="n">K1</span>   <span class="o">-</span><span class="mf">0.138134509178184</span>       <span class="mf">0.943678543708499</span>        <span class="mf">6.47662936454030</span>
 <span class="mf">7.292115854679635E-005</span>
<span class="mi">2</span><span class="n">N2</span>   <span class="o">-</span><span class="mf">12.5967638158724</span>        <span class="mf">1.02169282172100</span>        <span class="mf">3.30407159024559</span>
 <span class="mf">1.352404965560946E-004</span>
<span class="n">MU2</span>   <span class="o">-</span><span class="mf">12.5967638158724</span>        <span class="mf">1.02169282172100</span>        <span class="mf">10.1996260361573</span>
 <span class="mf">1.355937008184885E-004</span>
<span class="n">N2</span>    <span class="o">-</span><span class="mf">12.5967638158724</span>        <span class="mf">1.02169282172100</span>        <span class="mf">5.77382946173951</span>
 <span class="mf">1.378796995658846E-004</span>
<span class="n">NU2</span>   <span class="o">-</span><span class="mf">12.5967638158724</span>        <span class="mf">1.02169282172100</span>        <span class="mf">12.6693839076512</span>
 <span class="mf">1.382329038282786E-004</span>
<span class="n">M2</span>    <span class="o">-</span><span class="mf">12.5967638158724</span>        <span class="mf">1.02169282172100</span>        <span class="mf">8.24358733323342</span>
 <span class="mf">1.405189025756747E-004</span>
<span class="n">L2</span>    <span class="o">-</span><span class="mf">12.5967638158724</span>        <span class="mf">1.19824874449528</span>        <span class="mf">13.8549378583171</span>
 <span class="mf">1.431581055854647E-004</span>
<span class="n">T2</span>    <span class="mf">0.000000000000000E+000</span>   <span class="mf">1.00000000000000</span>        <span class="mf">6.32212956235245</span>
 <span class="mf">1.452450074605893E-004</span>
<span class="n">S2</span>    <span class="mf">0.000000000000000E+000</span>   <span class="mf">1.00000000000000</span>        <span class="mf">6.28754863030957</span>
 <span class="mf">1.454441043328608E-004</span>
<span class="n">K2</span>   <span class="o">-</span><span class="mf">0.264695210962853</span>       <span class="mf">0.854177079157964</span>        <span class="mf">16.0948513826704</span>
 <span class="mf">1.458423170935927E-004</span>
<span class="n">M4</span>    <span class="o">-</span><span class="mf">25.1935276317449</span>        <span class="mf">1.04385622195621</span>        <span class="mf">16.4871746664668</span>
 <span class="mf">2.810378051513493E-004</span>
</pre></div>
</div>
<p>Try setting tides to false:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>!-----------------------------------------------------------------------
</pre></div>
</div>
<p>&amp;nam_tide      !   tide parameters
!&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8211;</p>
<blockquote>
<div>ln_tide     = .false.
ln_tide_pot = .false.    !  use tidal potential forcing</div></blockquote>
<p>Caused problems with Flather bc etc.
Turned ln_tide = .true., keep tidal potential off. Simulation terminates with
same output (above), having listed the harmonic components. Hmmm</p>
<p>Tide forcing directory:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>!-----------------------------------------------------------------------
&amp;nambdy_tide     ! tidal forcing at open boundaries
!-----------------------------------------------------------------------
   filtide      = &#39;bdydta/LBay_bdytide_rotT_&#39;         !  file name root of tidal forcing files
</pre></div>
</div>
<p>Turned ln_tide_pot = .true. (I think that the tidal boundary files are way more
likely to give trouble than tidal potential forcing)</p>
<p>Added some more constituents to the TPXO forcing list. Regenerated with PyNEMO.
Not sure about which constituents to include under key_tide in the OPA namelist_cfg
Not sure because some of the constituent names differ. Is it looking for TPXO files
of this name, or is it setting the internal harmonic frequencies. On reflection I guess
the harmonic analyisis is entirely separate and will only pick out freq requested
in the harm namelist.</p>
<p>Submit:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">qsub</span> <span class="n">runscript</span>  <span class="c1"># changed to a 4 minute walltime request</span>
<span class="mf">4834214.</span><span class="n">sdb</span>
</pre></div>
</div>
<p><strong>SAME ERROR / NON ERROR AS ABOVE. What next. How to get past this point....?</strong></p>
<p><em>Fixed lots of stuff. Mostly putting in missing stuff into namelist_cfg</em></p>
<p>&#8212;</p>
<p><em>10 Oct 2017</em></p>
<p>Fail</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">sbc_tide</span> <span class="p">:</span> <span class="n">Update</span> <span class="n">of</span> <span class="n">the</span> <span class="n">components</span> <span class="ow">and</span> <span class="p">(</span><span class="n">re</span><span class="p">)</span><span class="n">Init</span><span class="o">.</span> <span class="n">the</span> <span class="n">potential</span> <span class="n">at</span> <span class="n">kt</span><span class="o">=</span>
          <span class="mi">1</span>
<span class="o">~~~~~~~~</span>
<span class="n">Q1</span>    <span class="o">-</span><span class="mf">12.3894431662406</span>       <span class="mf">0.908086877990601</span>      <span class="o">-</span><span class="mf">0.702799902800797</span>
 <span class="mf">6.495854101908828E-005</span>
<span class="n">O1</span>    <span class="o">-</span><span class="mf">12.3894431662406</span>       <span class="mf">0.908086877990601</span>        <span class="mf">1.76695796869312</span>
 <span class="mf">6.759774402887834E-005</span>
<span class="n">P1</span>    <span class="mf">0.000000000000000E+000</span>   <span class="mf">1.00000000000000</span>      <span class="o">-</span><span class="mf">0.189080734230733</span>
 <span class="mf">7.252294578606445E-005</span>
<span class="n">K1</span>   <span class="o">-</span><span class="mf">0.138134509178184</span>       <span class="mf">0.943678543708499</span>        <span class="mf">6.47662936454030</span>
 <span class="mf">7.292115854679635E-005</span>
<span class="n">N2</span>    <span class="o">-</span><span class="mf">12.5967638158724</span>        <span class="mf">1.02169282172100</span>        <span class="mf">5.77382946173951</span>
 <span class="mf">1.378796995658846E-004</span>
<span class="n">M2</span>    <span class="o">-</span><span class="mf">12.5967638158724</span>        <span class="mf">1.02169282172100</span>        <span class="mf">8.24358733323342</span>
 <span class="mf">1.405189025756747E-004</span>
<span class="n">S2</span>    <span class="mf">0.000000000000000E+000</span>   <span class="mf">1.00000000000000</span>        <span class="mf">6.28754863030957</span>
 <span class="mf">1.454441043328608E-004</span>
<span class="n">K2</span>   <span class="o">-</span><span class="mf">0.264695210962853</span>       <span class="mf">0.854177079157964</span>        <span class="mf">16.0948513826704</span>
 <span class="mf">1.458423170935927E-004</span>
<span class="n">M4</span>    <span class="o">-</span><span class="mf">25.1935276317449</span>        <span class="mf">1.04385622195621</span>        <span class="mf">16.4871746664668</span>
 <span class="mf">2.810378051513493E-004</span>
                    <span class="n">iom_nf90_open</span> <span class="o">~~~</span> <span class="nb">open</span> <span class="n">existing</span> <span class="n">file</span><span class="p">:</span> <span class="o">../../../../</span><span class="n">INPUTS</span><span class="o">/</span><span class="n">cu</span>
<span class="n">tdown_drowned_u10_DFS5</span><span class="o">.</span><span class="mf">1.1</span><span class="n">_y2000</span><span class="o">.</span><span class="n">nc</span> <span class="ow">in</span> <span class="n">READ</span> <span class="n">mode</span>
                   <span class="o">---&gt;</span> <span class="o">../../../../</span><span class="n">INPUTS</span><span class="o">/</span><span class="n">cutdown_drowned_u10_DFS5</span><span class="o">.</span><span class="mf">1.1</span><span class="n">_y2000</span><span class="o">.</span><span class="n">n</span>
<span class="n">c</span> <span class="n">OK</span>
                    <span class="n">iom_nf90_open</span> <span class="o">~~~</span> <span class="nb">open</span> <span class="n">existing</span> <span class="n">file</span><span class="p">:</span> <span class="o">../../../../</span><span class="n">INPUTS</span><span class="o">/</span><span class="n">cu</span>
<span class="n">tdown_drowned_u10_DFS5</span><span class="o">.</span><span class="mf">1.1</span><span class="n">_y2000</span><span class="o">.</span><span class="n">nc</span> <span class="ow">in</span> <span class="n">READ</span> <span class="n">mode</span>
                   <span class="o">---&gt;</span> <span class="o">../../../../</span><span class="n">INPUTS</span><span class="o">/</span><span class="n">cutdown_drowned_u10_DFS5</span><span class="o">.</span><span class="mf">1.1</span><span class="n">_y2000</span><span class="o">.</span><span class="n">n</span>
<span class="n">c</span> <span class="n">OK</span>
                    <span class="n">iom_close</span> <span class="o">~~~</span> <span class="n">close</span> <span class="n">file</span><span class="p">:</span> <span class="o">../../../../</span><span class="n">INPUTS</span><span class="o">/</span><span class="n">cutdown_drowne</span>
<span class="n">d_u10_DFS5</span><span class="o">.</span><span class="mf">1.1</span><span class="n">_y2000</span><span class="o">.</span><span class="n">nc</span> <span class="n">ok</span>
                    <span class="n">iom_nf90_open</span> <span class="o">~~~</span> <span class="nb">open</span> <span class="n">existing</span> <span class="n">file</span><span class="p">:</span> <span class="o">../../../../</span><span class="n">INPUTS</span><span class="o">/</span><span class="n">we</span>
<span class="n">ights_bicubic_atmos</span><span class="o">.</span><span class="n">nc</span> <span class="ow">in</span> <span class="n">READ</span> <span class="n">mode</span>
                   <span class="o">---&gt;</span> <span class="o">../../../../</span><span class="n">INPUTS</span><span class="o">/</span><span class="n">weights_bicubic_atmos</span><span class="o">.</span><span class="n">nc</span> <span class="n">OK</span>
          <span class="n">read</span> <span class="n">src01</span> <span class="p">(</span><span class="n">rec</span><span class="p">:</span>      <span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="o">../../../../</span><span class="n">INPUTS</span><span class="o">/</span><span class="n">weights_bicubic_atmos</span><span class="o">.</span><span class="n">nc</span> <span class="n">ok</span>
</pre></div>
</div>
<dl class="docutils">
<dt>Inspection of v3.6 ocean.output suggests there is a problem with</dt>
<dd><p class="first">weight_bicublic_atmos.nc. The output would have continued as:</p>
<div class="last highlight-default"><div class="highlight"><pre><span></span><span class="n">ls</span> <span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">jelt</span><span class="o">/</span><span class="n">LBay</span><span class="o">/</span><span class="n">dev_r4621_NOC4_BDY_VERT_INTERP</span><span class="o">/</span><span class="n">NEMOGCM</span><span class="o">/</span><span class="n">CONFIG</span><span class="o">/</span><span class="n">LBay</span><span class="o">/</span><span class="n">EXP00</span><span class="o">/</span><span class="n">ocean</span><span class="o">.</span><span class="n">output</span>
<span class="o">...</span>

<span class="n">iom_nf90_open</span> <span class="o">~~~</span> <span class="nb">open</span> <span class="n">existing</span> <span class="n">file</span><span class="p">:</span> <span class="o">../../../../../</span><span class="n">INPUTS</span>
<span class="o">/</span><span class="n">cutdown_drowned_u10_DFS5</span><span class="o">.</span><span class="mf">1.1</span><span class="n">_y2000</span><span class="o">.</span><span class="n">nc</span> <span class="ow">in</span> <span class="n">READ</span> <span class="n">mode</span>
<span class="o">---&gt;</span> <span class="o">../../../../../</span><span class="n">INPUTS</span><span class="o">/</span><span class="n">cutdown_drowned_u10_DFS5</span><span class="o">.</span><span class="mf">1.1</span><span class="n">_y200</span>
<span class="mf">0.</span><span class="n">nc</span> <span class="n">OK</span>
<span class="n">iom_close</span> <span class="o">~~~</span> <span class="n">close</span> <span class="n">file</span><span class="p">:</span> <span class="o">../../../../../</span><span class="n">INPUTS</span><span class="o">/</span><span class="n">cutdown_dro</span>
<span class="n">wned_u10_DFS5</span><span class="o">.</span><span class="mf">1.1</span><span class="n">_y2000</span><span class="o">.</span><span class="n">nc</span> <span class="n">ok</span>
<span class="n">iom_nf90_open</span> <span class="o">~~~</span> <span class="nb">open</span> <span class="n">existing</span> <span class="n">file</span><span class="p">:</span> <span class="o">../../../../../</span><span class="n">INPUTS</span>
<span class="o">/</span><span class="n">weights_bicubic_atmos</span><span class="o">.</span><span class="n">nc</span> <span class="ow">in</span> <span class="n">READ</span> <span class="n">mode</span>
<span class="o">---&gt;</span> <span class="o">../../../../../</span><span class="n">INPUTS</span><span class="o">/</span><span class="n">weights_bicubic_atmos</span><span class="o">.</span><span class="n">nc</span> <span class="n">OK</span>
<span class="n">read</span> <span class="n">src01</span> <span class="p">(</span><span class="n">rec</span><span class="p">:</span>      <span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="o">../../../../../</span><span class="n">INPUTS</span><span class="o">/</span><span class="n">weights_bicubic_atmos</span><span class="o">.</span><span class="n">nc</span> <span class="n">ok</span>
<span class="n">read</span> <span class="n">src02</span> <span class="p">(</span><span class="n">rec</span><span class="p">:</span>      <span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="o">../../../../../</span><span class="n">INPUTS</span><span class="o">/</span><span class="n">weights_bicubic_atmos</span><span class="o">.</span><span class="n">nc</span> <span class="n">ok</span>
<span class="n">read</span> <span class="n">src03</span> <span class="p">(</span><span class="n">rec</span><span class="p">:</span>      <span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="o">../../../../../</span><span class="n">INPUTS</span><span class="o">/</span><span class="n">weights_bicubic_atmos</span><span class="o">.</span><span class="n">nc</span> <span class="n">ok</span>
<span class="n">read</span> <span class="n">src04</span> <span class="p">(</span><span class="n">rec</span><span class="p">:</span>      <span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="o">../../../../../</span><span class="n">INPUTS</span><span class="o">/</span><span class="n">weights_bicubic_atmos</span><span class="o">.</span><span class="n">nc</span> <span class="n">ok</span>
<span class="n">read</span> <span class="n">wgt01</span> <span class="p">(</span><span class="n">rec</span><span class="p">:</span>      <span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="o">../../../../../</span><span class="n">INPUTS</span><span class="o">/</span><span class="n">weights_bicubic_atmos</span><span class="o">.</span><span class="n">nc</span> <span class="n">ok</span>
<span class="n">read</span> <span class="n">wgt02</span> <span class="p">(</span><span class="n">rec</span><span class="p">:</span>      <span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="o">../../../../../</span><span class="n">INPUTS</span><span class="o">/</span><span class="n">weights_bicubic_atmos</span><span class="o">.</span><span class="n">nc</span> <span class="n">ok</span>
<span class="n">read</span> <span class="n">wgt03</span> <span class="p">(</span><span class="n">rec</span><span class="p">:</span>      <span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="o">../../../../../</span><span class="n">INPUTS</span><span class="o">/</span><span class="n">weights_bicubic_atmos</span><span class="o">.</span><span class="n">nc</span> <span class="n">ok</span>
</pre></div>
</div>
</dd>
</dl>
<p>Try switch to CORE v3.0 ln_COARE_3p0
No joy. Try and check what comes next. Is this reading in the right file or should it be looking for tide data?</p>
<p>ln_COARE_3p0= .true.   ! &#8220;COARE 3.0&#8221; algorithm   (Fairall et al. 2003)
ln_COARE_3p5= .false.   ! &#8220;COARE 3.5&#8221; algorithm   (Edson et al. 2013)
&#8211;&gt; both as true in ocean.output</p>
<p>namelist_cfg:   ln_COARE_3p0= .false.   ! &#8220;COARE 3.0&#8221; algorithm   (Fairall et al. 2003)
namelist_cfg:   ln_COARE_3p5= .true.   ! &#8220;COARE 3.5&#8221; algorithm   (Edson et al. 2013)
&#8211;&gt; both false in ocean.output</p>
<p>Typo in sbcblk.F90 line 251/ Logical flag pointing to wrong variable. See:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">WRITE</span><span class="p">(</span><span class="n">numout</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;      &quot;COARE 3.5&quot; algorithm   (Edson et al. 2013)         ln_COARE_3p5 = &#39;</span><span class="p">,</span> <span class="n">ln_COARE_3p0</span>
</pre></div>
</div>
<p>Try ln_NCAR instead...
<em>(10 Oct 2017)</em></p>
<p>Change: nn_dyn2d_data = 2 —&gt; 3. This just means that the &#8216;LBay_bt_bdyT etc in
&amp;nambdy_dta are read in:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>&amp;nambdy        !  unstructured open boundaries
!-----------------------------------------------------------------------
    ln_bdy         = .true.              !  Use unstructured open boundaries
    ...
    nn_dyn2d_dta   =  3                   !  = 0, bdy data are equal to the initial state
                                          !  = 1, bdy data are read in &#39;bdydata   .nc&#39; files
                                          !  = 2, use tidal harmonic forcing data from files
                                          !  = 3, use external data AND tidal harmonic forcing
</pre></div>
</div>
<p><strong>Does it work?</strong></p>
<p>Waiting for standard queue to proces, I note that</p>
<p>There are a number of differences in the tidal boundary conditions between James’ ORCHESTRA run and my LBay simulations.</p>
<p>Check nambdy:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">jdha</span><span class="o">/</span><span class="mi">2017</span><span class="o">/</span><span class="n">nemo</span><span class="o">/</span><span class="n">trunk</span><span class="o">/</span><span class="n">NEMOGCM</span><span class="o">/</span><span class="n">CONFIG</span><span class="o">/</span><span class="n">ORCHESTRA</span><span class="o">/</span><span class="n">EXP00</span><span class="o">/</span><span class="n">namelist_cfg</span>
<span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">jelt</span><span class="o">/</span><span class="n">LBay</span><span class="o">/</span><span class="n">trunk_NEMOGCM_r8395</span><span class="o">/</span><span class="n">CONFIG</span><span class="o">/</span><span class="n">LBay</span><span class="o">/</span><span class="n">EXP00</span><span class="o">/</span><span class="n">namelist_cfg</span>
</pre></div>
</div>
<p><strong>PENDING</strong></p>
<p>Need to keep a track of differences between namelist_cfg in EXP and DOMAINcfg</p>
<p>&#8212;</p>
<p><em>(11 Oct 2017)</em></p>
<p>Update the mask file:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>!-----------------------------------------------------------------------
&amp;nambdy        !  unstructured open boundaries
!-----------------------------------------------------------------------
    ln_bdy         = .true.              !  Use unstructured open boundaries
    nb_bdy         = 1                    !  number of open boundary sets
    ln_coords_file = .true.               !  =T : read bdy coordinates from file
    cn_coords_file = &#39;coordinates.bdy.nc&#39; !  bdy coordinates files
    ln_mask_file   = .false.              !  =T : read mask from file
    cn_mask_file   = &#39;domain_cfg.nc&#39;                   !  name of mask file (if ln_mask_file=.TRUE.)
</pre></div>
</div>
<p>Make some changes in the open boundary files. Originally:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>!-----------------------------------------------------------------------
&amp;nambdy_dta    !  open boundaries - external data
!-----------------------------------------------------------------------
!              !  file name      ! frequency (hours) ! variable  ! time interp.!  clim   ! &#39;yearly&#39;/ ! weights  ! rotation ! land/sea mask !
!              !                 !  (if &lt;0  months)  !   name    !  (logical)  !  (T/F ) ! &#39;monthly&#39; ! filename ! pairing  ! filename      !
   bn_ssh      = &#39;Tbdy&#39;,                   -1        , &#39;sossheig&#39;,    .false.   , .true. ,  &#39;yearly&#39;  ,    &#39;&#39;    ,   &#39;&#39;     ,     &#39;&#39;
   bn_u2d      = &#39;Ubdy&#39;,                   -1        , &#39;vobtcrtx&#39;,    .false.   , .true. ,  &#39;yearly&#39;  ,    &#39;&#39;    ,   &#39;&#39;     ,     &#39;&#39;
   bn_v2d      = &#39;Vbdy&#39;,                   -1        , &#39;vobtcrty&#39;,    .false.   , .true. ,  &#39;yearly&#39;  ,    &#39;&#39;    ,   &#39;&#39;     ,     &#39;&#39;
   bn_u3d      = &#39;amm12_bdyU_u3d&#39;,         24        , &#39;vozocrtx&#39;,    .true.   , .false. ,  &#39;daily&#39;  ,    &#39;&#39;    ,   &#39;&#39;     ,     &#39;&#39;
   bn_v3d      = &#39;amm12_bdyV_u3d&#39;,         24        , &#39;vomecrty&#39;,    .true.   , .false. ,  &#39;daily&#39;  ,    &#39;&#39;    ,   &#39;&#39;     ,     &#39;&#39;
   bn_tem      = &#39;amm12_bdyT_tra&#39;,         24        , &#39;votemper&#39;,    .true.   , .false. ,  &#39;daily&#39;  ,    &#39;&#39;    ,   &#39;&#39;     ,     &#39;&#39;
   bn_sal      = &#39;amm12_bdyT_tra&#39;,         24        , &#39;vosaline&#39;,    .true.   , .false. ,  &#39;daily&#39;  ,    &#39;&#39;    ,   &#39;&#39;     ,     &#39;&#39;
</pre></div>
</div>
<p>Change to:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>!-----------------------------------------------------------------------
&amp;nambdy_dta    !  open boundaries - external data
!-----------------------------------------------------------------------
!              !  file name      ! frequency (hours) ! variable  ! time interp.!  clim   ! &#39;yearly&#39;/ ! weights  ! rotation ! land/sea mask !
!              !                 !  (if &lt;0  months)  !   name    !  (logical)  !  (T/F ) ! &#39;monthly&#39; ! filename ! pairing  ! filename      !
bn_ssh      = &#39;LBay_bt_bdyT&#39;, 24      , &#39;sossheig&#39;,    .true.   , .false. ,  &#39;monthly&#39;  ,    &#39;&#39;    ,   &#39;&#39;     ,     &#39;&#39;
bn_u2d      = &#39;LBay_bdyU&#39;,  24        , &#39;vobtcrtx&#39;,    .true.   , .false. ,  &#39;monthly&#39;  ,    &#39;&#39;    ,   &#39;&#39;     ,     &#39;&#39;
bn_v2d      = &#39;LBay_bdyV&#39;,  24        , &#39;vobtcrty&#39;,    .true.   , .false. ,  &#39;monthly&#39;  ,    &#39;&#39;    ,   &#39;&#39;     ,     &#39;&#39;
bn_u3d      = &#39;LBay_bdyU&#39;   24        , &#39;vozocrtx&#39;,    .true.   , .false. ,  &#39;monthly&#39;  ,    &#39;&#39;    ,   &#39;&#39;     ,     &#39;&#39;
bn_v3d      = &#39;LBay_bdyV&#39;   24        , &#39;vomecrty&#39;,    .true.   , .false. ,  &#39;monthly&#39;  ,    &#39;&#39;    ,   &#39;&#39;     ,     &#39;&#39;
bn_tem      = &#39;LBay_bdyT&#39;   24        , &#39;votemper&#39;,    .true.   , .false. ,  &#39;monthly&#39;  ,    &#39;&#39;    ,   &#39;&#39;     ,     &#39;&#39;
bn_sal      = &#39;LBay_bdyT&#39;   24        , &#39;vosaline&#39;,    .true.   , .false. ,  &#39;monthly&#39;  ,    &#39;&#39;    ,   &#39;&#39;     ,     &#39;&#39;
</pre></div>
</div>
<dl class="docutils">
<dt>Though I need to check that these contain the correct variables. In particular</dt>
<dd>the 2D and 3D currents are in the same file?</dd>
</dl>
<p>Though I don’t use the 3D data - other than setting it to the initial state.</p>
<p>Observation.
Boundary 2D tides looks suspiciously like something I want to switch on. Currently:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>!-----------------------------------------------------------------------
</pre></div>
</div>
<p>&amp;nambdy_tide   !  tidal forcing at open boundaries
!&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8211;</p>
<blockquote>
<div>filtide      = &#8216;bdydta/<a href="#id15"><span class="problematic" id="id16">LBay_bdytide_rotT_</span></a>&#8216;         !  file name root of tidal forcing files
ln_bdytide_2ddta = .false.                   !
ln_bdytide_conj  = .false.                   !</div></blockquote>
<p>Things now look like they fail with the bulk forcing. Only read in one variable
from weights_bicubic_atmos.nc whereaas in the old code I read in ten or so...</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">tail</span> <span class="n">ocean</span><span class="o">.</span><span class="n">output</span>
                     <span class="n">iom_nf90_open</span> <span class="o">~~~</span> <span class="nb">open</span> <span class="n">existing</span> <span class="n">file</span><span class="p">:</span> <span class="o">../../../../</span><span class="n">INPUTS</span><span class="o">/</span><span class="n">we</span>
<span class="n">ights_bicubic_atmos</span><span class="o">.</span><span class="n">nc</span> <span class="ow">in</span> <span class="n">READ</span> <span class="n">mode</span>
                 <span class="o">---&gt;</span> <span class="o">../../../../</span><span class="n">INPUTS</span><span class="o">/</span><span class="n">weights_bicubic_atmos</span><span class="o">.</span><span class="n">nc</span> <span class="n">OK</span>
        <span class="n">read</span> <span class="n">src01</span> <span class="p">(</span><span class="n">rec</span><span class="p">:</span>      <span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="o">../../../../</span><span class="n">INPUTS</span><span class="o">/</span><span class="n">weights_bicubic_atmos</span><span class="o">.</span><span class="n">nc</span> <span class="n">ok</span>
</pre></div>
</div>
<p>&#8212;</p>
<dl class="docutils">
<dt>Instead copy the usrdef_sbc.F90 file to impose zero surface forcing::</dt>
<dd>rm $EXP/../MY_SRC/*
cp /work/n01/n01/jdha/2017/nemo/trunk/NEMOGCM/CONFIG/ODA_E-AFRICA/MY_SRC/usrdef_sbc.F90 $EXP/../MY_SRC/.</dd>
</dl>
<p>Rebuild works. Edit namelist:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>vi namelist_cfg
&amp;namsbc
  ln_usr      = .true.
  ln_blk      = .false.    !  Bulk formulation                          (T =&gt; fill namsbc_blk )



&amp;nambdy
  ln_bdy         = .false.
  nn_dyn2d_dta   =  0                   !  = 0, bdy data are equal to the initial state
                                          !  = 1, bdy data are read in &#39;bdydata   .nc&#39; files
                                          !  = 2, use tidal harmonic forcing data from files
                                          !  = 3, use external data AND tidal harmonic forcing
</pre></div>
</div>
<div class="section" id="resubmit">
<h4>Resubmit<a class="headerlink" href="#resubmit" title="Permalink to this headline">¶</a></h4>
<p>Trying turning on tidal forcing at boundaries in namelist (Though James had this set false)</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>&amp;nambdy_tide   !  tidal forcing at open boundaries
!-----------------------------------------------------------------------
   filtide      = &#39;bdydta/LBay_bdytide_rotT_&#39;         !  file name root of tidal forcing files
   ln_bdytide_2ddta = .true.                   !
</pre></div>
</div>
<p>This seems to do nothing. Keep it <strong>FALSE</strong></p>
<dl class="docutils">
<dt>Try::</dt>
<dd><blockquote class="first">
<div>!&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8211;</div></blockquote>
<p>&amp;nambdy        !  unstructured open boundaries
!&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8211;</p>
<blockquote class="last">
<div>ln_bdy         = .true.              !  Use unstructured open boundaries
nb_bdy         = 1                    !  number of open boundary sets
ln_coords_file = .true.               !  =T : read bdy coordinates from file
cn_coords_file = &#8216;coordinates.bdy.nc&#8217; !  bdy coordinates files
ln_mask_file   = .false.              !  =T : read mask from file
cn_mask_file   = &#8216;domain_cfg.nc&#8217;                   !  name of mask file (if ln_mask_file=.TRUE.)
cn_dyn2d       = &#8216;flather&#8217;               !
nn_dyn2d_dta   =  0                   !  = 0, bdy data are equal to the initial state</div></blockquote>
</dd>
</dl>
<p>Error. Seg fault.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">tail</span> <span class="n">ocean</span><span class="o">.</span><span class="n">output</span>

<span class="n">M2</span>    <span class="o">-</span><span class="mf">12.5967638158724</span>        <span class="mf">1.02169282172100</span>        <span class="mf">8.24358733323342</span>
 <span class="mf">1.405189025756747E-004</span>
<span class="n">S2</span>    <span class="mf">0.000000000000000E+000</span>   <span class="mf">1.00000000000000</span>        <span class="mf">6.28754863030957</span>
 <span class="mf">1.454441043328608E-004</span>
<span class="n">K2</span>   <span class="o">-</span><span class="mf">0.264695210962853</span>       <span class="mf">0.854177079157964</span>        <span class="mf">16.0948513826704</span>
 <span class="mf">1.458423170935927E-004</span>
<span class="n">M4</span>    <span class="o">-</span><span class="mf">25.1935276317449</span>        <span class="mf">1.04385622195621</span>        <span class="mf">16.4871746664668</span>
 <span class="mf">2.810378051513493E-004</span>
 <span class="n">usr_sbc</span> <span class="p">:</span> <span class="n">WAD_TEST_CASES</span> <span class="n">case</span><span class="p">:</span> <span class="n">NO</span> <span class="n">surface</span> <span class="n">forcing</span>
 <span class="o">~~~~~~~~~~~</span>   <span class="n">utau</span> <span class="o">=</span> <span class="n">vtau</span> <span class="o">=</span> <span class="n">taum</span> <span class="o">=</span> <span class="n">wndm</span> <span class="o">=</span> <span class="n">qns</span> <span class="o">=</span> <span class="n">qsr</span> <span class="o">=</span> <span class="n">emp</span> <span class="o">=</span> <span class="n">sfx</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
<p>Try:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>!-----------------------------------------------------------------------
&amp;nambdy        !  unstructured open boundaries
!-----------------------------------------------------------------------
    ln_bdy         = .true.              !  Use unstructured open boundaries
    nb_bdy         = 1                    !  number of open boundary sets
    ln_coords_file = .true.               !  =T : read bdy coordinates from file
    cn_coords_file = &#39;coordinates.bdy.nc&#39; !  bdy coordinates files
    ln_mask_file   = .false.              !  =T : read mask from file
    cn_mask_file   = &#39;domain_cfg.nc&#39;                   !  name of mask file (if ln_mask_file=.TRUE.)
    cn_dyn2d       = &#39;flather&#39;               !
    nn_dyn2d_dta   =  2                   !  = 0, bdy data are equal to the initial state
                                          !  = 1, bdy data are read in &#39;bdydata   .nc&#39; files
                                          !  = 2, use tidal harmonic forcing data from files
</pre></div>
</div>
<p>Same Error. Seg fault. Though ran for 40s:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span> <span class="n">tail</span> <span class="n">ocean</span><span class="o">.</span><span class="n">output</span>

 <span class="n">M2</span>    <span class="o">-</span><span class="mf">12.5967638158724</span>        <span class="mf">1.02169282172100</span>        <span class="mf">8.24358733323342</span>
<span class="mf">1.405189025756747E-004</span>
 <span class="n">S2</span>    <span class="mf">0.000000000000000E+000</span>   <span class="mf">1.00000000000000</span>        <span class="mf">6.28754863030957</span>
  <span class="mf">1.454441043328608E-004</span>
 <span class="n">K2</span>   <span class="o">-</span><span class="mf">0.264695210962853</span>       <span class="mf">0.854177079157964</span>        <span class="mf">16.0948513826704</span>
  <span class="mf">1.458423170935927E-004</span>
 <span class="n">M4</span>    <span class="o">-</span><span class="mf">25.1935276317449</span>        <span class="mf">1.04385622195621</span>        <span class="mf">16.4871746664668</span>
  <span class="mf">2.810378051513493E-004</span>
  <span class="n">usr_sbc</span> <span class="p">:</span> <span class="n">WAD_TEST_CASES</span> <span class="n">case</span><span class="p">:</span> <span class="n">NO</span> <span class="n">surface</span> <span class="n">forcing</span>
  <span class="o">~~~~~~~~~~~</span>   <span class="n">utau</span> <span class="o">=</span> <span class="n">vtau</span> <span class="o">=</span> <span class="n">taum</span> <span class="o">=</span> <span class="n">wndm</span> <span class="o">=</span> <span class="n">qns</span> <span class="o">=</span> <span class="n">qsr</span> <span class="o">=</span> <span class="n">emp</span> <span class="o">=</span> <span class="n">sfx</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
<p>Try reducing the timestep for 60s to 10s:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>&amp;namdom
  rn_rdt      =  10.     !  time step for the dynamics (and tracer if nn_acc=0)
</pre></div>
</div>
<p>Same problem. The timestep does not seem to have any effect.
Looking at an abort file that was generated when <code class="docutils literal"><span class="pre">ln_bdy=.false.</span></code> and the
velocities blew up showed that it was apparent that a coastal point was blowing up in velocity.
ocean.output abort message (ln_bdy = false):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="mf">1.458423170935927E-004</span>
<span class="n">M4</span>    <span class="o">-</span><span class="mf">25.1935276193127</span>        <span class="mf">1.04385624018260</span>        <span class="mf">16.4795866457279</span>
<span class="mf">2.810378051513493E-004</span>
<span class="n">usr_sbc</span> <span class="p">:</span> <span class="n">WAD_TEST_CASES</span> <span class="n">case</span><span class="p">:</span> <span class="n">NO</span> <span class="n">surface</span> <span class="n">forcing</span>
<span class="o">~~~~~~~~~~~</span>   <span class="n">utau</span> <span class="o">=</span> <span class="n">vtau</span> <span class="o">=</span> <span class="n">taum</span> <span class="o">=</span> <span class="n">wndm</span> <span class="o">=</span> <span class="n">qns</span> <span class="o">=</span> <span class="n">qsr</span> <span class="o">=</span> <span class="n">emp</span> <span class="o">=</span> <span class="n">sfx</span> <span class="o">=</span> <span class="mi">0</span>
         <span class="n">nit000</span><span class="o">-</span><span class="mi">1</span> <span class="n">surface</span> <span class="n">forcing</span> <span class="n">fields</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">nit000</span>

<span class="n">zdf_evd</span> <span class="p">:</span> <span class="n">Enhanced</span> <span class="n">Vertical</span> <span class="n">Diffusion</span> <span class="p">(</span><span class="n">evd</span><span class="p">)</span>
<span class="o">~~~~~~~</span>


<span class="n">zdf_mxl</span> <span class="p">:</span> <span class="n">mixed</span> <span class="n">layer</span> <span class="n">depth</span>
<span class="o">~~~~~~~</span>

<span class="n">ssh_nxt</span> <span class="p">:</span> <span class="n">after</span> <span class="n">sea</span> <span class="n">surface</span> <span class="n">height</span>
<span class="o">~~~~~~~</span>

<span class="n">div_hor</span> <span class="p">:</span> <span class="n">horizontal</span> <span class="n">velocity</span> <span class="n">divergence</span>
<span class="o">...</span>
</pre></div>
</div>
<p>This test highlights the next output step that is missing when ln_bdy=T:
``           nit000-1 surface forcing fields set to nit000``. This must be in
an sbc module (<code class="docutils literal"><span class="pre">sbcmod.F90</span></code>). It is not clear why ln_bdy would break that...</p>
<ul class="simple">
<li>James has a bdy_mask.nc file. This looks like top_level in domain_cfg.nc</li>
</ul>
<p>I can make a bdy_mask.nc file (I am not confident which modules to load to get
working on ARCHER so I&#8217;ll do it on livljobs4):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>livljobs$
cd Desktop
scp jelt@login.archer.ac.uk:/work/n01/n01/jelt/LBay/trunk_NEMOGCM_r8395/CONFIG/LBay/EXP00/domain_cfg.nc  .

module load nco/gcc/4.4.2.ncwa
ncks -v top_level,nav_lat,nav_lon  domain_cfg.nc tmp.nc
ncrename -v top_level,bdy_msk tmp.nc
ncwa -a t tmp.nc bdy_mask.nc

livmap$
scp jelt@livljobs4:Desktop/bdy_mask.nc ~/Desktop/.
ferret
use bdy_mask.nc
shade bdy_msk
</pre></div>
</div>
<p>However I notice that the (wet) western boundary is masked out by this mask. Is
that true in James&#8217; mask? Yes it appears so.</p>
<p>Copy new file into EXP directory (having copied it into $INPUTS):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cp $INPUTS/bdy_mask.nc $EXP/.
</pre></div>
</div>
<p>Then edit the namelist_cfg.nc to include this new file:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>!-----------------------------------------------------------------------
&amp;nambdy        !  unstructured open boundaries
!-----------------------------------------------------------------------
    ln_bdy         = .true.              !  Use unstructured open boundaries
    nb_bdy         = 1                    !  number of open boundary sets
    ln_coords_file = .true.               !  =T : read bdy coordinates from file
    cn_coords_file = &#39;coordinates.bdy.nc&#39; !  bdy coordinates files
    ln_mask_file   = .true.              !  =T : read mask from file
    cn_mask_file   = &#39;bdy_mask.nc&#39;
</pre></div>
</div>
<p>This still dies in the same place:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">tail</span> <span class="n">ocean</span><span class="o">.</span><span class="n">output</span>
<span class="o">...</span>
<span class="n">M4</span>    <span class="o">-</span><span class="mf">25.1935276193127</span>        <span class="mf">1.04385624018260</span>        <span class="mf">16.4795866457279</span>
 <span class="mf">2.810378051513493E-004</span>
 <span class="n">usr_sbc</span> <span class="p">:</span> <span class="n">WAD_TEST_CASES</span> <span class="n">case</span><span class="p">:</span> <span class="n">NO</span> <span class="n">surface</span> <span class="n">forcing</span>
 <span class="o">~~~~~~~~~~~</span>   <span class="n">utau</span> <span class="o">=</span> <span class="n">vtau</span> <span class="o">=</span> <span class="n">taum</span> <span class="o">=</span> <span class="n">wndm</span> <span class="o">=</span> <span class="n">qns</span> <span class="o">=</span> <span class="n">qsr</span> <span class="o">=</span> <span class="n">emp</span> <span class="o">=</span> <span class="n">sfx</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
<p>Inspection of <code class="docutils literal"><span class="pre">sbcmod.F90</span></code> shows that thing might be different if it is a restart.
Copy a restart from old code base. Update namelist_cfg for a restart and resubmit</p>
<dl class="docutils">
<dt>::</dt>
<dd>&amp;namrun
nn_date0    =  20000106   !  date at nit_0000 (format yyyymmdd) used if ln_rstart=F or (ln_rstart=T and nn_rstctl=0 or 1)
ln_rstart   = .true.   !  start from rest (F) or from a restart file (T)
cn_ocerst_out   = &#8220;restart_oce_out&#8221;   !  suffix of ocean restart name (output)
nrstdt = 0</dd>
</dl>
<p>It turns out that the restart file is missing e3t and has a wrong variable name for time.
Perhaps easier to create a new restart from a single timestep...?</p>
<p>no even with one timestep there is a seg fault problem.</p>
<p>&#8212;</p>
<p>change initialisation to false for T and S
ln_tsd_init   = .false.   !  Initialisation of ocean T &amp; S with T &amp;S input data (T) or not (F)</p>
<p>Test. Turn off tides:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>!-----------------------------------------------------------------------
&amp;nam_tide      !   tide parameters
!-----------------------------------------------------------------------
   ln_tide     = .false.
   ln_tide_pot = .false.    !  use tidal potential forcing

&amp;nambdy
     nn_dyn2d_dta   =  0  ! was 2
</pre></div>
</div>
<p>Didn&#8217;t change the simulation crash point.</p>
<p>Change rimwidth. It is different in the boundary files to namelist_cfg:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>&amp;nambdy
nn_rimwidth   = 9                    !  width of the relaxation zone
</pre></div>
</div>
<p>(though the bdy fields, I think, are turned off).</p>
<p>Oh the rimwidth variable matching the boundary files seem to fix the problem. Next turn things back on.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>&amp;nam_tide      !   tide parameters
!-----------------------------------------------------------------------
   ln_tide     = .true.
   ln_tide_pot = .true.

&amp;nambdy        !  unstructured open boundaries
   nn_dyn2d_dta   =  1                   !  = 0, bdy data are equal to the initial state
</pre></div>
</div>
<p>This runs but blows up in momentum. Try nn_dyn2d_dta = 2 (like James)
Still blows up.</p>
<p>Try tiny time step  rn_rdt=5. No.</p>
<p>Try nn_dyn_dta = 3. Stabilize with boundary velocities? No</p>
<p>Update bottom friction to match old LBay run (rather than James&#8217; E-Africa run).
THis means changing to nonlinear friction, with a coeff 2.5E-3, log layer and
bottom roughness as follows</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>!-----------------------------------------------------------------------
&amp;nambfr        !   bottom friction
!-----------------------------------------------------------------------
   nn_bfr      =    2      !  type of bottom friction :   = 0 : free slip,  = 1 : linear friction
                           !                              = 2 : nonlinear friction
   rn_bfri2    =    2.5e-3 !  bottom drag coefficient (non linear case)
   rn_bfeb2    =    0.0e0  !  bottom turbulent kinetic energy background  (m2/s2)
   ln_loglayer =    .true. !  loglayer bottom friction (only effect when nn_bfr = 2)
   rn_bfrz0    =    0.003  !  bottom roughness (only effect when ln_loglayer = .true.)
/
</pre></div>
</div>
<p>I also changed the rn_bfeb2 = 2.5e-3 to zero. This would depend on the tke scheme.
Though I don&#8217;t have an idea of what it should be.</p>
<p>Turn off time splitting: ln_bt_nn_auto=.false.,
I think this has moved to a new namelist group &amp;namdyn_spg
Instead turn it off there: ln_bt_auto    = .false.</p>
<p>This makes the run go further. 9 time steps...
Try and manually fix barotropic time step scale. nn_baro=1 (not 30)
This blew up in 5 steps. Revert to nn_baro=30</p>
<p>Switch bilaplacian to laplacian to see if it suddenly works</p>
<p>It works better - 19 steps.</p>
<p>Output every 3 steps and inspect. Didn&#8217;t output.</p>
<p>Try and use ramp_tide to ramp up tides over 1 day.
(checked that rdttideramp corresponds to the number of ramping days.)</p>
<p><strong>It worked!!</strong> 1 day in 40s. Extend to 5 days to run in 5 mins</p>
<p>Switch from Laplacian to Bilapacian diffusion for momentum.</p>
<p>No motion
try n_dyn2d_dta   =  2</p>
<p>Take that boundary mask off: ln_mask_file   = .false.
Didn&#8217;t help.</p>
<p>Perhaps it is an issue with the XML files. Define a shortcut:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">EEXP</span><span class="o">=/</span><span class="n">work</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">jelt</span><span class="o">/</span><span class="n">ACCORD</span><span class="o">/</span><span class="n">trunk_NEMOGCM_r8395</span><span class="o">/</span><span class="n">CONFIG</span><span class="o">/</span><span class="n">ACCORD</span><span class="o">/</span><span class="n">EXP_EAFRICA</span>
</pre></div>
</div>
<p>Hmm couldn&#8217;t spot any differences wih the E-Africa XML files - they are identical</p>
<p>Try the tideramp = 0.5</p>
<p>No joy.
Try a restart.
Bad filename. Check and try again.</p>
<p>Take off the tideramp and it blows up (this is probably not to do with the restart)</p>
<p>There is a variable nb_harmo=0 in the ocean.output. It is not being defined properly.</p>
<p>Tried and changed the frequency of the boundary data: e..g bn_ssh      = &#8216;LBay_bt_bdyT&#8217;, -1   (was 24)</p>
<p>This blows up again. On the first time step.</p>
<p>It looks like the ramp is too severe. If it blows up in 19 steps = 19mins, with
a 1 day ramp. Maybe a 10 ramp would be better.</p>
<p>Do a cold start. With a 10 sim. (ramp can not exceed simulation time)
Signal dies out within a day. (Min SSS&#8211;&gt; 100)</p>
<p>Switch off both laplacian and bilaplacian diffusion. Output info every hr:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>ln_dynldf_lap =  .false.    !    laplacian operator
ln_dynldf_blp =  .false.    !  bilaplacian operator
nn_write    =   24
</pre></div>
</div>
<p>Dies fast. Misinterpreted how the ramp worked. Never had a non-zero simulation with
the ramp. Make it smaller not larger: ``   rdttideramp =    1.     ``</p>
<p>SSH blows up:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">==&gt;&gt;</span> <span class="n">time</span><span class="o">-</span><span class="n">step</span><span class="o">=</span>            <span class="mi">1</span>  <span class="n">ssh</span> <span class="nb">max</span><span class="p">:</span>  <span class="mf">1.311225785606566E-004</span>
<span class="o">==&gt;&gt;</span> <span class="n">time</span><span class="o">-</span><span class="n">step</span><span class="o">=</span>           <span class="mi">61</span>  <span class="nb">abs</span><span class="p">(</span><span class="n">U</span><span class="p">)</span> <span class="nb">max</span><span class="p">:</span>   <span class="mf">9.365770301892096E-002</span>
<span class="o">==&gt;&gt;</span> <span class="n">time</span><span class="o">-</span><span class="n">step</span><span class="o">=</span>           <span class="mi">61</span>  <span class="n">SSS</span> <span class="nb">min</span><span class="p">:</span>   <span class="mf">36.8418750679304</span>
<span class="o">==&gt;&gt;</span> <span class="n">time</span><span class="o">-</span><span class="n">step</span><span class="o">=</span>           <span class="mi">61</span>  <span class="n">ssh</span> <span class="nb">max</span><span class="p">:</span>  <span class="mf">6.350050976376775E-002</span>
<span class="o">==&gt;&gt;</span> <span class="n">time</span><span class="o">-</span><span class="n">step</span><span class="o">=</span>          <span class="mi">121</span>  <span class="nb">abs</span><span class="p">(</span><span class="n">U</span><span class="p">)</span> <span class="nb">max</span><span class="p">:</span>   <span class="mf">0.120795267289029</span>
<span class="o">==&gt;&gt;</span> <span class="n">time</span><span class="o">-</span><span class="n">step</span><span class="o">=</span>          <span class="mi">121</span>  <span class="n">SSS</span> <span class="nb">min</span><span class="p">:</span>   <span class="mf">36.8414750346018</span>
<span class="o">==&gt;&gt;</span> <span class="n">time</span><span class="o">-</span><span class="n">step</span><span class="o">=</span>          <span class="mi">121</span>  <span class="n">ssh</span> <span class="nb">max</span><span class="p">:</span>  <span class="mf">0.113158707022428</span>

<span class="o">===&gt;&gt;&gt;</span> <span class="p">:</span> <span class="n">E</span> <span class="n">R</span> <span class="n">R</span> <span class="n">O</span> <span class="n">R</span>
       <span class="o">===========</span>

<span class="n">stp_ctl</span> <span class="p">:</span> <span class="n">the</span> <span class="n">ssh</span> <span class="ow">is</span> <span class="n">larger</span> <span class="n">than</span> <span class="mi">10</span><span class="n">m</span>
<span class="o">=======</span>
<span class="n">kt</span><span class="o">=</span>   <span class="mi">154</span> <span class="nb">max</span> <span class="n">ssh</span><span class="p">:</span>    <span class="n">Infinity</span><span class="p">,</span> <span class="n">i</span> <span class="n">j</span><span class="p">:</span>    <span class="mi">32</span>   <span class="mi">90</span>
</pre></div>
</div>
<p>Reduce harmonic to just M2. Blows up in SSH in the same way.</p>
<p>Reduce the timestep rn_rdt=6.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">==&gt;&gt;</span> <span class="n">time</span><span class="o">-</span><span class="n">step</span><span class="o">=</span>         <span class="mi">1321</span>  <span class="n">ssh</span> <span class="nb">max</span><span class="p">:</span>  <span class="mf">0.111035814265442</span>
<span class="o">==&gt;&gt;</span> <span class="n">time</span><span class="o">-</span><span class="n">step</span><span class="o">=</span>         <span class="mi">1381</span>  <span class="nb">abs</span><span class="p">(</span><span class="n">U</span><span class="p">)</span> <span class="nb">max</span><span class="p">:</span>   <span class="mf">0.117910378601910</span>
<span class="o">==&gt;&gt;</span> <span class="n">time</span><span class="o">-</span><span class="n">step</span><span class="o">=</span>         <span class="mi">1381</span>  <span class="n">SSS</span> <span class="nb">min</span><span class="p">:</span>   <span class="mf">36.8413812872391</span>
<span class="o">==&gt;&gt;</span> <span class="n">time</span><span class="o">-</span><span class="n">step</span><span class="o">=</span>         <span class="mi">1381</span>  <span class="n">ssh</span> <span class="nb">max</span><span class="p">:</span>  <span class="mf">0.112485247560570</span>
<span class="o">==&gt;&gt;</span> <span class="n">time</span><span class="o">-</span><span class="n">step</span><span class="o">=</span>         <span class="mi">1441</span>  <span class="nb">abs</span><span class="p">(</span><span class="n">U</span><span class="p">)</span> <span class="nb">max</span><span class="p">:</span>   <span class="mf">0.116803563870784</span>
<span class="o">==&gt;&gt;</span> <span class="n">time</span><span class="o">-</span><span class="n">step</span><span class="o">=</span>         <span class="mi">1441</span>  <span class="n">SSS</span> <span class="nb">min</span><span class="p">:</span>   <span class="mf">36.8413491215503</span>
<span class="o">==&gt;&gt;</span> <span class="n">time</span><span class="o">-</span><span class="n">step</span><span class="o">=</span>         <span class="mi">1441</span>  <span class="n">ssh</span> <span class="nb">max</span><span class="p">:</span>  <span class="mf">0.113826565377745</span>

<span class="o">===&gt;&gt;&gt;</span> <span class="p">:</span> <span class="n">E</span> <span class="n">R</span> <span class="n">R</span> <span class="n">O</span> <span class="n">R</span>
       <span class="o">===========</span>

<span class="n">stpctl</span><span class="p">:</span> <span class="n">the</span> <span class="n">zonal</span> <span class="n">velocity</span> <span class="ow">is</span> <span class="n">larger</span> <span class="n">than</span> <span class="mi">20</span> <span class="n">m</span><span class="o">/</span><span class="n">s</span>
<span class="o">======</span>
<span class="n">kt</span><span class="o">=</span>  <span class="mi">1489</span> <span class="nb">max</span> <span class="nb">abs</span><span class="p">(</span><span class="n">U</span><span class="p">):</span>   <span class="mf">22.29</span>    <span class="p">,</span> <span class="n">i</span> <span class="n">j</span> <span class="n">k</span><span class="p">:</span>    <span class="mi">32</span>  <span class="mi">104</span>   <span class="mi">21</span>
</pre></div>
</div>
<p>Ran for 2.5 hours instead of about 2hrs.</p>
<p>Need to look at some fields. Output initial conditions and evolving fields
Check CFL. Grid is about 1.3km x 0.7km
Therefore a 60s timestep 700m/60s &gt; 10m/s &gt;&gt; u. Is OK
cp = sqrt(g.h) = sqrt(10*50) = 22 m/s.</p>
<p>Inspection of the domain_cfg.nc file shows that the e1x and e2x variables are wrong.
See: cd /Users/jeff/GitLab/NEMO-RELOC/docs/source
$ipython
&gt;&gt; run quickplotNEMO</p>
<p><strong>PENDING</strong></p>
</div>
</div>
<div class="section" id="rebuild-the-output-and-inspect">
<h3>Rebuild the output and inspect<a class="headerlink" href="#rebuild-the-output-and-inspect" title="Permalink to this headline">¶</a></h3>
<p>Rebuild the SSH files using old tools:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>export WDIR=/work/n01/n01/jelt/LBay/
export TDIR=$WDIR/dev_r4621_NOC4_BDY_VERT_INTERP/NEMOGCM/TOOLS

$TDIR/REBUILD_NEMO/rebuild_nemo -t 24 LBay_1h_20000102_20000106_grid_T 5
$TDIR/REBUILD_NEMO/rebuild_nemo -t 24 LBay_1h_20000102_20000106_grid_U 5
$TDIR/REBUILD_NEMO/rebuild_nemo -t 24 LBay_1h_20000102_20000106_grid_V 5
$TDIR/REBUILD_NEMO/rebuild_nemo -t 24 LBay_1h_20000102_20000106_grid_W 5
</pre></div>
</div>
<p>Should remove individual processor files once the build is verified:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>rm LBay_1h_20000102_20000106_grid_?_*nc
</pre></div>
</div>
<p>Inspect locally e.g.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">scp</span> <span class="n">jelt</span><span class="nd">@login</span><span class="o">.</span><span class="n">archer</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">uk</span><span class="p">:</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">jelt</span><span class="o">/</span><span class="n">LBay</span><span class="o">/</span><span class="n">dev_r4621_NOC4_BDY_VERT_INTERP</span><span class="o">/</span><span class="n">NEMOGCM</span><span class="o">/</span><span class="n">CONFIG</span><span class="o">/</span><span class="n">LBay</span><span class="o">/</span><span class="n">EXP00</span><span class="o">/</span><span class="n">LBay_1h_20000102_20000106_grid_T</span><span class="o">.</span><span class="n">nc</span> <span class="o">.</span>

<span class="n">ferret</span>
<span class="n">use</span> <span class="n">LBay_1h_20000102_20000106_grid_T</span><span class="o">.</span><span class="n">nc</span>
<span class="n">plot</span> <span class="o">/</span><span class="n">i</span><span class="o">=</span><span class="mi">25</span><span class="o">/</span><span class="n">j</span><span class="o">=</span><span class="mi">70</span> <span class="n">SOSSHEIG</span>
</pre></div>
</div>
<p><strong>Is there a semi-diurnal SSH signal?</strong></p>
<p>&#8212;</p>
<p>&#8212;</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>TO DO</strong> another time / for Solent config</p>
<ul class="simple">
<li>Change namelist to include tidal harmonic analysis:</li>
</ul>
<p>!&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8211;
&amp;nam_diaharm   !   Harmonic analysis of tidal constituents (&#8216;key_diaharm&#8217;)
!&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8211;</p>
<blockquote>
<div>nit000_han = 1440         ! First time step used for harmonic analysis
nitend_han = 14400        ! Last time step used for harmonic analysis
nstep_han  = 15        ! Time step frequency for harmonic analysis
tname(1)     =   &#8216;O1&#8217;  !  name of constituent
tname(2)     =   &#8216;P1&#8217;
tname(3)     =   &#8216;K1&#8217;
tname(4)     =   &#8216;N2&#8217;
tname(5)     =   &#8216;M2&#8217;
tname(6)     =   &#8216;S2&#8217;
tname(7)     =   &#8216;K2&#8217;
tname(8)     =   &#8216;Q1&#8217;
tname(9)     =   &#8216;M4&#8217;</div></blockquote>
<ul class="last simple">
<li>Harmonise all wet forcing to use AMM60 data.</li>
</ul>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Liverpool Bay 180m NEMO configuration</a><ul>
<li><a class="reference internal" href="#issues-that-arose">Issues that arose</a></li>
<li><a class="reference internal" href="#recipe-notes">Recipe Notes</a></li>
<li><a class="reference internal" href="#collect-essential-files">Collect essential files</a></li>
<li><a class="reference internal" href="#build-tools">Build TOOLS</a><ul>
<li><a class="reference internal" href="#copy-bathymetry-and-coordinates-file">0. Copy bathymetry and coordinates file</a></li>
</ul>
</li>
<li><a class="reference internal" href="#generate-a-domain-configuration-file">3. Generate a domain configuration file</a><ul>
<li><a class="reference internal" href="#generate-initial-conditions">4. Generate initial conditions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#set-up-directory-structure-and-files-in-livljobs4">Set up directory structure and files in livljobs4</a></li>
<li><a class="reference internal" href="#statement-about-external-forcing">Statement about external forcing</a><ul>
<li><a class="reference internal" href="#generate-boundary-conditions-with-nrct-pynemo-create-netcdf-abstraction-wrapper">6. Generate boundary conditions with NRCT/PyNEMO: Create netcdf abstraction wrapper</a></li>
<li><a class="reference internal" href="#a-generate-ncml-file-that-points-to-the-external-data">6a. Generate ncml file that points to the external data</a></li>
<li><a class="reference internal" href="#b-generate-the-namelist-bdy-file-for-pynemo-nrct">6b. Generate the namelist.bdy file for PyNEMO / NRCT</a></li>
<li><a class="reference internal" href="#run-pynemo-nrct-to-generate-boundary-conditions">Run PyNEMO / NRCT to generate boundary conditions</a></li>
<li><a class="reference internal" href="#id3">6. Generate boundary conditions with NRCT/PyNEMO: Create netcdf abstraction wrapper</a></li>
<li><a class="reference internal" href="#a-generate-ncml-files">6a. Generate ncml files</a></li>
<li><a class="reference internal" href="#nna-inputs-src-ncml">NNA_inputs_src.ncml</a></li>
<li><a class="reference internal" href="#id4">6b. Generate the namelist.bdy file for PyNEMO / NRCT</a></li>
<li><a class="reference internal" href="#generate-boundary-conditions-with-pynemo-run-pynemo">7. Generate boundary conditions with PyNEMO: Run PyNEMO</a></li>
<li><a class="reference internal" href="#namelist-bdy-nna">namelist.bdy_NNA</a></li>
<li><a class="reference internal" href="#run-the-configuration-on-archer-turn-on-the-tides">8. Run the configuration ON ARCHER. Turn on the tides</a><ul>
<li><a class="reference internal" href="#resubmit">Resubmit</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rebuild-the-output-and-inspect">Rebuild the output and inspect</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/LBay_180m.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, NOC.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
      |
      <a href="_sources/LBay_180m.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>