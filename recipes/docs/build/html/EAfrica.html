<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Setting up a East Africa with NEMO (ORCHESTRA) configuration &#8212; NEMO-RELOC 0.1 documentation</title>
    
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="NEMO-RELOC 0.1 documentation" href="index.html" />
    <link rel="next" title="Build NEMO (ORCHESTRA) trunk @ r8395" href="build_opa_orchestra.html" />
    <link rel="prev" title="Setting up a SW Pacific NEMO v4 configuration" href="SWPacific_archer_livljobs4.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="setting-up-a-east-africa-with-nemo-orchestra-configuration">
<h1>Setting up a East Africa with NEMO (ORCHESTRA) configuration<a class="headerlink" href="#setting-up-a-east-africa-with-nemo-orchestra-configuration" title="Permalink to this headline">¶</a></h1>
<p>URL:: <a class="reference external" href="http://nemo-reloc.readthedocs.io/en/latest/EAfrica.html">http://nemo-reloc.readthedocs.io/en/latest/EAfrica.html</a></p>
<div class="section" id="summary-plan">
<h2>Summary / Plan<a class="headerlink" href="#summary-plan" title="Permalink to this headline">¶</a></h2>
<p>Date :: 4 Oct 2017
Author :: jelt</p>
<ul class="simple">
<li>Replicate James&#8217; /work/n01/n01/jdha/2017/nemo/trunk/NEMOGCM/CONFIG/ODA_E-AFRICA/</li>
</ul>
<p>configuration.</p>
<ul class="simple">
<li>Use ORCHESTRA code, which is near the head of the trunk (&#64; r8395).</li>
<li>Caveat: a number of input files are taken from James&#8217; existing configuration.</li>
</ul>
<p>Though the domain_cfg.nc file was generated from James&#8217; coordinates and bathy files.</p>
</div>
<div class="section" id="recipe-notes">
<h2>Recipe Notes<a class="headerlink" href="#recipe-notes" title="Permalink to this headline">¶</a></h2>
<p>Define working directory, and other useful shortcuts:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>export CONFIG=ACCORD
export WDIR=/work/n01/n01/$USER/$CONFIG
export CDIR=$WDIR/trunk_NEMOGCM_r8395/CONFIG
export TDIR=$WDIR/trunk_NEMOGCM_r8395/TOOLS
export EXP=$CDIR/$CONFIG/EXP_EAFRICA

export JINPUTS=/work/n01/n01/jdha/2017/INPUTS/ODA/E-AFRICA
export JEXP=/work/n01/n01/jdha/2017/nemo/trunk/NEMOGCM/CONFIG/ODA_E-AFRICA/EXP00/
</pre></div>
</div>
<p>#Load modules:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">module</span> <span class="n">swap</span> <span class="n">PrgEnv</span><span class="o">-</span><span class="n">cray</span> <span class="n">PrgEnv</span><span class="o">-</span><span class="n">intel</span>
<span class="n">module</span> <span class="n">load</span> <span class="n">cray</span><span class="o">-</span><span class="n">netcdf</span><span class="o">-</span><span class="n">hdf5parallel</span>
<span class="n">module</span> <span class="n">load</span> <span class="n">cray</span><span class="o">-</span><span class="n">hdf5</span><span class="o">-</span><span class="n">parallel</span>
</pre></div>
</div>
<p>&#8212;</p>
<p>Build XIOS2 &#64; r1080:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cd /work/n01/n01/$USER
svn co -r1080 http://forge.ipsl.jussieu.fr/ioserver/svn/XIOS/trunk xios-2.0_r1080
cd xios-2.0_r1080
#cp ../../LBay/xios-1.0/arch/arch-XC30_ARCHER.* ./arch
cp ../LBay/xios-2.0/arch/arch-XC30_ARCHER* arch/.
</pre></div>
</div>
<p>Implement make command:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">make_xios</span> <span class="o">--</span><span class="n">full</span> <span class="o">--</span><span class="n">prod</span> <span class="o">--</span><span class="n">arch</span> <span class="n">XC30_ARCHER</span> <span class="o">--</span><span class="n">netcdf_lib</span> <span class="n">netcdf4_par</span>
</pre></div>
</div>
<p>Link the xios-2.0_r1080 to a generic XIOS directory name:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>ln -s  /work/n01/n01/$USER/xios-2.0_r108  /work/n01/n01/$USER/XIOS
</pre></div>
</div>
<p>Link xios executable to the EXP directory:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>ln -s  /work/n01/n01/$USER/xios-2.0_r1080/bin/xios_server.exe $EXP/xios_server.exe
</pre></div>
</div>
<p>&#8212;</p>
<p>Build NEMO (ORCHESTRA) trunk &#64; r8395:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cd $WDIR
svn co http://forge.ipsl.jussieu.fr/nemo/svn/trunk/NEMOGCM@8395 trunk_NEMOGCM_r8395
</pre></div>
</div>
<p>Use my XIOS file (see <code class="docutils literal"><span class="pre">%XIOS_HOME</span></code>). Copy from <em>store</em>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cp /work/n01/n01/$USER/ARCH/arch-XC_ARCHER_INTEL.fcm $CDIR/../ARCH/.
</pre></div>
</div>
<p>Make a new config directory structure:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cd $CDIR
./makenemo -n $CONFIG -m XC_ARCHER_INTEL -j 10 clean
</pre></div>
</div>
<p>Edit the CPP flags:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>vi $CONFIG/cpp_$CONFIG.fcm

bld::tool::fppkeys key_zdfgls        \
                 key_diaharm       \
                 key_mpp_mpi       \
                 key_iomput        \
                 key_nosignedzero
</pre></div>
</div>
<p>Build opa:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>./makenemo -n $CONFIG -m XC_ARCHER_INTEL -j 10
</pre></div>
</div>
<p><strong>It compiles!!</strong></p>
<p>&#8212;</p>
<p>Copy:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>ln -s $JINPUTS/R12/domain_cfg_R12.nc $EXP/domain_cfg.nc
</pre></div>
</div>
<p><strong>Or</strong> build or copy a domain_cfg.nc file:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cd $TDIR/DOMAINcfg
</pre></div>
</div>
<p>Copy in the coordinates and bathymetry files:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cp $JINPUTS/R12/coordinates_E-AFRICA_R12.nc $TDIR/DOMAINcfg/coordinates.nc
cp $JINPUTS/R12/bathymetry_E-AFRICA_R12.nc  $TDIR/DOMAINcfg/bathy_meter.nc
</pre></div>
</div>
<p>Edit namelist_cfg (v3.6 version) for this configuration:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>vi namelist_cfg

!-----------------------------------------------------------------------
&amp;namcfg        !   parameters of the configuration
!-----------------------------------------------------------------------
   !
   ln_e3_dep   = .true.    ! =T : e3=dk[depth] in discret sens.
   !                       !      ===&gt;&gt;&gt; will become the only possibility in v4.0
   !                       ! =F : e3 analytical derivative of depth function
   !                       !      only there for backward compatibility test with v3.6
   !                       !
   cp_cfg      =  &quot;orca&quot;   !  name of the configuration
   jp_cfg      =       2   !  resolution of the configuration
   jpidta      =     303   !  1st lateral dimension ( &gt;= jpi )
   jpjdta      =     517   !  2nd    &quot;         &quot;    ( &gt;= jpj )
   jpkdta      =      75   !  number of levels      ( &gt;= jpk )
   jpiglo      =     303   !  1st dimension of global domain --&gt; i =jpidta
   jpjglo      =     517   !  2nd    -                  -    --&gt; j  =jpjdta
   jpizoom     =       1   !  left bottom (i,j) indices of the zoom
   jpjzoom     =       1   !  in data domain indices
   jperio      =       0   !  lateral cond. type (between 0 and 6)
/
!-----------------------------------------------------------------------
&amp;namzgr        !   vertical coordinate
!-----------------------------------------------------------------------
   ln_zps      = .true.    !  z-coordinate - partial steps
   ln_linssh   = .false.    !  linear free surface
/
</pre></div>
</div>
<dl class="docutils">
<dt>Submit the run script. Use tools compiled</dt>
<dd><p class="first">already <code class="docutils literal"><span class="pre">/work/n01/n01/jelt/LBay/trunk_NEMOGCM_r8395/TOOLS</span></code>:</p>
<div class="last highlight-default"><div class="highlight"><pre><span></span><span class="n">qsub</span> <span class="o">-</span><span class="n">q</span> <span class="n">short</span> <span class="n">rs</span>
</pre></div>
</div>
</dd>
</dl>
<p>Copy / link new file into the EXP directory:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>ln -s $TDIR/DOMAINcfg/domain_cfg.nc $EXP/domain_cfg.nc
</pre></div>
</div>
<p>&#8212;</p>
<p>Copy other INPUT stuff from James&#8217; simulation:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>mkdir $EXP

cp $JEXP/namelist_cfg_R12 $EXP/namelist_cfg   # copy namelist_cfg
ln -s $JEXP/../../SHARED/namelist_ref $EXP/.
</pre></div>
</div>
<p>Edit namelist for self determining processors assignment:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>vi $EXP/namelist_cfg
...
jpni        =  -20       !  jpni   number of processors following i (set automatically if &lt; 1)
jpnj        =  -40    !  jpnj   number of processors following j (set automatically if &lt; 1)
jpnij       =  -550    !  jpnij  number of local domains (set automatically if &lt; 1)
</pre></div>
</div>
<p>Link other setup and forcing files:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>ln -s $JINPUTS/R12/coordinates_E-AFRICA_R12.bdy.nc $EXP/coordinates.bdy.nc
ln -s $JINPUTS/R12/bdy_mask_E-AFRICA_R12.nc $EXP/bdy_mask.nc
ln -s $JINPUTS/R12/TIDES $EXP/TIDES
</pre></div>
</div>
<p>Copy in <code class="docutils literal"><span class="pre">*.xml</span></code> files:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>rm $EXP/*xml
ln -s $JEXP/context_nemo.xml $EXP/.
ln -s $JEXP/field_def_nemo-opa.xml $EXP/.
ln -s $JEXP/iodef.xml $EXP/.
ln -s $JEXP/../../AMM12/EXP00/domain_def_nemo.xml $EXP/.

cp $JEXP/../../AMM12/EXP00/file_def_nemo-opa.xml $EXP/.
</pre></div>
</div>
<p>Add in a couple of lines to file_def_nemo-opa.xml to output tides
(This seems to be the file to edit):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>vi file_def_nemo-opa.xml
...
&lt;file_group id=&quot;1d&quot; output_freq=&quot;1d&quot;  output_level=&quot;10&quot; enabled=&quot;.TRUE.&quot;&gt; &lt;!-- 1d files --&gt;

&lt;file id=&quot;file8&quot; name_suffix=&quot;_Tides&quot; description=&quot;Tidal harmonics&quot; &gt;
  &lt;field field_ref=&quot;e3t&quot; /&gt;
  &lt;field field_ref=&quot;M2x&quot;          long_name=&quot;M2 Elevation harmonic real part &quot;                             unit=&quot;m&quot;        /&gt;
  &lt;field field_ref=&quot;M2y&quot;          long_name=&quot;M2 Elevation harmonic imaginary part &quot;                             unit=&quot;m&quot;        /&gt;
&lt;/file&gt;
</pre></div>
</div>
<p>Edit/create the runscript:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>vi runscript

#!/bin/bash
# ---------------------------
#===============================================================
# CLUSTER BITS
#===============================================================
#PBS -N EA_R12
#PBS -l select=5
#PBS -l walltime=00:20:00
#PBS -A n01-NOCL
#PBS -j oe
#PBS -r n
# mail alert at (b)eginning, (e)nd and (a)bortion of execution
#PBS -m bea
#PBS -M jelt@noc.ac.uk

module swap PrgEnv-cray PrgEnv-intel
module load cray-netcdf-hdf5parallel
module load cray-hdf5-parallel

export PBS_O_WORKDIR=$(readlink -f $PBS_O_WORKDIR)
# Change to the direcotry that the job was submitted from
cd $PBS_O_WORKDIR


# Set the number of threads to 1
#   This prevents any system libraries from automatically
#   using threading.
export OMP_NUM_THREADS=1
# Change to the directory that the job was submitted from
ulimit -s unlimited
ulimit -c unlimited

export NEMOproc=96 #550
export XIOSproc=1

#===============================================================
# LAUNCH JOB
#===============================================================
echo `date` : Launch Job
aprun -b -n 5 -N 5 ./xios_server.exe : -n $NEMOproc -N 24 ./opa
exit
</pre></div>
</div>
<p>Fix the links with the xios (if not already done) and opa exectutables:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>ln -s /work/n01/n01/jelt/XIOS/bin/xios_server.exe $EXP/.
ln -s $CDIR/$CONFIG/BLD/bin/nemo.exe $EXP/opa
</pre></div>
</div>
<p>Perhaps check that the <code class="docutils literal"><span class="pre">ln_tide=.true.</span></code> and <code class="docutils literal"><span class="pre">nit000_han</span></code> and  <code class="docutils literal"><span class="pre">`nitend_han</span></code>
variables are appropriate:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>vi namelist_cfg
...
!-----------------------------------------------------------------------
&amp;nam_diaharm   !   Harmonic analysis of tidal constituents               (&quot;key_diaharm&quot;)
!-----------------------------------------------------------------------
    nit000_han = 1441         ! First time step used for harmonic analysis
    nitend_han = 2880       ! Last time step used for harmonic analysis
    nstep_han  = 5        ! Time step frequency for harmonic analysis
    tname(1)   = &#39;M2&#39;      ! Name of tidal constituents
    tname(2)   = &#39;S2&#39;      ! Name of tidal constituents
    tname(3)   = &#39;K1&#39;      ! Name of tidal constituents
    tname(4)   = &#39;O1&#39;      ! Name of tidal constituents
/
</pre></div>
</div>
<p>Submit:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cd $EXP
qsub -q short runscript
#qsub runscript
</pre></div>
</div>
<p><strong>It runs and outputs lots of stuff including harmonics</strong></p>
<p>&#8212;</p>
</div>
<div class="section" id="rebuild-the-files-and-inspect-locally">
<h2>Rebuild the files and inspect locally<a class="headerlink" href="#rebuild-the-files-and-inspect-locally" title="Permalink to this headline">¶</a></h2>
<p>Rebuild the SSH files (use an already compiled TOOLS/rebuild_nemo):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>export WDIR=/work/n01/n01/jelt/LBay/
export TDIR=$WDIR/dev_r4621_NOC4_BDY_VERT_INTERP/NEMOGCM/TOOLS

$TDIR/REBUILD_NEMO/rebuild_nemo -t 24 EA_v3_1d_20010101_20010112_grid_T 5
</pre></div>
</div>
<p>Should remove individual processor files once the build is verified:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">rm</span> <span class="n">EA_v3_1d_20010101_20010112_grid_T_</span><span class="o">*.</span><span class="n">nc</span>
</pre></div>
</div>
<p>Inspect locally e.g.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>scp jelt@login.archer.ac.uk:$EXP/EA_v3_1d_20010101_20010112_grid_T.nc .
#scp jelt@login.archer.ac.uk:/work/n01/n01/jelt/ACCORD/trunk_NEMOGCM_r8395/CONFIG/ACCORD/EXP_EAFRICA/EA_v3_1d_20010101_20010112_grid_T.nc .

ferret
use EA_v3_1d_20010101_20010112_grid_T.nc
plot /i=25/j=70 SOSSHEIG
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Setting up a East Africa with NEMO (ORCHESTRA) configuration</a><ul>
<li><a class="reference internal" href="#summary-plan">Summary / Plan</a></li>
<li><a class="reference internal" href="#recipe-notes">Recipe Notes</a></li>
<li><a class="reference internal" href="#rebuild-the-files-and-inspect-locally">Rebuild the files and inspect locally</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="SWPacific_archer_livljobs4.html" title="previous chapter">Setting up a SW Pacific NEMO v4 configuration</a></li>
      <li>Next: <a href="build_opa_orchestra.html" title="next chapter">Build NEMO (ORCHESTRA) trunk &#64; r8395</a></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/EAfrica.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, NOC.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
      |
      <a href="_sources/EAfrica.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>