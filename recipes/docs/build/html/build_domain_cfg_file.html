<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Generate a domain configuration file &#8212; NEMO-RELOC 0.1 documentation</title>
    
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="NEMO-RELOC 0.1 documentation" href="index.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="generate-a-domain-configuration-file">
<h1>Generate a domain configuration file<a class="headerlink" href="#generate-a-domain-configuration-file" title="Permalink to this headline">¶</a></h1>
<p>The general idea is that you have to copy the <code class="docutils literal"><span class="pre">namelist_cfg</span></code> file into the <code class="docutils literal"><span class="pre">DOMAINcfg</span></code>
directory along with all the inputs files that would have previously been needed
get v3.6 running. The reason being that all the non-time stepping stuff, like
grid generating, has been abstracted from the core OPA code and is now done as
a pre-processing step, and output into an important file <code class="docutils literal"><span class="pre">domain_cfg.nc</span></code>.</p>
<p>Copy essential files into DOMAINcfg directory:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>ln -s $INPUTS/coordinates.nc $TDIR/DOMAINcfg/.
ln -s $INPUTS/bathy_meter.nc $TDIR/DOMAINcfg/.
</pre></div>
</div>
<p>Edit the template namelist_cfg with only the essenetial domain building stuff.
For example:</p>
<blockquote>
<div><ul class="simple">
<li>For hybrid z-s coordinates: <a href="#id1"><span class="problematic" id="id2">`SEAsia_DOMAINcfg_namelist_cfg`_</span></a></li>
<li>For z-partial step coordinates: <a href="#id3"><span class="problematic" id="id4">`SWPacific_DOMAINcfg_namelist_cfg`_</span></a></li>
<li>For stretched sigma coordinates: <a href="#id5"><span class="problematic" id="id6">`GThai_DOMAINcfg_namelist_cfg`_</span></a> (?Jason to edit coords etc)</li>
</ul>
</div></blockquote>
<dl class="docutils">
<dt>For any vertical coordinate option, edit the size of the new domain. Get the</dt>
<dd><p class="first">size from <code class="docutils literal"><span class="pre">ncdump</span> <span class="pre">-h</span> <span class="pre">bathy_meter.nc</span></code> (E.g. for SE Asia 1/12 degree, with 75 levels):</p>
<div class="last highlight-default"><div class="highlight"><pre><span></span>cd $TDIR/DOMAINcfg
vi namelist_cfg

/
!-----------------------------------------------------------------------
&amp;namcfg        !   parameters of the configuration
!-----------------------------------------------------------------------
   ...
   jpidta      =     684   !  1st lateral dimension ( &gt;= jpi )
   jpjdta      =     554   !  2nd    &quot;         &quot;    ( &gt;= jpj )
   jpkdta      =      75   !  number of levels      ( &gt;= jpk )
   jpiglo      =     684   !  1st dimension of global domain --&gt; i =jpidta
   jpjglo      =     554   !  2nd    -                  -    --&gt; j  =jpjdta
   ...
</pre></div>
</div>
</dd>
</dl>
<p>In the following special choices are made according to the choice of vertical coordinates</p>
</div>
<div class="section" id="hybrid-z-s-coordinates">
<h1>Hybrid z-s coordinates<a class="headerlink" href="#hybrid-z-s-coordinates" title="Permalink to this headline">¶</a></h1>
<p>Vertical coordinates options (e.g. <a href="#id7"><span class="problematic" id="id8">`SEAsia_DOMAINcfg_namelist_cfg`_</span></a>):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>vi namelist_cfg
...
/
!-----------------------------------------------------------------------
&amp;namzgr        !   vertical coordinate
!-----------------------------------------------------------------------
   ln_zco      = .false.   !  z-coordinate - full    steps   (T/F)      (&quot;key_zco&quot; may also be defined)
   ln_zps      = .false.    !  z-coordinate - partial steps
   ln_sco      = .true.   !  s- or hybrid z-s-coordinate    (T/F)
   ln_isfcav   = .false.   !  ice shelf cavity
/
!-----------------------------------------------------------------------
&amp;namzgr_sco    !   s-coordinate or hybrid z-s-coordinate                (default F)
!-----------------------------------------------------------------------
   ln_s_sh94   = .true.    !  Song &amp; Haidvogel 1994 hybrid S-sigma   (T)|
   ln_s_sf12   = .false.   !  Siddorn &amp; Furner 2012 hybrid S-z-sigma (T)| if both are false the NEMO tanh stretching is applied
   rn_sbot_min =   10.0    !  minimum depth of s-bottom surface (&gt;0) (m)
   rn_sbot_max = 6000.0    !  maximum depth of s-bottom surface (= ocean depth) (&gt;0) (m)
   rn_hc       =  39.0     !  critical depth for transition to stretched coordinates
                           !!!!!!!  Envelop bathymetry
   rn_rmax     =    0.05   !  maximum cut-off r-value allowed (0&lt;r_max&lt;1)
                           !!!!!!!  hybrid z-s parameters
   nn_sig_lev = 39
   ln_s_melange = .true.
 /
 !-----------------------------------------------------------------------
 &amp;namdom        !   space and time domain (bathymetry, mesh, timestep)
 !-----------------------------------------------------------------------
    nn_closea   =    1      !  remove (=0) or keep (=1) closed seas and lakes (ORCA)
    nn_msh      =    0      !  create (=1) a mesh file or not (=0)
    rn_hmin     =   -10.    !  min depth of the ocean (&gt;0) or min number of ocean level (&lt;0)
    rn_isfhmin  =    1.00   !  treshold (m) to discriminate grounding ice to floating ice
    rn_e3zps_min=   25.     !  partial step thickness is set larger than the minimum of
    rn_e3zps_rat=    0.2    !  rn_e3zps_min and rn_e3zps_rat*e3t, with 0&lt;rn_e3zps_rat&lt;1
    rn_rdt      =   300.    !  time step for the dynamics (and tracer if nacc=0)   ==&gt; 5760
    jphgr_msh   =       0               !  type of horizontal mesh
                                        !  = 0 curvilinear coordinate on the sphere read in coordinate.nc
                                        !  = 1 geographical mesh on the sphere with regular grid-spacing
                                        !  = 2 f-plane with regular grid-spacing
                                        !  = 3 beta-plane with regular grid-spacing
                                        !  = 4 Mercator grid with T/U point at the equator
    ppglam0     =  999999.0             !  longitude of first raw and column T-point (jphgr_msh = 1)
    ppgphi0     =  999999.0             ! latitude  of first raw and column T-point (jphgr_msh = 1)
    ppe1_deg    =  999999.0             !  zonal      grid-spacing (degrees)
    ppe2_deg    =  999999.0             !  meridional grid-spacing (degrees)
    ppe1_m      =  999999.0             !  zonal      grid-spacing (degrees)
    ppe2_m      =  999999.0             !  meridional grid-spacing (degrees)
    ppsur       =    -3958.951371276829 !  ORCA r4, r2 and r05 coefficients
    ppa0        =     103.9530096000000 ! (default coefficients)
    ppa1        =     2.415951269000000 !
    ppkth       =     15.35101370000000 !
    ppacr       =        7.0            !
    ppdzmin     =  999999.              !  Minimum vertical spacing
    pphmax      =  999999.              !  Maximum depth
    ldbletanh   =    .TRUE.             !  Use/do not use double tanf function for vertical coordinates
    ppa2        =      100.760928500000 !  Double tanh function parameters
    ppkth2      =       48.029893720000 !
    ppacr2      =       13.000000000000 !
    /
</pre></div>
</div>
<p>The new parameter sig_lev = 39 levels sets the merge level (counting from the
top down) at which point sigma transitions to z-partial step.
This should be set equal to rn_hc, which is the depth (m) for transition</p>
<blockquote>
<div>to from stretch (deeper) to pure (shallower) sigma coordinates.</div></blockquote>
<p>Check number of levels <code class="docutils literal"><span class="pre">jpkdta</span></code> exceeds <code class="docutils literal"><span class="pre">nn_sig_lev</span></code>.</p>
<p>The transition between zps and sco is here at 400m.</p>
<dl class="docutils">
<dt>Therefore for bathymetry &gt;= 39m the top layer with be 1m thick. (For water</dt>
<dd>shallower than 39m it will be proportionately less.)</dd>
</dl>
<p>The <code class="docutils literal"><span class="pre">namdom</span></code> are specified here to ensure the match the ORCA grid. Though are
probably not strickly necessary.</p>
<p>To get the new option to work I have copied a file into <code class="docutils literal"><span class="pre">src</span></code>. This will
eventually be in the trunk but for now:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cp /work/n01/n01/jdha/2017/nemo/trunk/NEMOGCM/TOOLS/DOMAINcfg/src/domzgr.f90.jelt $TDIR/DOMAINcfg/src/domzgr.f90
</pre></div>
</div>
<p>Recompile the tool e.g.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cd $TDIR
./maketools -m XC_ARCHER_INTEL_XIOS1 -n DOMAINcfg clean
./maketools -m XC_ARCHER_INTEL_XIOS1 -n DOMAINcfg
</pre></div>
</div>
</div>
<div class="section" id="z-partial-step-coordinates">
<h1>z-partial step coordinates<a class="headerlink" href="#z-partial-step-coordinates" title="Permalink to this headline">¶</a></h1>
<p>Vertical coordinates options (e.g. <a href="#id9"><span class="problematic" id="id10">`SWPacific_DOMAINcfg_namelist_cfg`_</span></a>):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">vi</span> <span class="n">namelist_cfg</span>
<span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="stetched-sigma-coordinates">
<h1>Stetched sigma coordinates<a class="headerlink" href="#stetched-sigma-coordinates" title="Permalink to this headline">¶</a></h1>
<p>Vertical coordinates options (e.g. <a href="#id11"><span class="problematic" id="id12">`GThai_DOMAINcfg_namelist_cfg`_</span></a>):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cd $TDIR/DOMAINcfg
vi namelist_cfg

!!&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
!! NEMO/OPA  Configuration namelist : used to overwrite defaults values defined in SHARED/namelist_ref
!!&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
!
!-----------------------------------------------------------------------
&amp;namrun        !   parameters of the run
!-----------------------------------------------------------------------
   nn_no       =       0   !  job number (no more used...)
   cn_exp      =  &quot;domaincfg&quot;  !  experience name
   nn_it000    =       1   !  first time step
   nn_itend    =      75   !  last  time step (std 5475)
/
!-----------------------------------------------------------------------
&amp;namcfg        !   parameters of the configuration
!-----------------------------------------------------------------------
   !
   ln_e3_dep   = .false.   ! =T : e3=dk[depth] in discret sens.
   !                       !      ===&gt;&gt;&gt; will become the only possibility in v4.0
   !                       ! =F : e3 analytical derivative of depth function
   !                       !      only there for backward compatibility test with v3.6
   !                       !
   cp_cfg      =  &quot;orca&quot;   !  name of the configuration
   jp_cfg      =      12   !  resolution of the configuration
   jpidta      =     684   !  1st lateral dimension ( &gt;= jpi )
   jpjdta      =     554   !  2nd    &quot;         &quot;    ( &gt;= jpj )
   jpkdta      =      31   !  number of levels      ( &gt;= jpk )
   jpiglo      =     684   !  1st dimension of global domain --&gt; i =jpidta
   jpjglo      =     554   !  2nd    -                  -    --&gt; j  =jpjdta
   jpizoom     =       1   !  left bottom (i,j) indices of the zoom
   jpjzoom     =       1   !  in data domain indices
   jperio      =       0   !  lateral cond. type (between 0 and 6)
/
!-----------------------------------------------------------------------
&amp;namzgr        !   vertical coordinate
!-----------------------------------------------------------------------
  ln_zco      = .false.   !  z-coordinate - full    steps
  ln_zps      = .false.   !  z-coordinate - partial steps
  ln_sco      = .true.   !  s- or hybrid z-s-coordinate
  ln_isfcav   = .false.   !  ice shelf cavity
  ln_linssh   = .false.   !  linear free surface
/
!-----------------------------------------------------------------------
&amp;namzgr_sco    !   s-coordinate or hybrid z-s-coordinate
!-----------------------------------------------------------------------
  ln_s_sh94   = .false.    !  Song &amp; Haidvogel 1994 hybrid S-sigma   (T)|
  ln_s_sf12   = .true.   !  Siddorn &amp; Furner 2012 hybrid S-z-sigma (T)| if both are false the NEMO tanh stretching is applied
  ln_sigcrit  = .true.    !  use sigma coordinates below critical depth (T) or Z coordinates (F) for Siddorn &amp; Furner stretch
                          !  stretching coefficients for all functions
  rn_jpk      =   51       ! Number of S levels
  !ln_eq_taper = .false.   !  Tapering of S coords near equator
  cn_coord_hgr = &#39;coordinates.nc&#39;  ! File containing gphit (latitude) coordinate for use if ln_eq_taper=.true.
  rn_sbot_min =   10.0    !  minimum depth of s-bottom surface (&gt;0) (m)
  rn_sbot_max = 7000.0    !  maximum depth of s-bottom surface (= ocean depth) (&gt;0) (m)
  rn_hc       =   50.0    !  critical depth for transition to stretched coordinates
                       !!!!!!!  Envelop bathymetry
  rn_rmax     =    0.3    !  maximum cut-off r-value allowed (0&lt;r_max&lt;1)
                       !!!!!!!  SH94 stretching coefficients  (ln_s_sh94 = .true.)
  rn_theta    =    6.0    !  surface control parameter (0&lt;=theta&lt;=20)
  rn_bb       =    0.8    !  stretching with SH94 s-sigma
                       !!!!!!!  SF12 stretching coefficient  (ln_s_sf12 = .true.)
  rn_alpha    =    4.4    !  stretching with SF12 s-sigma
  rn_efold    =    0.0    !  efold length scale for transition to stretched coord
  rn_zs       =    1.0    !  depth of surface grid box
                          !  bottom cell depth (Zb) is a linear function of water depth Zb = H*a + b
  rn_zb_a     =    0.024  !  bathymetry scaling factor for calculating Zb
  rn_zb_b     =   -0.2    !  offset for calculating Zb
                       !!!!!!!! Other stretching (not SH94 or SF12) [also uses rn_theta above]
  rn_thetb    =    1.0    !  bottom control parameter  (0&lt;=thetb&lt;= 1)
/
</pre></div>
</div>
<p><em>(8 Nov 2017)</em>
This worked (once the levels between EXP nemo and domain_cfg were consistent).</p>
</div>
<div class="section" id="build-a-script-to-run-the-executable">
<h1>Build a script to run the executable<a class="headerlink" href="#build-a-script-to-run-the-executable" title="Permalink to this headline">¶</a></h1>
<p>Build a script to run the executable:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>vi $TDIR/DOMAINcdf/rs

#!/bin/bash
#PBS -N domain_cfg
#PBS -l walltime=00:20:00
#PBS -l select=1
#PBS -j oe
#PBS -A n01-NOCL
# mail alert at (b)eginning, (e)nd and (a)bortion of execution
#PBS -m bea
#PBS -M xxx@noc.ac.uk
#! -----------------------------------------------------------------------------

# Change to the directory that the job was submitted from
cd $PBS_O_WORKDIR

# Set the number of threads to 1
#   This prevents any system libraries from automatically
#   using threading.
export OMP_NUM_THREADS=1
# Change to the directory that the job was submitted from
ulimit -s unlimited

#===============================================================
# LAUNCH JOB
#===============================================================
echo `date` : Launch Job
aprun -n 1 -N 1 ./make_domain_cfg.exe &gt;&amp;  stdouterr_cfg

exit
</pre></div>
</div>
<p>Change the notification email to your own address:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s2">&quot;s/xxx@noc/$USER@noc/g&quot;</span> <span class="n">rs</span>
</pre></div>
</div>
<p>Try running it:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cd $TDIR/DOMAINcfg
qsub -q short rs
</pre></div>
</div>
<dl class="docutils">
<dt>Copy domain_cfg.nc to the EXP directory (also copy it to the INPUTS directory, which stores</dt>
<dd><p class="first">the bits and bobs for a rebuild):</p>
<div class="last highlight-default"><div class="highlight"><pre><span></span>rsync -utv $TDIR/DOMAINcfg/domain_cfg.nc $EXP/.
rsync -utv $TDIR/DOMAINcfg/domain_cfg.nc $INPUTS/.
</pre></div>
</div>
</dd>
</dl>
<p>I checked the <code class="docutils literal"><span class="pre">domain_cfg.nc</span></code> output with a python script <a href="#id13"><span class="problematic" id="id14">`inspect_domain_cfg.py`_</span></a>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">module</span> <span class="n">load</span> <span class="n">anaconda</span>
<span class="n">python</span> <span class="n">inspect_domain_cfg</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>which produces a transect of the grid across a section.</p>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Generate a domain configuration file</a></li>
<li><a class="reference internal" href="#hybrid-z-s-coordinates">Hybrid z-s coordinates</a></li>
<li><a class="reference internal" href="#z-partial-step-coordinates">z-partial step coordinates</a></li>
<li><a class="reference internal" href="#stetched-sigma-coordinates">Stetched sigma coordinates</a></li>
<li><a class="reference internal" href="#build-a-script-to-run-the-executable">Build a script to run the executable</a></li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/build_domain_cfg_file.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, NOC.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
      |
      <a href="_sources/build_domain_cfg_file.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>