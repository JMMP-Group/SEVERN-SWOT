<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Setting up a SE Asia NEMO configuration &#8212; NEMO-RELOC 0.1 documentation</title>
    
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="NEMO-RELOC 0.1 documentation" href="index.html" />
    <link rel="next" title="Setting up a Liverpool Bay NEMO configuration" href="LBay.html" />
    <link rel="prev" title="Template Note" href="template.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="setting-up-a-se-asia-nemo-configuration">
<h1>Setting up a SE Asia NEMO configuration<a class="headerlink" href="#setting-up-a-se-asia-nemo-configuration" title="Permalink to this headline">¶</a></h1>
<p>URL:: <a class="reference external" href="http://nemo-reloc.readthedocs.io/en/latest/SEAsia.html">http://nemo-reloc.readthedocs.io/en/latest/SEAsia.html</a></p>
<div class="section" id="issues-that-arose">
<h2>Issues that arose<a class="headerlink" href="#issues-that-arose" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Fix the sosie make.macro command</li>
</ul>
<p>Follow PyNEMO recipe for Lighthouse Reef: <code class="docutils literal"><span class="pre">http://pynemo.readthedocs.io/en/latest/examples.html#example-2-lighthouse-reef</span></code>
Follow PyNEMO recipe for LBay on ARCHER (not complete because PyNEMO java issue): <code class="docutils literal"><span class="pre">http://nemo-reloc.readthedocs.io/en/latest/LBay.html</span></code>.
Follow PyNEMO recipe for LBay on ARCHER/Livljobs4: <code class="docutils literal"><span class="pre">http://nemo-reloc.readthedocs.io/en/latest/LBay_livljobs4.html</span></code>.</p>
</div>
<div class="section" id="summary-plan">
<h2>Summary / Plan<a class="headerlink" href="#summary-plan" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Update to ORCHESTRA code base</li>
<li>Extend domain in a new experiments: 1/12 degree</li>
</ol>
</div>
<div class="section" id="recipe-notes">
<h2>Recipe Notes<a class="headerlink" href="#recipe-notes" title="Permalink to this headline">¶</a></h2>
<p>Define working directory, and other useful shortcuts:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>export CONFIG=ACCORD
export WDIR=/work/n01/n01/$USER/$CONFIG
export INPUTS=$WDIR/INPUTS
export START_FILES=$WDIR/START_FILES
export CDIR=$WDIR/dev_r6998_ORCHESTRA/NEMOGCM/CONFIG
export TDIR=$WDIR/dev_r6998_ORCHESTRA/NEMOGCM/TOOLS
export EXP=$CDIR/$CONFIG/EXP_SEAsia
</pre></div>
</div>
<p>#Load modules:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">module</span> <span class="n">swap</span> <span class="n">PrgEnv</span><span class="o">-</span><span class="n">cray</span> <span class="n">PrgEnv</span><span class="o">-</span><span class="n">intel</span>
<span class="n">module</span> <span class="n">load</span> <span class="n">cray</span><span class="o">-</span><span class="n">netcdf</span><span class="o">-</span><span class="n">hdf5parallel</span>
<span class="n">module</span> <span class="n">load</span> <span class="n">cray</span><span class="o">-</span><span class="n">hdf5</span><span class="o">-</span><span class="n">parallel</span>
</pre></div>
</div>
<p>Make the directories:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>mkdir $WDIR
mkdir $INPUTS
</pre></div>
</div>
<p>Build NEMO ORCHESTRA branch &#64; r8395:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cd $WDIR
svn co http://forge.ipsl.jussieu.fr/nemo/svn/branches/NERC/dev_r6998_ORCHESTRA@8395
</pre></div>
</div>
<p>Use Dave&#8217;s XIOS file (see <code class="docutils literal"><span class="pre">%XIOS_HOME</span></code>):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cp /work/n01/n01/mane1/ORCHESTRA/NEMOGCM/ARCH/arch-XC_ARCHER_INTEL.fcm $CDIR/../ARCH/.
</pre></div>
</div>
<p>Make a new config directory structure:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cd $CDIR
./makenemo -n $CONFIG -m XC_ARCHER_INTEL -j 10 clean
</pre></div>
</div>
<p>Copy Maria&#8217;s MY_SRC:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>rsync -uartv /work/n01/n01/mane1/ORCHESTRA/NEMOGCM/CONFIG/TIDE/MY_SRC/ $CDIR/$CONFIG/MY_SRC
</pre></div>
</div>
<p>Copy Maria&#8217;s cpp flags (without the lim flag):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>vi $CDIR/$CONFIG/cpp_ACCORD.fcm

 bld::tool::fppkeys key_mpp_mpi          \
                    key_bdy              \
                    key_tide            \
                    key_zdftke           \
                    key_netcdf4          \
                    key_iomput           \
                    key_nosignedzero    \
                    key_trabbl        \
                    key_zdfddm        \
                    key_diaharm      \
                    key_xios2
</pre></div>
</div>
<p>Build opa:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>./makenemo -n $CONFIG -m XC_ARCHER_INTEL -j 10
</pre></div>
</div>
<p><strong>It compiles!!</strong></p>
<p>Make an EXP directory:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>mkdir $EXP
</pre></div>
</div>
<hr class="docutils" />
<div class="section" id="build-some-nemo-tools-on-archer">
<h3>Build some NEMO tools (on ARCHER)<a class="headerlink" href="#build-some-nemo-tools-on-archer" title="Permalink to this headline">¶</a></h3>
<p>For the old build <code class="docutils literal"><span class="pre">dev_r4621_NOC4_BDY_VERT_INTERP/</span></code> we applied patches.
For the new build <code class="docutils literal"><span class="pre">dev_r6998_ORCHESTRA</span></code>, we do not. For some reason GRIDGEN doesn’t like INTEL:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cd $TDIR
./maketools -n WEIGHTS -m XC_ARCHER_INTEL
./maketools -n REBUILD_NEMO -m XC_ARCHER_INTEL

module unload cray-netcdf-hdf5parallel cray-hdf5-parallel
module swap PrgEnv-intel PrgEnv-cray
module load cray-netcdf cray-hdf5
./maketools -n GRIDGEN -m XC_ARCHER

module swap PrgEnv-cray PrgEnv-intel
</pre></div>
</div>
<hr class="docutils" />
<p><em>(3 Oct 2017)</em></p>
<div class="section" id="generate-mesh-and-mask-files-for-open-boundary-conditions">
<h4>5. Generate mesh and mask files for open boundary conditions<a class="headerlink" href="#generate-mesh-and-mask-files-for-open-boundary-conditions" title="Permalink to this headline">¶</a></h4>
<dl class="docutils">
<dt>Run the model to generate the mesh and mask files. Copy</dt>
<dd><p class="first">the input files from Liverpool to ARCHER:</p>
<div class="last highlight-default"><div class="highlight"><pre><span></span>ssh livljobs4

export CONFIG=SEAsia
export WDIR=/work/$USER/NEMO/$CONFIG
export START_FILES=$WDIR/START_FILES # generic stuff for making more stuff. Mostly code.
export INPUTS=$WDIR/INPUTS         # config specific stuff that gets made and is for running NEMO

# Copy into the $EXP directory
for file in bathy_meter.nc coordinates.nc; do  scp $INPUTS/$file  jelt@login.archer.ac.uk:/work/n01/n01/jelt/ACCORD/dev_r6998_ORCHESTRA/NEMOGCM/CONFIG/ACCORD/EXP_SEAsia/$file; done
for file in runscript_archer namelist_cfg namelist_ref iodef.xml; do  scp $START_FILES/$file  jelt@login.archer.ac.uk:/work/n01/n01/jelt/ACCORD/dev_r6998_ORCHESTRA/NEMOGCM/CONFIG/ACCORD/EXP_SEAsia/$file; done
</pre></div>
</div>
</dd>
</dl>
<p>&#8212;</p>
<p>Return to <strong>ARCHER</strong>. Make sure the executables are in the EXP dir.
Using XIOS from Dave:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>ln -s /work/n01/n01/munday/XIOS/bin/xios_server.exe $EXP/.
ln -s $CDIR/$CONFIG/BLD/bin/nemo.exe $EXP/opa
</pre></div>
</div>
<p>Also link in the extra XML files:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>ln -s $EXP/../../SHARED/field_def.xml $EXP/.
ln -s $EXP/../../SHARED/domain_def.xml $EXP/.
</pre></div>
</div>
<p>Edit the namelist files for this configuration:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cd $EXP
ncdump -h coordinates.nc
x = 683 ;
y = 553 ;

vi namelist.cfg
...
cn_exp      =   &quot;SEAsia&quot;  !  experience name
...
!-----------------------------------------------------------------------
&amp;namcfg        !   parameters of the configuration
!-----------------------------------------------------------------------
   cp_cfg      =  &quot;seasia&quot;                !  name of the configuration
   jp_cfg      =     012               !  resolution of the configuration
   jpidta      =     683               !  1st lateral dimension ( &gt;= jpi )
   jpjdta      =     553               !  2nd    &quot;         &quot;    ( &gt;= jpj )
   jpkdta      =      51               !  number of levels      ( &gt;= jpk )
   jpiglo      =     683               !  1st dimension of global domain --&gt; i =jpidta
   jpjglo      =     553               !  2nd    -                  -    --&gt; j  =jpjdta
</pre></div>
</div>
<p><strong>ACTION: There are further edits to be made for when the model is actually run</strong>
<strong>E.g. other filename instances of LBay</strong></p>
<p><strong>NOT SURE WHAT jp_cfg does. It might be passive? I changed it to 012, representing 1/12</strong></p>
<p>Edit the runscript to include modules and the Account name (n01-NOCL):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">vi</span> <span class="n">runscript_archer</span>

<span class="c1">#!/bin/bash</span>
<span class="c1">#PBS -N SEAsia</span>
<span class="c1">#PBS -l select=5</span>
<span class="c1">#PBS -l walltime=00:20:00</span>
<span class="c1">#PBS -A n01-NOCL</span>

<span class="n">module</span> <span class="n">swap</span> <span class="n">PrgEnv</span><span class="o">-</span><span class="n">cray</span> <span class="n">PrgEnv</span><span class="o">-</span><span class="n">intel</span>
<span class="n">module</span> <span class="n">load</span> <span class="n">cray</span><span class="o">-</span><span class="n">netcdf</span><span class="o">-</span><span class="n">hdf5parallel</span>
<span class="n">module</span> <span class="n">load</span> <span class="n">cray</span><span class="o">-</span><span class="n">hdf5</span><span class="o">-</span><span class="n">parallel</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Submit:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">qsub</span> <span class="o">-</span><span class="n">q</span> <span class="n">short</span> <span class="n">runscript_archer</span>
</pre></div>
</div>
<p><strong>IT WORKED WHEN I USED YESTERDAY&#8217;S LBAY EXECUTABLE. HOWEVER I LOST IT WHEN</strong>
<strong>I RECOMPILED THE CODE TO FIND OUT WHAT WAS DIFFERENT...</strong></p>
<hr class="docutils" />
<p><em>(6 March 2017)</em></p>
<p>If that works, we then need to rebuild the mesh and mask files in to single files for the next step:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$TDIR/REBUILD_NEMO/rebuild_nemo -t 24 mesh_mask 96
#mv mesh_mask.nc $WDIR/INPUTS
#rm mesh_* mask_* LBay_0000*
#cd $INPUTS
</pre></div>
</div>
<p>THIS IS WHERE START WITH LIVLJOBS4 to create boundary files with PyNEMO</p>
<hr class="docutils" />
<p>On <strong>livljobs4</strong> copy the mesh_mask file from <strong>ARCHER</strong>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>ssh livljobs4

export CONFIG=SEAsia
export WDIR=/work/$USER/NEMO/$CONFIG
export START_FILES=$WDIR/START_FILES # generic stuff for making more stuff. Mostly code.
export INPUTS=$WDIR/INPUTS         # config specific stuff that gets made and is for running NEMO

# Copy from the $EXP directory
scp jelt@login.archer.ac.uk:/work/n01/n01/jelt/ACCORD/dev_r6998_ORCHESTRA/NEMOGCM/CONFIG/ACCORD/EXP_SEAsia/mesh_mask.nc $INPUTS/mesh_mask.nc
</pre></div>
</div>
</div>
<div class="section" id="generate-boundary-conditions-with-pynemo-create-netcdf-abstraction-wrapper">
<h4>6. Generate boundary conditions with PyNEMO: Create netcdf abstraction wrapper<a class="headerlink" href="#generate-boundary-conditions-with-pynemo-create-netcdf-abstraction-wrapper" title="Permalink to this headline">¶</a></h4>
<p>In this section there are two stages.
* generate a ncml file which describes the files needed to create boundary conditions
* generate a namelist.bdy file which controls the actual boundary condition generation.</p>
<p>For each parent data set a new pair of (<code class="docutils literal"><span class="pre">*.ncml</span></code>, <code class="docutils literal"><span class="pre">namelist.bdy</span></code>) are needed.
Here I attempt to use parent data from:
* AMM60 local data (doesn&#8217;t yet work because of the sigma levels)
* thredds server (as in the LH_REEF example)
* NNA local data (easiest ?)</p>
<p>First install PyNEMO if not already done so. Full description:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>ssh -Y livljobs4
cd /work/$USER
export CONFIG=SEAsia
export WDIR=/work/$USER/NEMO/$CONFIG
module load anaconda/2.1.0  # Want python2
conda create --name nrct_env scipy=0.16.0 numpy matplotlib=1.5.1 basemap netcdf4 libgfortran=1.0.0
source activate nrct_env
conda install -c https://conda.anaconda.org/conda-forge seawater=3.3.4 # Note had to add https path
conda install -c https://conda.anaconda.org/srikanthnagella thredds_crawler
conda install -c https://conda.anaconda.org/srikanthnagella pyjnius
</pre></div>
</div>
<p>Find java object by doing a which java and then following the trail
find  /usr/lib/jvm/jre-1.7.0-openjdk.x86_64/ -name libjvm.so -print</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>export LD_LIBRARY_PATH=/usr/lib/jvm/jre-1.7.0-openjdk.x86_64/lib/amd64/server:$LD_LIBRARY_PATH
unset SSH_ASKPASS # Didn&#39;t need this on ARCHER...
git clone https://jpolton@bitbucket.org/jdha/nrct.git nrct  # Give jpolton@bitbucket passwd
cd nrct/Python
python setup.py build
export PYTHONPATH=/login/jelt/.conda/envs/nrct_env/lib/python2.7/site-packages/:$PYTHONPATH
python setup.py install --prefix ~/.conda/envs/nrct_env
cd $WDIR/INPUTS
</pre></div>
</div>
<p>I suggest managing the namelist.bdy file after the <code class="docutils literal"><span class="pre">ncml</span></code> file is generated.
A fresh <code class="docutils literal"><span class="pre">ncml</span></code> file can be generated automatically or an existing one can be
edited.</p>
</div>
<div class="section" id="a-generate-ncml-files-thredds-inputs-src-ncml">
<h4>6a. Generate ncml files: thredds_inputs_src.ncml<a class="headerlink" href="#a-generate-ncml-files-thredds-inputs-src-ncml" title="Permalink to this headline">¶</a></h4>
<p>Create a thredds_inputs_src.ncml file to access ORCA12 data from the
thredds server.</p>
<p>Alternatively edit an existing file:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cp $START_FILES/thredds_inputs_src.ncml $INPUTS/.
cd $INPUTS
vi thredds_inputs_src.ncml

&lt;ns0:netcdf xmlns:ns0=&quot;http://www.unidata.ucar.edu/namespaces/netcdf/ncml-2.2&quot; title=&quot;NEMO aggregation&quot;&gt;
&lt;ns0:aggregation type=&quot;union&quot;&gt;
  &lt;ns0:netcdf&gt;
    &lt;ns0:aggregation dimName=&quot;time_counter&quot; name=&quot;temperature&quot; type=&quot;joinExisting&quot;&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791206d05T.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791201d05T.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791126d05T.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791121d05T.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791116d05T.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791111d05T.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791106d05T.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791101d05T.nc&quot; /&gt;
    &lt;/ns0:aggregation&gt;
  &lt;/ns0:netcdf&gt;
  &lt;ns0:netcdf&gt;
    &lt;ns0:aggregation dimName=&quot;time_counter&quot; name=&quot;salinity&quot; type=&quot;joinExisting&quot;&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791206d05T.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791201d05T.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791126d05T.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791121d05T.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791116d05T.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791111d05T.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791106d05T.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791101d05T.nc&quot; /&gt;
    &lt;/ns0:aggregation&gt;
  &lt;/ns0:netcdf&gt;
  &lt;ns0:netcdf&gt;
    &lt;ns0:aggregation dimName=&quot;time_counter&quot; name=&quot;zonal_velocity&quot; type=&quot;joinExisting&quot;&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791206d05U.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791201d05U.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791126d05U.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791121d05U.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791116d05U.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791111d05U.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791106d05U.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791101d05U.nc&quot; /&gt;
    &lt;/ns0:aggregation&gt;
  &lt;/ns0:netcdf&gt;
  &lt;ns0:netcdf&gt;
    &lt;ns0:aggregation dimName=&quot;time_counter&quot; name=&quot;meridian_velocity&quot; type=&quot;joinExisting&quot;&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791206d05V.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791201d05V.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791126d05V.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791121d05V.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791116d05V.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791111d05V.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791106d05V.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791101d05V.nc&quot; /&gt;
    &lt;/ns0:aggregation&gt;
  &lt;/ns0:netcdf&gt;
  &lt;ns0:netcdf&gt;
    &lt;ns0:aggregation dimName=&quot;time_counter&quot; name=&quot;sea_surface_height&quot; type=&quot;joinExisting&quot;&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791206d05T.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791201d05T.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791126d05T.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791121d05T.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791116d05T.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791111d05T.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791106d05T.nc&quot; /&gt;
        &lt;ns0:netcdf location=&quot;http://esurgeod.noc.soton.ac.uk:8080/thredds/dodsC/PyNEMO/data/ORCA025-N206_19791101d05T.nc&quot; /&gt;
    &lt;/ns0:aggregation&gt;
  &lt;/ns0:netcdf&gt;
&lt;/ns0:aggregation&gt;
&lt;/ns0:netcdf&gt;
</pre></div>
</div>
</div>
<div class="section" id="b-generate-the-namelist-bdy-file-for-pynemo">
<h4>6b. Generate the namelist.bdy file for PyNEMO<a class="headerlink" href="#b-generate-the-namelist-bdy-file-for-pynemo" title="Permalink to this headline">¶</a></h4>
<p>Copy the PyNEMO template namelist.bdy from the START_FILES dir:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cd $INPUTS
cp $START_FILES/namelist.bdy $INPUTS/.
</pre></div>
</div>
<p>Edit namelist.bdy to for the configuration name and <code class="docutils literal"><span class="pre">ncml</span></code> file name. <strong>Note
need the slash following OUTPUT</strong>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>vi namelist.bdy
sn_src_dir = &#39;./thredds_inputs_src.ncml&#39;       ! src_files/&#39;
sn_dst_dir = &#39;/work/jelt/NEMO/SEAsia/INPUTS/&#39;
sn_fn      = &#39;SEAsia&#39;                 ! prefix for output files
...
cn_mask_file   = &#39;./mesh_mask.nc&#39;                   !  name of mask file (if ln_mask_file=.TRUE.)
</pre></div>
</div>
<p>Now edit the pynemo namelist file. Add location of grid information. Lots of
the separate mesh and mask files are combined into the new mesh_mask.nc output.</p>
<blockquote>
<div><p>Note use ncml to convert to variables without <a href="#id1"><span class="problematic" id="id2">*</span></a>_0.</p>
<dl class="docutils">
<dt>Make sure the timestamps correspond to the input data. (Not sure this is</dt>
<dd>important yet <em>3-Oct-17</em>)</dd>
</dl>
</div></blockquote>
<p>Turn off as many things as possible to help it along.
Turned off <code class="docutils literal"><span class="pre">ln_mask_file</span></code>. James said it was for outputting a new mask file
but it might have given me trouble.</p>
<p>NB I have a namelist.bdy file for each ncml configuration
* namelist.bdy_AMM60 (should use for LBay and Solent)
* namelist.bdy_thredds (Used here. Uses global 1/12 degree data)
* namelist.bdy_NNA (used for LBay)</p>
</div>
<div class="section" id="generate-boundary-conditions-with-pynemo-run-pynemo">
<h4>7. Generate boundary conditions with PyNEMO: Run PyNEMO<a class="headerlink" href="#generate-boundary-conditions-with-pynemo-run-pynemo" title="Permalink to this headline">¶</a></h4>
<p>Using livljobs4</p>
<p><em>(3 Oct 2017)</em></p>
<div class="highlight-default"><div class="highlight"><pre><span></span>export CONFIG=SEAsia
export WDIR=/work/$USER/NEMO/$CONFIG
export INPUTS=$WDIR/INPUTS
export START_FILES=$WDIR/START_FILES

cp $START_FILES/namelist.bdy $INPUTS/namelist.bdy
cp $START_FILES/thredds_inputs_src.ncml $INPUTS/thredds_inputs_src.ncml
cp $START_FILES/inputs_dst.ncml $INPUTS/inputs_dst.ncml
</pre></div>
</div>
<p>cd $INPUTS
Edit the namelist.bdy
Sort out the dates</p>
<p>Generate the boundary conditions again, with PyNEMO</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>module load anaconda/2.1.0  # Want python2
source activate nrct_env
export LD_LIBRARY_PATH=/usr/lib/jvm/jre-1.7.0-openjdk.x86_64/lib/amd64/server:$LD_LIBRARY_PATH

pynemo -g -s namelist.bdy
</pre></div>
</div>
<p>Sort of worked. Problem with access to the ORCA12 data:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>INFO:pynemo.reader.ncml:(1, 1, 553, 683)
INFO:pynemo.reader.ncml:(1, 1, 553, 683)
INFO:pynemo.reader.ncml:(1, 1, 553, 683)
INFO:pynemo.reader.ncml:(1, 1, 553, 683)
INFO:pynemo.profile:4.68
INFO:pynemo.profile:[&#39;wv&#39;, &#39;wu&#39;, &#39;wt&#39;, &#39;u&#39;, &#39;t&#39;, &#39;v&#39;]
INFO:pynemo.profile:wv  is (51, 1427) and a nan  max: [ 18.71657181  18.68452454]
INFO:pynemo.profile:wu  is (51, 1426) and a nan  max: [ 18.79060745  18.71673203]
INFO:pynemo.profile:wt  is (51, 12704) and a nan  max: [ 18.7412262   18.69191742]
INFO:pynemo.profile:u  is (51, 1426) and a nan  max: [ 21.30413628  21.21548653]
INFO:pynemo.profile:t  is (51, 12704) and a nan  max: [ 21.24488068  21.185709  ]
INFO:pynemo.profile:v  is (51, 1427) and a nan  max: [ 21.21529484  21.17683792]
INFO:pynemo.profile:horizontal grid info
INFO:pynemo.profile:0.02
INFO:pynemo.profile:read and assign netcdf data, lon lat
INFO:pynemo.profile:0.02
INFO:pynemo.profile:range is 12704
INFO:pynemo.profile:range is 1426
INFO:pynemo.profile:range is 1427
INFO:pynemo.profile:(12704,)
./thredds_inputs_src.ncml
Oct 03, 2017 4:31:36 PM org.apache.http.impl.client.DefaultRequestDirector tryConnect
INFO: I/O exception (java.net.NoRouteToHostException) caught when connecting to the target host: No route to host (Host unreachable)
Oct 03, 2017 4:31:36 PM org.apache.http.impl.client.DefaultRequestDirector tryConnect
INFO: Retrying connect
Traceback (most recent call last):
  File &quot;/login/jelt/.conda/envs/nrct_env/bin/pynemo&quot;, line 11, in &lt;module&gt;
    load_entry_point(&#39;pynemo==0.2&#39;, &#39;console_scripts&#39;, &#39;pynemo&#39;)()
  File &quot;/login/jelt/.conda/envs/nrct_env/lib/python2.7/site-packages/pynemo-0.2-py2.7.egg/pynemo/pynemo_exe.py&quot;, line 44, in main
    profile.process_bdy(setup_file, mask_gui)
  File &quot;/login/jelt/.conda/envs/nrct_env/lib/python2.7/site-packages/pynemo-0.2-py2.7.egg/pynemo/profile.py&quot;, line 271, in process_bdy
    reader = factory.GetReader(settings[&#39;src_dir&#39;],acc)
  File &quot;/login/jelt/.conda/envs/nrct_env/lib/python2.7/site-packages/pynemo-0.2-py2.7.egg/pynemo/reader/factory.py&quot;, line 27, in GetReader
    return NcMLReader(uri,t_adjust)
  File &quot;/login/jelt/.conda/envs/nrct_env/lib/python2.7/site-packages/pynemo-0.2-py2.7.egg/pynemo/reader/ncml.py&quot;, line 56, in __init__
    self.dataset = NetcdfDataset.openFile(self.uri, None)
  File &quot;jnius_export_class.pxi&quot;, line 893, in jnius.JavaMultipleMethod.__call__ (jnius/jnius.c:23945)
  File &quot;jnius_export_class.pxi&quot;, line 624, in jnius.JavaMethod.__call__ (jnius/jnius.c:20680)
  File &quot;jnius_export_class.pxi&quot;, line 790, in jnius.JavaMethod.call_staticmethod (jnius/jnius.c:22522)
  File &quot;jnius_utils.pxi&quot;, line 65, in jnius.check_exception (jnius/jnius.c:3815)
jnius.JavaException: JVM exception occurred: org.apache.http.conn.ConnectTimeoutException: Connect to esurgeod.noc.soton.ac.uk:8080 timed out
Exception AttributeError: &quot;&#39;Reader&#39; object has no attribute &#39;dataset&#39;&quot; in &lt;bound method Reader.__del__ of &lt;pynemo.reader.ncml.Reader object at 0x7fe5e80a0190&gt;&gt; ignored

(nrct_env)livljobs4 INPUTS $
</pre></div>
</div>
</div>
</div>
<div class="section" id="old-notes">
<h3>Old notes<a class="headerlink" href="#old-notes" title="Permalink to this headline">¶</a></h3>
<hr class="docutils" />
<p><em>(27 Sept 2017)</em></p>
</div>
</div>
<div class="section" id="build-the-new-se-asia-configuration-at-1-12-degree-r12">
<h2>Build the new SE Asia configuration at 1/12 degree, R12<a class="headerlink" href="#build-the-new-se-asia-configuration-at-1-12-degree-r12" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="generate-new-coordinates-file">
<h2>Generate new coordinates file<a class="headerlink" href="#generate-new-coordinates-file" title="Permalink to this headline">¶</a></h2>
<p>Inspect TPXO harmonic amplitudes to find a good cut off location for boundaries:</p>
<p>cd /work/jelt/tpxo7.2
ferret
go  plot_SEAsia_harmonics.jnl</p>
<dl class="docutils">
<dt>... note::</dt>
<dd><p class="first">! plot_SEAsia_harmonics.jnl
! Plot tpxo harmonics for the SE Asia region.
! Want to build a NEMO config without significant amphidromes on the boundary</p>
<p>use h_tpxo7.2.nc</p>
<p>set win 1
set viewport ul
shade/k=1/j=300:700/i=250:500/levels=(0,1,0.1)/title=&#8221;M2&#8221; HA, lon_z, lat_z; go fland
set viewport ur
shade/k=2/j=300:700/i=250:500/levels=(0,1,0.1)/title=&#8221;S2&#8221; HA, lon_z, lat_z; go fland
set viewport ll
shade/k=3/j=300:700/i=250:500/levels=(0,1,0.1)/title=&#8221;N2&#8221; HA, lon_z, lat_z; go fland
set viewport lr
shade/k=4/j=300:700/i=250:500/levels=(0,1,0.1)/title=&#8221;K2&#8221; HA, lon_z, lat_z; go fland</p>
<p class="last">set win 2
set viewport ul
shade/k=5/j=300:700/i=250:500/levels=(0,1,0.1)/title=&#8221;K1&#8221; HA, lon_z, lat_z; go fland
set viewport ur
shade/k=6/j=300:700/i=250:500/levels=(0,1,0.1)/title=&#8221;O1&#8221; HA, lon_z, lat_z; go fland
set viewport ll
shade/k=7/j=300:700/i=250:500/levels=(0,1,0.1)/title=&#8221;P1&#8221; HA, lon_z, lat_z; go fland
set viewport lr
shade/k=8/j=300:700/i=250:500/levels=(0,1,0.1)/title=&#8221;Q1&#8221; HA, lon_z, lat_z; go fland</p>
</dd>
</dl>
<p>Conclusion. Plot the proposed domain:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$livljobs2$ scp jelt@login.archer.ac.uk:/work/n01/n01/jelt/LBay/INPUTS/coordinates_ORCA_R12.nc ~/Desktop/.

ferret
use coordinates_ORCA_R12.nc
set win 1; shade/X=50:730/Y=1250:1800 E2T, nav_lon, nav_lat ; go fland
set win 2; set viewport upper; shade/i=50:730/j=1250:1800 NAV_LAT
set win 2; set viewport lower; shade/i=50:730/j=1250:1800 NAV_LON
</pre></div>
</div>
<p>&#8212;</p>
<hr class="docutils" />
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Setting up a SE Asia NEMO configuration</a><ul>
<li><a class="reference internal" href="#issues-that-arose">Issues that arose</a></li>
<li><a class="reference internal" href="#summary-plan">Summary / Plan</a></li>
<li><a class="reference internal" href="#recipe-notes">Recipe Notes</a><ul>
<li><a class="reference internal" href="#build-some-nemo-tools-on-archer">Build some NEMO tools (on ARCHER)</a><ul>
<li><a class="reference internal" href="#generate-mesh-and-mask-files-for-open-boundary-conditions">5. Generate mesh and mask files for open boundary conditions</a></li>
<li><a class="reference internal" href="#generate-boundary-conditions-with-pynemo-create-netcdf-abstraction-wrapper">6. Generate boundary conditions with PyNEMO: Create netcdf abstraction wrapper</a></li>
<li><a class="reference internal" href="#a-generate-ncml-files-thredds-inputs-src-ncml">6a. Generate ncml files: thredds_inputs_src.ncml</a></li>
<li><a class="reference internal" href="#b-generate-the-namelist-bdy-file-for-pynemo">6b. Generate the namelist.bdy file for PyNEMO</a></li>
<li><a class="reference internal" href="#generate-boundary-conditions-with-pynemo-run-pynemo">7. Generate boundary conditions with PyNEMO: Run PyNEMO</a></li>
</ul>
</li>
<li><a class="reference internal" href="#old-notes">Old notes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#build-the-new-se-asia-configuration-at-1-12-degree-r12">Build the new SE Asia configuration at 1/12 degree, R12</a></li>
<li><a class="reference internal" href="#generate-new-coordinates-file">Generate new coordinates file</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="template.html" title="previous chapter">Template Note</a></li>
      <li>Next: <a href="LBay.html" title="next chapter">Setting up a Liverpool Bay NEMO configuration</a></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/SEAsia.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, NOC.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
      |
      <a href="_sources/SEAsia.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>