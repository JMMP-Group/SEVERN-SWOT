<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Setting up AMM60 in NEMO v4 &#8212; NEMO-RELOC 0.1 documentation</title>
    
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="NEMO-RELOC 0.1 documentation" href="index.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="setting-up-amm60-in-nemo-v4">
<h1>Setting up AMM60 in NEMO v4<a class="headerlink" href="#setting-up-amm60-in-nemo-v4" title="Permalink to this headline">¶</a></h1>
<p>Machines: livljobs4, ARCHER</p>
<p>URL:: <em>to add</em>
<em>ReStrucTed text means it is trivial to deploy anywhere with whatever style</em></p>
<ul class="simple">
<li>Build notes with:: ~/GitLab/NEMO-RELOC/docs$ make html</li>
</ul>
<p>Builds AMM60 in NEMOv4</p>
<p>Build on a combination of livljobs4 and ARCHER.</p>
<p>Uses a prerelease of NEMO v4 (&#64;r8395)</p>
<p>The summary procedure:
#. ARCHER: Get code. Build tools. Generate coordinates, bathymetry, domain_cfg.nc
#. ARCHER: <em>skip: Generate initial conditions and atmospheric forcings</em>
#. ARCHER: Run simulation</p>
<p>This will borrow forcings from Guihou et al 2018 AMM60 run
<code class="docutils literal"><span class="pre">/work/n01/n01/jelt/NEMO/NEMOGCM_jdha/dev_r4621_NOC4_BDY_VERT_INTERP/NEMOGCM/CONFIG/XIOS_AMM60_nemo_harmIT2/</span></code></p>
<div class="section" id="issues-that-arose">
<h2>Issues that arose<a class="headerlink" href="#issues-that-arose" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>...</li>
</ul>
</div>
<hr class="docutils" />
<div class="section" id="recipe-notes">
<h2>Recipe Notes<a class="headerlink" href="#recipe-notes" title="Permalink to this headline">¶</a></h2>
<p>In the following I build most stuff on ARCHER.
Starting on ARCHER:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>ssh login.archer.ac.uk

export CONFIG=AMM60
export WORK=/work/n01/n01
export WDIR=$WORK/$USER/$CONFIG
export INPUTS=$WDIR/INPUTS
export START_FILES=$WDIR/START_FILES
export CDIR=$WDIR/trunk_NEMOGCM_r8395/CONFIG
export TDIR=$WDIR/trunk_NEMOGCM_r8395/TOOLS
export OLD_TDIR=$WORK/$USER/LBay/dev_r4621_NOC4_BDY_VERT_INTERP/NEMOGCM/TOOLS/
export EXP=$CDIR/$CONFIG/EXP00

module swap PrgEnv-cray PrgEnv-intel
module load cray-netcdf-hdf5parallel cray-hdf5-parallel


export AMM60DIR=/work/n01/n01/jelt/NEMO/NEMOGCM_jdha/dev_r4621_NOC4_BDY_VERT_INTERP/NEMOGCM/CONFIG/XIOS_AMM60_nemo_harmIT2/
</pre></div>
</div>
<p>&#8212;</p>
</div>
<div class="section" id="collect-essential-files">
<h2>Collect essential files<a class="headerlink" href="#collect-essential-files" title="Permalink to this headline">¶</a></h2>
<p>Note you might have to mkdir the odd directory or two...:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>mkdir $WDIR
mkdir $INPUTS
mkdir $START_FILES

cp $WDIR/../LBay/START_FILES/dommsk.F90 $START_FILES/.
cp $WDIR/../LBay/START_FILES/bdyini.F90 $START_FILES/.
#cp $WDIR/../LBay/START_FILES/coordinates_ORCA_R12.nc $START_FILES/.
#cp $WDIR/../LBay/INPUTS/namelist_reshape_bilin_gebco $START_FILES/.
#cp $WDIR/../SWPacific/START_FILES/usrdef_istate.F90 $START_FILES/.
#cp $WDIR/../SWPacific/START_FILES/usrdef_sbc.F90    $START_FILES/.
</pre></div>
</div>
<p>Checkout and build NEMO (ORCHESTRA) trunk &#64; r8395 <a href="#id1"><span class="problematic" id="id2">`build_opa_orchestra.html`_</span></a>.
Or just build (if it is already downloaded). Note here we use user defined</p>
<blockquote>
<div><p>functions for the initial state (constant T and S) and surface forcing (zero forcing):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cd $CDIR
#cp $START_FILES/usrdef_istate.F90 $CDIR/$CONFIG/MY_SRC/.
#cp $START_FILES/usrdef_sbc.F90    $CDIR/$CONFIG/MY_SRC/.

cp $START_FILES/bdyini.F90 $CDIR/$CONFIG/MY_SRC/.
cp $START_FILES/dommsk.F90 $CDIR/$CONFIG/MY_SRC/.

./makenemo -n $CONFIG -m XC_ARCHER_INTEL -j 10
</pre></div>
</div>
</div></blockquote>
<p>&#8212;</p>
<p>Checkout and build XIOS2 &#64; r1080 <a href="#id3"><span class="problematic" id="id4">`build_XIOS2.html`_</span></a>:</p>
<p>Or just link XIOS executable to the EXP directory:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>ln -s  /work/n01/n01/$USER/xios-2.0_r1080/bin/xios_server.exe $EXP/xios_server.exe
</pre></div>
</div>
<p>&#8212;</p>
</div>
<div class="section" id="build-tools">
<h2>Build TOOLS<a class="headerlink" href="#build-tools" title="Permalink to this headline">¶</a></h2>
<p>To generate domain coords and rebuild tools we first need
to compile some of the NEMO TOOLS.</p>
<p>First build DOMAINcfg (which is relatively new and in NEMOv4). Use my XIOS1 file
(see userid and path in variable <code class="docutils literal"><span class="pre">%XIOS_HOME</span></code>). Copy from ARCH <em>store</em>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cp $WORK/$USER/ARCH/arch-XC_ARCHER_INTEL_XIOS1.fcm $CDIR/../ARCH/.
cd $TDIR

./maketools -m XC_ARCHER_INTEL_XIOS1 -n DOMAINcfg
./maketools -m XC_ARCHER_INTEL_XIOS1 -n REBUILD_NEMO
</pre></div>
</div>
<p>For the generation of bathymetry and met forcing weights files we need to patch
the code (to allow direct passing of arguments. NB this code has not been
updated in 7 years.):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cd $TDIR/WEIGHTS/src
patch -b &lt; $START_FILES/scripinterp_mod.patch
patch -b &lt; $START_FILES/scripinterp.patch
patch -b &lt; $START_FILES/scrip.patch
patch -b &lt; $START_FILES/scripshape.patch
patch -b &lt; $START_FILES/scripgrid.patch

cd $TDIR
./maketools -m XC_ARCHER_INTEL_XIOS1 -n WEIGHTS
</pre></div>
</div>
<div class="section" id="generate-new-coordinates-file">
<h3>1. Generate new coordinates file<a class="headerlink" href="#generate-new-coordinates-file" title="Permalink to this headline">¶</a></h3>
<p>Or just copy it:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cp $AMM60DIR/EXP_harmIT2/WDIR/coordinates.nc $INPUTS/.
</pre></div>
</div>
</div>
<div class="section" id="generate-bathymetry-file">
<h3>2. Generate bathymetry file<a class="headerlink" href="#generate-bathymetry-file" title="Permalink to this headline">¶</a></h3>
<p>Or just copy it:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cp $AMM60DIR/EXP_harmIT2/WDIR/bathy_meter.nc $INPUTS/.
</pre></div>
</div>
</div>
<div class="section" id="generate-initial-conditions">
<h3>3. Generate initial conditions<a class="headerlink" href="#generate-initial-conditions" title="Permalink to this headline">¶</a></h3>
<p>SKIP</p>
<p>Skip this first time round. First test for stability with constant T and S.
Then try with tides.
Then try with initial conditions.</p>
<dl class="docutils">
<dt>For constant T and S use the user defined functions in <code class="docutils literal"><span class="pre">$CDIR/$CONFIG/MY_SRC</span></code>:</dt>
<dd><code class="docutils literal"><span class="pre">usrdef_sbc.F90</span></code>  and <code class="docutils literal"><span class="pre">usrdef_istate.F90</span></code>.</dd>
</dl>
</div>
</div>
<div class="section" id="generate-a-domain-configuration-file">
<h2>4. Generate a domain configuration file<a class="headerlink" href="#generate-a-domain-configuration-file" title="Permalink to this headline">¶</a></h2>
<p>The general idea is that you have to copy the <code class="docutils literal"><span class="pre">namelist_cfg</span></code> file into the <code class="docutils literal"><span class="pre">DOMAINcfg</span></code>
directory along with all the inputs files that would have previously been needed
get v3.6 running. The reason being that all the non-time stepping stuff, like
grid generating, has been abstracted from the core OPA code and is now done as
a pre-processing step, and output into an important file <code class="docutils literal"><span class="pre">domain_cfg.nc</span></code>.</p>
<p>Copy essential files into DOMAINcfg directory:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>ln -s $INPUTS/coordinates.nc $TDIR/DOMAINcfg/.
ln -s $INPUTS/bathy_meter.nc $TDIR/DOMAINcfg/.
</pre></div>
</div>
<p>Edit the template <code class="docutils literal"><span class="pre">namelist_cfg</span></code> with only the essenetial domain building stuff.
Get the size of the new domain from <code class="docutils literal"><span class="pre">ncdump</span> <span class="pre">-h</span> <span class="pre">bathy_meter.nc</span></code>.</p>
<p>Follow recipe of hybrid z-s coordinates in <a href="#id5"><span class="problematic" id="id6">`build_domain_cfg_file.rst`_</span></a></p>
<p>NB Copy namelist_cfg settings from</p>
<p><code class="docutils literal"><span class="pre">$AMM60DIR/EXP_harmIT2/namelist_cfg</span></code>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cd $TDIR/DOMAINcfg
vi namelist_cfg

/
!-----------------------------------------------------------------------
&amp;namcfg        !   parameters of the configuration
!-----------------------------------------------------------------------
   ...
   jpidta      =     1120               !  1st lateral dimension ( &gt;= jpi )
   jpjdta      =     1440               !  2nd    &quot;         &quot;    ( &gt;= jpj )
   jpkdta      =      51               !  number of levels      ( &gt;= jpk )
   jpiglo      =     1120               !  1st dimension of global domain --&gt; i =jpidta
   jpjglo      =     1440              !  2nd    -                  -    --&gt; j  =jpjdta

   ...
</pre></div>
</div>
<dl class="docutils">
<dt>When the <code class="docutils literal"><span class="pre">domain_cfg.nc</span></code> is built, copy it to the EXP directory (also copy it</dt>
<dd><p class="first">to the INPUTS directory, which stores
the bits and bobs for a rebuild):</p>
<div class="last highlight-default"><div class="highlight"><pre><span></span>rsync -utv $TDIR/DOMAINcfg/domain_cfg.nc $EXP/.
rsync -utv $TDIR/DOMAINcfg/domain_cfg.nc $INPUTS/.
</pre></div>
</div>
</dd>
</dl>
<div class="section" id="generate-weights-for-atm-forcing">
<h3>5. Generate weights for atm forcing<a class="headerlink" href="#generate-weights-for-atm-forcing" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="generate-boundary-conditions-with-nrct-pynemo-create-netcdf-abstraction-wrapper">
<h3>6. Generate boundary conditions with NRCT/PyNEMO: Create netcdf abstraction wrapper<a class="headerlink" href="#generate-boundary-conditions-with-nrct-pynemo-create-netcdf-abstraction-wrapper" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="edit-the-namelist-cfg">
<h3>7. Edit the namelist_cfg<a class="headerlink" href="#edit-the-namelist-cfg" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt>::</dt>
<dd>cd $AMM60DIR
cp -r EXP_harmIT2 EXP_v4</dd>
</dl>
<p>Hack the namcfg fields:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>vi namelist_cfg

!-----------------------------------------------------------------------
&amp;namcfg        !   parameters of the configuration
!-----------------------------------------------------------------------
ln_read_cfg = .true.   !  (=T) read the domain configuration file
   !                   !  (=F) user defined configuration  ==&gt;&gt;&gt;  see usrdef(_...) modules
   cn_domcfg = &quot;domain_cfg&quot;         ! domain configuration filename
   !
ln_write_cfg= .false.   !  (=T) create the domain configuration file
   cn_domcfg_out = &quot;domain_cfg_out&quot; ! newly created domain configuration filename
   !
ln_use_jattr = .false.  !  use (T) the file attribute: open_ocean_jstart, if present
!                       !  in netcdf input files, as the start j-row for reading
/



!-----------------------------------------------------------------------
&amp;nameos        !   ocean physical parameters
!-----------------------------------------------------------------------
   ln_teos10   = .false.         !  = Use TEOS-10 equation of state
   ln_eos80    = .true.         !  = Use EOS80 equation of state
   ln_seos     = .false.         !  = Use simplified equation of state (S-EOS)
                                 !
   !                     ! S-EOS coefficients (ln_seos=T):
   !                             !  rd(T,S,Z)*rau0 = -a0*(1+.5*lambda*dT+mu*Z+nu*dS)*dT+b0*dS
   rn_a0       =  1.6550e-1      !  thermal expension coefficient
   rn_b0       =  7.6554e-1      !  saline  expension coefficient
   rn_lambda1  =  5.9520e-2      !  cabbeling coeff in T^2  (=0 for linear eos)
   rn_lambda2  =  7.4914e-4      !  cabbeling coeff in S^2  (=0 for linear eos)
   rn_mu1      =  1.4970e-4      !  thermobaric coeff. in T (=0 for linear eos)
   rn_mu2      =  1.1090e-5      !  thermobaric coeff. in S (=0 for linear eos)
   rn_nu       =  2.4341e-3      !  cabbeling coeff in T*S  (=0 for linear eos)
/
</pre></div>
</div>
<p>Edit namelist_ref:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>vi namelist_ref
...
!-----------------------------------------------------------------------
&amp;nameos        !   ocean physical parameters
!-----------------------------------------------------------------------
   ln_teos10   = .false.         !  = Use TEOS-10 equation of state
   ln_eos80    = .false.         !  = Use EOS80 equation of state
   ln_seos     = .false.         !  = Use simplified equation of state (S-EOS)
                                 !
   !                     ! S-EOS coefficients (ln_seos=T):
   !                             !  rd(T,S,Z)*rau0 = -a0*(1+.5*lambda*dT+mu*Z+nu*dS)*dT+b0*dS
   rn_a0       =  1.6550e-1      !  thermal expension coefficient
   rn_b0       =  7.6554e-1      !  saline  expension coefficient
   rn_lambda1  =  5.9520e-2      !  cabbeling coeff in T^2  (=0 for linear eos)
   rn_lambda2  =  7.4914e-4      !  cabbeling coeff in S^2  (=0 for linear eos)
   rn_mu1      =  1.4970e-4      !  thermobaric coeff. in T (=0 for linear eos)
   rn_mu2      =  1.1090e-5      !  thermobaric coeff. in S (=0 for linear eos)
   rn_nu       =  2.4341e-3      !  cabbeling coeff in T*S  (=0 for linear eos)
/
</pre></div>
</div>
<p>SWitch in new namrun:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>!-----------------------------------------------------------------------
&amp;namrun        !   parameters of the run
!-----------------------------------------------------------------------
   nn_no       =       0   !  job number (no more used...)
   cn_exp      =    &quot;AMM60_v4&quot;  !  experience name
   nn_it000    =      1   !  first time step
   nn_itend    =      1440   !  last  time step (std 5475)
   nn_date0    =  20010101   !  date at nit_0000 (format yyyymmdd) used if ln_rstart=F or (ln_rstart=T and nn_rstctl=0 or 1)
   nn_time0    =       0   !  initial time of day in hhmm
   nn_leapy    =       0   !  Leap year calendar (1) or not (0)
   ln_rstart   = .false.   !  start from rest (F) or from a restart file (T)
      nn_euler    =    1            !  = 0 : start with forward time step if ln_rstart=T
      nn_rstctl   =    2            !  restart control ==&gt; activated only if ln_rstart=T
      !                             !    = 0 nn_date0 read in namelist ; nn_it000 : read in namelist
      !                             !    = 1 nn_date0 read in namelist ; nn_it000 : check consistancy between namelist and restart
      !                             !    = 2 nn_date0 read in restart  ; nn_it000 : check consistancy between namelist and restart
      cn_ocerst_in    = &quot;restart&quot;   !  suffix of ocean restart name (input)
      cn_ocerst_indir = &quot;.&quot;         !  directory from which to read input ocean restarts
      cn_ocerst_out   = &quot;restart&quot;   !  suffix of ocean restart name (output)
      cn_ocerst_outdir= &quot;.&quot;         !  directory in which to write output ocean restarts
   ln_iscpl    = .false.   !  cavity evolution forcing or coupling to ice sheet model
   nn_istate   =       0   !  output the initial state (1) or not (0)
   ln_rst_list = .false.   !  output restarts at list of times using nn_stocklist (T) or at set frequency with nn_stock (F)
   nn_stock    =    1440   !  frequency of creation of a restart file (modulo referenced to 1)
   nn_stocklist = 0,0,0,0,0,0,0,0,0,0 ! List of timesteps when a restart file is to be written
   nn_write    =    1440   !  frequency of write in the output file   (modulo referenced to nn_it000)
   ln_mskland  = .false.   !  mask land points in NetCDF outputs (costly: + ~15%)
   ln_cfmeta   = .false.   !  output additional data to netCDF files required for compliance with the CF metadata standard
   ln_clobber  = .true.    !  clobber (overwrite) an existing file
   nn_chunksz  =       0   !  chunksize (bytes) for NetCDF file (works only with iom_nf90 routines)
/
</pre></div>
</div>
<p>Remove namzgr and namzgr_sco</p>
<p>New namdom:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>!-----------------------------------------------------------------------
&amp;namdom        !   space and time domain (bathymetry, mesh, timestep)
!-----------------------------------------------------------------------
   ln_linssh   = .false.   !  =T  linear free surface  ==&gt;&gt;  model level are fixed in time
   nn_closea   =    0      !  remove (=0) or keep (=1) closed seas and lakes (ORCA)
   !
   nn_msh      =    0      !  create (&gt;0) a mesh file or not (=0)
   rn_isfhmin  =    1.00   !  treshold (m) to discriminate grounding ice to floating ice
   !
   rn_rdt      =  360.     !  time step for the dynamics (and tracer if nn_acc=0)
   rn_atfp     =    0.1    !  asselin time filter parameter
   !
   ln_crs      = .false.   !  Logical switch for coarsening module
/
</pre></div>
</div>
<p>Change namcrs:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>!-----------------------------------------------------------------------
&amp;namcrs        !   coarsened grid (for outputs and/or TOP)              (&quot;key_crs&quot;)
!-----------------------------------------------------------------------
   nn_factx    = 3         !  Reduction factor of x-direction
   nn_facty    = 3         !  Reduction factor of y-direction
   nn_binref   = 0         !  Bin centering preference: NORTH or EQUAT
                           !  0, coarse grid is binned with preferential treatment of the north fold
                           !  1, coarse grid is binned with centering at the equator
                           !    Symmetry with nn_facty being odd-numbered. Asymmetry with even-numbered nn_facty.
   nn_msh_crs  = 1         !  create (=1) a mesh file or not (=0)
   nn_crs_kz   = 0         ! 0, MEAN of volume boxes
                           ! 1, MAX of boxes
                           ! 2, MIN of boxes
   ln_crs_wn   = .true.    ! wn coarsened (T) or computed using horizontal divergence ( F )
/
</pre></div>
</div>
<p>Add WnD:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>!-----------------------------------------------------------------------
&amp;namwad        !   Wetting and drying                                   (default F)
!-----------------------------------------------------------------------
   ln_wd       = .false.   !  T/F activation of wetting and drying
   rn_wdmin1   =  0.1      !  Minimum wet depth on dried cells
   rn_wdmin2   =  0.01     !  Tolerance of min wet depth on dried cells
   rn_wdld     =  20.0     !  Land elevation below which wetting/drying is allowed
   nn_wdit     =  10       !  Max iterations for W/D limiter
/
</pre></div>
</div>
<p>Add in 1D config options:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>!-----------------------------------------------------------------------
&amp;namc1d        !   1D configuration options                             (&quot;key_c1d&quot;)
!-----------------------------------------------------------------------
   rn_lat1d    =      50   !  Column latitude (default at PAPA station)
   rn_lon1d    =    -145   !  Column longitude (default at PAPA station)
   ln_c1d_locpt=  .true.   ! Localization of 1D config in a grid (T) or independant point (F)
/
!-----------------------------------------------------------------------
&amp;namc1d_dyndmp !   U &amp; V newtonian damping                              (&quot;key_c1d&quot;)
!-----------------------------------------------------------------------
   ln_dyndmp   =  .false.  !  add a damping term (T) or not (F)
/
!-----------------------------------------------------------------------
&amp;namc1d_uvd    !   data: U &amp; V currents                                 (&quot;key_c1d&quot;)
!-----------------------------------------------------------------------
!              !  file name  ! frequency (hours) ! variable  ! time interp. !  clim  ! &#39;yearly&#39;/ ! weights  ! rotation ! land/sea mask !
!              !             !  (if &lt;0  months)  !   name    !   (logical)  !  (T/F) ! &#39;monthly&#39; ! filename ! pairing  ! filename      !
   sn_ucur     = &#39;ucurrent&#39;  ,         -1        ,&#39;u_current&#39;,   .false.    , .true. , &#39;monthly&#39; ,  &#39;&#39;      ,  &#39;Ume&#39;   , &#39;&#39;
   sn_vcur     = &#39;vcurrent&#39;  ,         -1        ,&#39;v_current&#39;,   .false.    , .true. , &#39;monthly&#39; ,  &#39;&#39;      ,  &#39;Vme&#39;   , &#39;&#39;
!
   cn_dir        = &#39;./&#39;    !  root directory for the location of the files
   ln_uvd_init   = .false. !  Initialisation of ocean U &amp; V with U &amp; V input data (T) or not (F)
   ln_uvd_dyndmp = .false. !  damping of ocean U &amp; V toward U &amp; V input data (T) or not (F)
/

!!======================================================================
!!            ***  Surface Boundary Condition namelists  ***
!!======================================================================
!!   namsbc          surface boundary condition
!!   namsbc_flx      flux               formulation                     (ln_flx     =T)
!!   namsbc_blk      Bulk formulae formulation                          (ln_blk     =T)
!!   namsbc_cpl      CouPLed            formulation                     (&quot;key_oasis3&quot; )
!!   namsbc_sas      Stand-Alone Surface module
!!   namtra_qsr      penetrative solar radiation                        (ln_traqsr  =T)
!!   namsbc_rnf      river runoffs                                      (ln_rnf     =T)
!!   namsbc_isf      ice shelf melting/freezing                         (nn_isf     &gt;0)
!!   namsbc_iscpl    coupling option between land ice model and ocean
!!   namsbc_apr      Atmospheric Pressure                               (ln_apr_dyn =T)
!!   namsbc_ssr      sea surface restoring term (for T and/or S)        (ln_ssr     =T)
!!   namsbc_alb      albedo parameters
!!   namsbc_wave     external fields from wave model                    (ln_wave    =T)
!!   namberg         iceberg floats                                     (ln_icebergs=T)
!!======================================================================
!
</pre></div>
</div>
<p>There is a few changes with teh structure to how the Surface Boundry Condition is applied</p>
<p>Need blk apr and rnf</p>
<p>Remove ana, clio</p>
<p>core &#8211;&gt; namsbc_blk
Add in land/sea mask column</p>
<p>Missing two variables:</p>
<dl class="docutils">
<dt>sn_slp      = &#8216;slp.15JUNE2009_fill&#8217;        ,         6         , &#8216;SLP&#8217;     ,   .false.    , .true. , &#8216;yearly&#8217;  , &#8216;weights_core_orca2_bilinear_noc.nc&#8217;  , &#8216;&#8217;       , &#8216;&#8217;</dt>
<dd>sn_tdif     = &#8216;taudif_core&#8217;                ,        24         , &#8216;taudif&#8217;  ,   .false.    , .true. , &#8216;yearly&#8217;  , &#8216;weights_core_orca2_bilinear_noc.nc&#8217;  , &#8216;&#8217;       , &#8216;&#8217;</dd>
</dl>
<p>Added in slp, below:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">sn_slp</span>      <span class="o">=</span> <span class="s1">&#39;ggas&#39;</span>             <span class="p">,</span>       <span class="mi">3</span>          <span class="p">,</span> <span class="s1">&#39;MSL&#39;</span>     <span class="p">,</span>   <span class="o">.</span><span class="n">true</span><span class="o">.</span>     <span class="p">,</span> <span class="o">.</span><span class="n">false</span><span class="o">.</span> <span class="p">,</span> <span class="s1">&#39;yearly&#39;</span>  <span class="p">,</span><span class="s1">&#39;weights_bilin.nc&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>           <span class="p">,</span> <span class="s1">&#39;&#39;</span>
</pre></div>
</div>
<p>Updated T,Q, reference height to 2m (from 10m). Choose COARE_3p0</p>
<p>Add extra variables:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>!-----------------------------------------------------------------------
&amp;namsbc_blk   !   namsbc_blk  generic Bulk formula                      (ln_blk = T)
!-----------------------------------------------------------------------
!              !  file name                    ! frequency (hours) ! variable  ! time interp. !  clim  ! &#39;yearly&#39;/ ! weights  ! rotation ! land/sea mask !
!              !                               !  (if &lt;0  months)  !   name    !   (logical)  !  (T/F) ! &#39;monthly&#39; ! filename ! pairing  ! filename      !
   sn_wndi     = &#39;ggas&#39;             ,       6          , &#39;U10&#39;     ,   .true.     , .false. , &#39;yearly&#39;  ,&#39;weights_bicub.nc&#39; , &#39;Uwnd&#39;      , &#39;&#39;
   sn_wndj     = &#39;ggas&#39;             ,       6          , &#39;V10&#39;     ,   .true.     , .false. , &#39;yearly&#39;  ,&#39;weights_bicub.nc&#39; , &#39;Vwnd&#39;      , &#39;&#39;
   sn_qsr      = &#39;gafs&#39;             ,       3          , &#39;SSRD&#39;    ,   .true.     , .false. , &#39;yearly&#39;  ,&#39;weights_bilin.nc&#39;, &#39;&#39;           , &#39;&#39;
   sn_qlw      = &#39;gafs&#39;             ,       3          , &#39;STRD&#39;    ,   .true.     , .false. , &#39;yearly&#39;  ,&#39;weights_bilin.nc&#39;, &#39;&#39;           , &#39;&#39;
   sn_tair     = &#39;ggas&#39;             ,       6          , &#39;T2&#39;      ,   .true.     , .false. , &#39;yearly&#39;  ,&#39;weights_bilin.nc&#39;, &#39;&#39;           , &#39;&#39;
   sn_humi     = &#39;ggas&#39;             ,       6          , &#39;Q&#39;      ,   .true.     , .false. , &#39;yearly&#39;  ,&#39;weights_bilin.nc&#39;, &#39;&#39;            , &#39;&#39;
   sn_prec     = &#39;gafs&#39;             ,       3          , &#39;TP&#39;      ,   .true.     , .false. , &#39;yearly&#39;  ,&#39;weights_bilin.nc&#39;, &#39;&#39;           , &#39;&#39;
   sn_snow     = &#39;gafs&#39;             ,       3          , &#39;SF&#39;      ,   .true.     , .false. , &#39;yearly&#39;  ,&#39;weights_bilin.nc&#39;, &#39;&#39;           , &#39;&#39;
   sn_slp      = &#39;ggas&#39;             ,       3          , &#39;MSL&#39;     ,   .true.     , .false. , &#39;yearly&#39;  ,&#39;weights_bilin.nc&#39;, &#39;&#39;           , &#39;&#39;
   !                    !  bulk algorithm :
   ln_NCAR     = .false.   ! &quot;NCAR&quot;      algorithm   (Large and Yeager 2008)
   ln_COARE_3p0= .true.   ! &quot;COARE 3.0&quot; algorithm   (Fairall et al. 2003)
   ln_COARE_3p5= .false.   ! &quot;COARE 3.5&quot; algorithm   (Edson et al. 2013)
   ln_ECMWF    = .false.   ! &quot;ECMWF&quot;     algorithm   (IFS cycle 31)
   !
   cn_dir      = &#39;/work/n01/n01/kariho40/NEMO/FORCINGS/ATM/ERAint/&#39;      !  root directory for the location of the bulk files
   ln_taudif   = .false.   !  HF tau contribution: use &quot;mean of stress module - module of the mean stress&quot; data
   rn_zqt      = 2.       !  Air temperature and humidity reference height (m)
   rn_zu       = 10.       !  Wind vector reference height (m)
   rn_pfac     = 1.        !  multiplicative factor for precipitation (total &amp; snow)
   rn_efac     = 1.        !  multiplicative factor for evaporation (0. or 1.)
   rn_vfac     = 0.        !  multiplicative factor for ocean/ice velocity
                           !  in the calculation of the wind stress (0.=absolute winds or 1.=relative winds)
   ln_Cd_L12   = .false.   !  Modify the drag ice-atm and oce-atm depending on ice concentration
                           !  This parameterization is from Lupkes et al. (JGR 2012)
/
</pre></div>
</div>
<p>Delelte namsbc_mfs</p>
<p>Try leaving out:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>!-----------------------------------------------------------------------
&amp;namsbc_sas    !   Stand Alone Surface boundary condition
!-----------------------------------------------------------------------
</pre></div>
</div>
<p>Add empty land/sea mask column to run off VARIABLES:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span> !-----------------------------------------------------------------------
 &amp;namsbc_rnf    !   runoffs namelist surface boundary condition
 !-----------------------------------------------------------------------
 !              !  file name           ! frequency (hours) ! variable  ! time interp. !  clim  ! &#39;yearly&#39;/ ! weights  ! rotation ! land/sea mask !
 !              !                      !  (if &lt;0  months)  !   name    !   (logical)  !  (T/F) ! &#39;monthly&#39; ! filename ! pairing  ! filename      !
    sn_rnf      = &#39;rivers&#39;   ,        24         , &#39;sorunoff&#39;,   .true.    , .true. , &#39;yearly&#39;  , &#39;&#39;       , &#39;&#39;                  , &#39;&#39;
    sn_cnf      = &#39;rivers&#39;   ,        0          , &#39;socoefr&#39;,   .true.    , .true. , &#39;yearly&#39;  , &#39;&#39;       , &#39;&#39;                   , &#39;&#39;
...
</pre></div>
</div>
<p>Add extra runoff options (not used):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>ln_rnf_depth_ini = .false. ! compute depth at initialisation from runoff file
rn_rnf_max  = 5.735e-4  !  max value of the runoff climatologie over global domain ( ln_rnf_depth_ini = .true )
rn_dep_max  = 150.      !  depth over which runoffs is spread ( ln_rnf_depth_ini = .true )
nn_rnf_depth_file = 0   !  create (=1) a runoff depth file or not (=0)
</pre></div>
</div>
<p>Edit nambdy:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>!-----------------------------------------------------------------------
&amp;nambdy        !  unstructured open boundaries
!-----------------------------------------------------------------------
    ln_bdy         = .true.              !  Use unstructured open boundaries
    nb_bdy         = 1                    !  number of open boundary sets
    ln_coords_file = .true.               !  =T : read bdy coordinates from file
    cn_coords_file = &#39;coordinates.bdy.nc&#39; !  bdy coordinates files
    ln_mask_file   = .false.              !  =T : read mask from file
    cn_mask_file   = &#39;bdy_mask.nc&#39;                   !  name of mask file (if ln_mask_file=.TRUE.)
    cn_dyn2d       = &#39;flather&#39;               !
    nn_dyn2d_dta   =  3                   !  = 0, bdy data are equal to the initial state
                                          !  = 1, bdy data are read in &#39;bdydata   .nc&#39; files
                                          !  = 2, use tidal harmonic forcing data from files
                                          !  = 3, use external data AND tidal harmonic forcing
    cn_dyn3d      =  &#39;none&#39;               !
    nn_dyn3d_dta  =  1                    !  = 0, bdy data are equal to the initial state
                                          !  = 1, bdy data are read in &#39;bdydata   .nc&#39; files
    cn_tra        =  &#39;frs&#39;               !
    nn_tra_dta    =  1                    !  = 0, bdy data are equal to the initial state
                                          !  = 1, bdy data are read in &#39;bdydata   .nc&#39; files
    cn_ice_lim      =  &#39;none&#39;             !
    nn_ice_lim_dta  =  0                  !  = 0, bdy data are equal to the initial state
                                          !  = 1, bdy data are read in &#39;bdydata   .nc&#39; files
    rn_ice_tem      = 270.                !  lim3 only: arbitrary temperature of incoming sea ice
    rn_ice_sal      = 10.                 !  lim3 only:      --   salinity           --
    rn_ice_age      = 30.                 !  lim3 only:      --   age                --

    ln_tra_dmp    =.false.                !  open boudaries conditions for tracers
    ln_dyn3d_dmp  =.false.                !  open boundary condition for baroclinic velocities
    rn_time_dmp   =  1.                   ! Damping time scale in days
    rn_time_dmp_out =  1.                 ! Outflow damping time scale
    nn_rimwidth   = 10                    !  width of the relaxation zone
    ln_vol        = .false.               !  total volume correction (see nn_volctl parameter)
    nn_volctl     = 1                     !  = 0, the total water flux across open boundaries is zero
    nb_jpk_bdy    = 75                    ! number of levels in the bdy data (set &lt; 0 if consistent with planned run)
/
</pre></div>
</div>
<p>Though not sure about ln_tra_dmp, which was a sponge in AMM60::
..</p>
<blockquote>
<div>ln_sponge     = .true.                 ! Sponge added by enda
rn_sponge     = 10                     ! Sponge diffusion multiplier</div></blockquote>
<p>Add ln_tide:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>!-----------------------------------------------------------------------
&amp;nam_tide      !   tide parameters
!-----------------------------------------------------------------------
   ln_tide     = .true.
   ln_tide_pot = .true.    !  use tidal potential forcing
   ln_tide_ramp= .false.   !
</pre></div>
</div>
<p>Copy appropriate namelist_ref:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cp  $EXP/namelist_ref namelist_ref
</pre></div>
</div>
<p>Copy necessary file across:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>rsync -utv $TDIR/DOMAINcfg/domain_cfg.nc .
</pre></div>
</div>
<p>Add in restarts:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">EXP_v4</span><span class="o">/</span><span class="n">RESTART</span>
<span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">kariho40</span><span class="o">/</span><span class="n">NEMO</span><span class="o">/</span><span class="n">NEMOGCM_jdha</span><span class="o">/</span><span class="n">dev_r4621_NOC4_BDY_VERT_INTERP</span><span class="o">/</span><span class="n">NEMOGCM</span><span class="o">/</span><span class="n">CONFIG</span><span class="o">/</span><span class="n">AMM60smago</span><span class="o">/</span><span class="n">EXPD376</span><span class="o">/</span><span class="n">RESTART</span><span class="o">/</span><span class="mi">01264320</span> <span class="o">.</span>
</pre></div>
</div>
<p>#Edit run_counter.txt::
#
#  vi run_counter.txt
#  1 1 7200 20100105
#  2 1264321 1265761</p>
<p>Edit submit script:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">vi</span> <span class="n">submit_nemo</span><span class="o">.</span><span class="n">pbs</span>
<span class="o">...</span>
<span class="c1">#PBS -N AMM60_v4</span>
<span class="c1">#PBS -l select=92</span>
<span class="c1">#PBS -l walltime=00:20:00</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">qsub</span> <span class="n">submit_nemo</span><span class="o">.</span><span class="n">pbs</span>
</pre></div>
</div>
<p>Issue in nambdy
cd  /work/n01/n01/jelt/NEMO/NEMOGCM_jdha/dev_r4621_NOC4_BDY_VERT_INTERP/NEMOGCM/CONFIG/XIOS_AMM60_nemo_harmIT2/EXP_v4
less namelist_cfg</p>
<p>REference against
/work/n01/n01/jelt/ACCORD/trunk_NEMOGCM_r8395/CONFIG/ACCORD/EXP_EAFRICA&gt; vi namelist_cfg</p>
<p>Hmmm not sure the restart WORKS</p>
<p>Try hacking submit_nemo.pbs</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>aprun -b -n $NEMOproc -N 24 ./nemo.exe : -N 5 -n $XIOSproc ./xios_server.exe &gt;&amp;stdouterr
</pre></div>
</div>
<p>Other bits:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">jelt</span><span class="o">/</span><span class="n">NEMO</span><span class="o">/</span><span class="n">NEMOGCM_jdha</span><span class="o">/</span><span class="n">dev_r4621_NOC4_BDY_VERT_INTERP</span><span class="o">/</span><span class="n">NEMOGCM</span><span class="o">/</span><span class="n">CONFIG</span><span class="o">/</span><span class="n">XIOS_AMM60_nemo_harmIT2</span><span class="o">/</span><span class="n">EXP_v4</span>
<span class="n">cp</span> <span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">jelt</span><span class="o">/</span><span class="n">AMM60</span><span class="o">/</span><span class="n">trunk_NEMOGCM_r8395</span><span class="o">/</span><span class="n">CONFIG</span><span class="o">/</span><span class="n">AMM60</span><span class="o">/</span><span class="n">EXP00</span><span class="o">/*</span><span class="n">xml</span> <span class="o">.</span>

<span class="n">qsub</span> <span class="n">submit_nemo</span><span class="o">.</span><span class="n">pbs</span>
</pre></div>
</div>
<p>Missing init.nc file for cold start</p>
<dl class="docutils">
<dt>Turn on restart flag and get nn_date0 from restart (it didn&#8217;t work taking it</dt>
<dd>from the restart).</dd>
</dl>
<p>Symbolic link restarts into EXPeriment directory:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="n">RESTART</span><span class="o">/</span><span class="mi">00</span><span class="o">*/</span><span class="n">restart</span><span class="o">*</span><span class="n">nc</span> <span class="o">.</span>
</pre></div>
</div>
<p>Missing coordinates.bdy.nc file
Check what other files might be missing. Less run_nemo. (NB the
year might not be consistent with the restart - 20010101. Note also that the xml
files already copied in):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>export YEARrun=&#39;2012&#39;
export GRIDDIR=/work/n01/n01/kariho40/NEMO/GRID         # Where to get forcings
export DATADIR=/work/n01/n01/kariho40/NEMO/FORCINGS/2010_2013           # Where to get forcings
export WDIR=/work/n01/n01/jelt/NEMO/NEMOGCM_jdha/dev_r4621_NOC4_BDY_VERT_INTERP/NEMOGCM/CONFIG/XIOS_AMM60_nemo_harmIT2/EXP_v4                        # Working directory


#===============================================================
# INPUT FILES
#===============================================================
#---------------------------------------------------------------
# Coordinates
#---------------------------------------------------------------
echo `date`: Link coordinates
ln -s $GRIDDIR/coordinates_AMM60.nc        ./coordinates.nc

#---------------------------------------------------------------
# Bathymetry
#---------------------------------------------------------------
echo `date`: Link Bathymetry
ln -s $GRIDDIR/bathyfile_AMM60_nosmooth.nc ./bathy_meter.nc


#===============================================================
# INPUT FILES
#===============================================================
#---------------------------------------------------------------
# BDY
#---------------------------------------------------------------
echo `date`: Link bdy data
TIDEDIR=$DATADIR
BDYDIR=/work/n01/n01/kariho40/NEMO/FORCINGS/2010_2013

for fic in `ls $TIDEDIR/NNA_AMM60bdy__bdytide*nc`; do
    ficdest=`basename $fic`
    ln -s $fic $WDIR/$ficdest
done

for yyyy in $YEARrun; do
  for fic in `ls $BDYDIR/AMM60bdy_NNA_R12_*${yyyy}*nc`; do
    ficdest=`basename $fic`
    ln -s $fic $WDIR/$ficdest
  done
done

ln -s $BDYDIR/coordinates.bdy.nc ./coordinates.bdy.nc
#ln -s $DATADIR/runoff_AMM60_allindex_bathynosmooth.nc ./rivers.nc
</pre></div>
</div>
<p>Changed tracer ldf parameters</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>!-----------------------------------------------------------------------
&amp;namtra_ldf    !   lateral diffusion scheme for tracers                 (default: NO diffusion)
!-----------------------------------------------------------------------
   !                       !  Operator type:
   !                           !  no diffusion: set ln_traldf_lap=..._blp=F
   ln_traldf_lap   =  .false.  !    laplacian operator
   ln_traldf_blp   =  .false.  !  bilaplacian operator
   !
   !                       !  Direction of action:
   ln_traldf_lev   =  .false.  !  iso-level
   ln_traldf_hor   =  .false.  !  horizontal (geopotential)
   ln_traldf_iso   =  .true.  !  iso-neutral (standard operator)
   ln_traldf_triad =  .false.  !  iso-neutral (triad    operator)
   !
   !                             !  iso-neutral options:
   ln_traldf_msc   =  .false.  !  Method of Stabilizing Correction (both operators)
   rn_slpmax       =   0.01    !  slope limit                      (both operators)
   ln_triad_iso    =  .false.  !  pure horizontal mixing in ML              (triad only)
   rn_sw_triad     =  1        !  =1 switching triad ; =0 all 4 triads used (triad only)
   ln_botmix_triad =  .false.  !  lateral mixing on bottom                  (triad only)
   !
   !                       !  Coefficients:
   nn_aht_ijk_t    = 0         !  space/time variation of eddy coef
   !                                !   =-20 (=-30)    read in eddy_diffusivity_2D.nc (..._3D.nc) file
   !                                !   =  0           constant
   !                                !   = 10 F(k)      =ldf_c1d
   !                                !   = 20 F(i,j)    =ldf_c2d
   !                                !   = 21 F(i,j,t)  =Treguier et al. JPO 1997 formulation
   !                                !   = 30 F(i,j,k)  =ldf_c2d * ldf_c1d
   !                                !   = 31 F(i,j,k,t)=F(local velocity and grid-spacing)
   rn_aht_0        = 125.     !  lateral eddy diffusivity   (lap. operator) [m2/s]
   rn_bht_0        = 1.e+12    !  lateral eddy diffusivity (bilap. operator) [m4/s]
/



!-----------------------------------------------------------------------
&amp;namdyn_ldf    !   lateral diffusion on momentum
!-----------------------------------------------------------------------
   !                       !  Type of the operator :
   !                           !  no diffusion: set ln_dynldf_lap=..._blp=F
   ln_dynldf_lap =  .true.    !    laplacian operator
   ln_dynldf_blp =  .false.    !  bilaplacian operator
   !                       !  Direction of action  :
   ln_dynldf_lev =  .false.    !  iso-level
   ln_dynldf_hor =  .true.    !  horizontal (geopotential)
   ln_dynldf_iso =  .false.    !  iso-neutral
   !                       !  Coefficient
   nn_ahm_ijk_t  = 0           !  space/time variation of eddy coef
   !                                !  =-30  read in eddy_viscosity_3D.nc file
   !                                !  =-20  read in eddy_viscosity_2D.nc file
   !                                !  =  0  constant
   !                                !  = 10  F(k)=c1d
   !                                !  = 20  F(i,j)=F(grid spacing)=c2d
   !                                !  = 30  F(i,j,k)=c2d*c1d
   !                                !  = 31  F(i,j,k)=F(grid spacing and local velocity)
   !                                !  = 32  F(i,j,k)=F(local gridscale and deformation rate)
   ! Caution in 20 and 30 cases the coefficient have to be given for a 1 degree grid (~111km)
   rn_ahm_0      =  50.     !  horizontal laplacian eddy viscosity   [m2/s]
   rn_ahm_b      =      0.     !  background eddy viscosity for ldf_iso [m2/s]
   rn_bhm_0      = -1.e+10      !  horizontal bilaplacian eddy viscosity [m4/s]
   !                       !  Smagorinsky settings (nn_ahm_ijk_t  = 32) :
   rn_csmc       = 3.5         !  Smagorinsky constant of proportionality
   rn_minfac     = 1.0         !  multiplier of theorectical lower limit
   rn_maxfac     = 1.0         !  multiplier of theorectical upper limit
/
</pre></div>
</div>
<p>NOTE THERE WAS SOME CONFUISON OVER THE LAP COEFF 50 or 4000?</p>
<p>Add tracer advection. AMM60 used TVD, but that is not an option now. Use &#8220;FCT&#8221;,
which with the boxS (seen in SWPacific)</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>!-----------------------------------------------------------------------
&amp;namtra_adv    !   advection scheme for tracer
!-----------------------------------------------------------------------
   ln_traadv_cen = .false. !  2nd order centered scheme
      nn_cen_h   =  4            !  =2/4, horizontal 2nd order CEN / 4th order CEN
      nn_cen_v   =  4            !  =2/4, vertical   2nd order CEN / 4th order COMPACT
   ln_traadv_fct = .true. !  FCT scheme
      nn_fct_h   =  2            !  =2/4, horizontal 2nd / 4th order
      nn_fct_v   =  2            !  =2/4, vertical   2nd / COMPACT 4th order
      nn_fct_zts =  0            !  &gt;=1,  2nd order FCT scheme with vertical sub-timestepping
      !                          !        (number of sub-timestep = nn_fct_zts)
   ln_traadv_mus = .false. !  MUSCL scheme
      ln_mus_ups = .false.       !  use upstream scheme near river mouths
   ln_traadv_ubs = .false. !  UBS scheme
      nn_ubs_v   =  2            !  =2  , vertical 2nd order FCT / COMPACT 4th order
   ln_traadv_qck = .false. !  QUICKEST scheme
/
</pre></div>
</div>
<p>Add more vvl lines:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>!-----------------------------------------------------------------------
&amp;nam_vvl  !
!-----------------------------------------------------------------------
   ln_vvl_zstar  = .true.           !  zstar vertical coordinate
   ln_vvl_ztilde = .false.          !  ztilde vertical coordinate: only high frequency variations
   ln_vvl_layer  = .false.          !  full layer vertical coordinate
   ln_vvl_ztilde_as_zstar = .false. !  ztilde vertical coordinate emulating zstar
   ln_vvl_zstar_at_eqtor  = .false. !  ztilde near the equator
   rn_ahe3       = 0.0e0            !  thickness diffusion coefficient
   rn_rst_e3t    = 30.e0            !  ztilde to zstar restoration timescale [days]
   rn_lf_cutoff  = 5.0e0            !  cutoff frequency for low-pass filter  [days]
   rn_zdef_max   = 0.9e0            !  maximum fractional e3t deformation
   ln_vvl_dbg    = .true.           !  debug prints    (T/F)
/
</pre></div>
</div>
<p>Add dyn advection and dynamics vorticity:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>!-----------------------------------------------------------------------
&amp;namdyn_adv    !   formulation of the momentum advection
!-----------------------------------------------------------------------
   ln_dynadv_vec = .true.  !  vector form (T) or flux form (F)
   nn_dynkeg     = 0       ! scheme for grad(KE): =0   C2  ;  =1   Hollingsworth correction
   ln_dynadv_cen2= .false. !  flux form - 2nd order centered scheme
   ln_dynadv_ubs = .false. !  flux form - 3rd order UBS      scheme
   ln_dynzad_zts = .false. !  Use (T) sub timestepping for vertical momentum advection
/
!-----------------------------------------------------------------------
&amp;namdyn_vor    !   option of physics/algorithm (not control by CPP keys)
!-----------------------------------------------------------------------
   ln_dynvor_ene = .false. !  enstrophy conserving scheme
   ln_dynvor_ens = .false. !  energy conserving scheme
   ln_dynvor_mix = .false. !  mixed scheme
   ln_dynvor_een = .true. !  energy &amp; enstrophy scheme
      nn_een_e3f = 1          ! e3f = masked averaging of e3t divided by 4 (=0) or by the sum of mask (=1)
   ln_dynvor_msk = .false. !  vorticity multiplied by fmask (=T) or not (=F) (all vorticity schemes)  ! PLEASE DO NOT ACTIVATE
/
</pre></div>
</div>
<p>Unhelpful error: It looks like something to do with XIOS. Try Copying
XML files from SWPacific instead of a freshly build EXP directory (as above):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">jelt</span><span class="o">/</span><span class="n">SWPacific</span><span class="o">/</span><span class="n">trunk_NEMOGCM_r8395</span><span class="o">/</span><span class="n">CONFIG</span><span class="o">/</span><span class="n">SWPacific</span><span class="o">/</span><span class="n">EXP00</span><span class="o">/*</span><span class="n">xml</span>
<span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">jelt</span><span class="o">/</span><span class="n">NEMO</span><span class="o">/</span><span class="n">NEMOGCM_jdha</span><span class="o">/</span><span class="n">dev_r4621_NOC4_BDY_VERT_INTERP</span><span class="o">/</span><span class="n">NEMOGCM</span><span class="o">/</span><span class="n">CONFIG</span><span class="o">/</span><span class="n">XIOS_AMM60_nemo_harmIT2</span><span class="o">/</span><span class="n">EXP_v4</span><span class="o">/.</span>
</pre></div>
</div>
<p>Read date from namelist:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>nn_date0    =  20100101   !  date at nit_0000 (format yyyymmdd) used if ln_rstart=F or (ln_rstart=T and nn_rstctl=0 or 1)
nn_time0    =       0   !  initial time of day in hhmm
nn_leapy    =       0   !  Leap year calendar (1) or not (0)
ln_rstart   = .true.   !  start from rest (F) or from a restart file (T)
</pre></div>
</div>
<p>Resubmit.</p>
<p>Try again:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">qsub</span> <span class="n">submit_nemo</span><span class="o">.</span><span class="n">PBS</span>
</pre></div>
</div>
</div>
<div class="section" id="initial-conditions-from-amm60-run-cold-starts">
<h3>Initial conditions from AMM60 run. Cold starts<a class="headerlink" href="#initial-conditions-from-amm60-run-cold-starts" title="Permalink to this headline">¶</a></h3>
<p>Insert new method to use AMM60 data for initial conditions.
/work/n01/n01/kariho40/NEMO/NEMOGCM_jdha/dev_r4621_NOC4_BDY_VERT_INTERP/NEMOGCM/CONFIG/AMM60smago/EXP_notradiff/OUTPUT
AMM60_5d_20131013_20131129_grid_T.nc</p>
<p>Note that the temperature and salinity variables are <code class="docutils literal"><span class="pre">thetao</span></code> and <code class="docutils literal"><span class="pre">so</span></code></p>
<div class="highlight-default"><div class="highlight"><pre><span></span>module unload cray-netcdf-hdf5parallel cray-hdf5-parallel
module load cray-netcdf cray-hdf5
module load nco/4.5.0
cd $INPUTS

ncks /work/n01/n01/kariho40/NEMO/NEMOGCM_jdha/dev_r4621_NOC4_BDY_VERT_INTERP/NEMOGCM/CONFIG/AMM60smago/EXP_notradiff/OUTPUT/AMM60_5d_20120620_20120818_grid_T.nc $INPUTS/AMM60_ave_20120620_20120818_grid_T.nc
cp $INPUTS/AMM60_ave_20120620_20120818_grid_T.nc $START_FILES/AMM60_ave_20120620_20120818_grid_T.nc
</pre></div>
</div>
<p>Average over time and restore the parallel modules (this went into a serial queue
in the script <code class="docutils literal"><span class="pre">$INPUTS/ncwa_AMM60_5d</span></code>. Took 11 minutes.):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>ncwa -a time_counter $START_FILES/AMM60_ave_20120620_20120818_grid_T.nc $INPUTS/AMM60_ave_20120620_20120818_grid_T.nc
cp $INPUTS/AMM60_ave_20120620_20120818_grid_T.nc $START_FILES/AMM60_ave_20120620_20120818_grid_T.nc

module unload nco cray-netcdf cray-hdf5
module load cray-netcdf-hdf5parallel cray-hdf5-parallel
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="cold-start">
<h3>Cold start<a class="headerlink" href="#cold-start" title="Permalink to this headline">¶</a></h3>
<p>Edit namelist:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>vi namelist_cfg
!-----------------------------------------------------------------------
&amp;namrun        !   parameters of the run
!-----------------------------------------------------------------------
   cn_exp      =    &quot;AMM60&quot;  !  experience name
   nn_it000    =  1   !  first time step
   nn_itend    =  1440 ! 30day=7200   !  last  time step (std 5475)
   nn_date0    =  20120701   !  date at nit_0000 (format yyyymmdd) used if ln_rstart=F or (ln_rstart=T and nn_rstctl=0 or 1)
   nn_time0    =       0   !  initial time of day in hhmm
   nn_leapy    =       0   !  Leap year calendar (1) or not (0)
   ln_rstart   = .false.   !  start from rest (F) or from a restart file (T)
</pre></div>
</div>
<p>init.nc &#8211;&gt; AMM60_ave_20120620_20120818_grid_T.nc with path settings</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>!-----------------------------------------------------------------------
&amp;namtsd    !   data : Temperature  &amp; Salinity
!-----------------------------------------------------------------------
! file name ! frequency (hours)    ! variable ! time interp. ! clim  !&#39;yearly&#39; or ! weights  ! rotation !
!           !  (if &lt;0  months)     !   name   !  (logical)   ! (T/F) ! &#39;monthly&#39;  ! filename ! pairing  !
   sn_tem  = &#39;AMM60_ave_20120620_20120818_grid_T.nc&#39;, -1,&#39;thetao&#39;,  .true.  , .true., &#39;yearly&#39;   , &#39; &#39;      , &#39; &#39;
   sn_sal  = &#39;AMM60_ave_20120620_20120818_grid_T.nc&#39;, -1,&#39;so&#39;,  .true.  , .true., &#39;yearly&#39;   , &#39;&#39;       , &#39; &#39;
!
   cn_dir        = &#39;/work/n01/n01/jelt/AMM60/INPUTS/&#39;     !  root directory for the location of the runoff files
   ln_tsd_init   = .true.   !  Initialisation of ocean T &amp; S with T &amp;S input data (T) or not (F)
   ln_tsd_tradmp = .false.   !  damping of ocean T &amp; S toward T &amp;S input data (T) or not (F)
/
</pre></div>
</div>
<p>&#8212;
Injected <em>(9 Feb 2018)</em>. To try and do cold starts from AMM60 T,S output. It works.
&#8212;-</p>
<p>Dead end reading in baroclinic boundary conditions. Run terminates without an error:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">levels</span> <span class="k">for</span> <span class="n">vobtcrtx</span> <span class="ow">is</span>            <span class="mi">1</span>
        <span class="n">read</span> <span class="n">vobtcrtx</span> <span class="p">(</span><span class="n">rec</span><span class="p">:</span>      <span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">kariho40</span><span class="o">/</span><span class="n">NEMO</span><span class="o">/</span><span class="n">FORCINGS</span><span class="o">/</span><span class="mi">2010</span><span class="n">_2013</span><span class="o">/</span><span class="n">AMM60bdy_NNA_R12_bdyU_y2010m01</span><span class="o">.</span><span class="n">nc</span> <span class="n">ok</span>
<span class="n">fld_init</span> <span class="p">:</span> <span class="n">time</span><span class="o">-</span><span class="n">interpolation</span> <span class="k">for</span> <span class="n">vobtcrtx</span> <span class="n">read</span> <span class="n">previous</span> <span class="n">record</span> <span class="o">=</span>      <span class="mi">1</span> <span class="n">at</span> <span class="n">time</span> <span class="o">=</span>   <span class="o">-</span><span class="mf">0.50</span> <span class="n">days</span>

<span class="o">===&gt;&gt;&gt;</span> <span class="p">:</span> <span class="n">W</span> <span class="n">A</span> <span class="n">R</span> <span class="n">N</span> <span class="n">I</span> <span class="n">N</span> <span class="n">G</span>
        <span class="o">===============</span>

<span class="n">previous</span> <span class="n">year</span><span class="o">/</span><span class="n">month</span><span class="o">/</span><span class="n">week</span><span class="o">/</span><span class="n">day</span> <span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">kariho40</span><span class="o">/</span><span class="n">NEMO</span><span class="o">/</span><span class="n">FORCINGS</span><span class="o">/</span><span class="mi">2010</span><span class="n">_20</span>
<span class="mi">13</span><span class="o">/</span><span class="n">AMM60bdy_NNA_R12_bdyV</span> <span class="ow">not</span> <span class="n">present</span> <span class="o">-&gt;</span> <span class="n">back</span> <span class="n">to</span> <span class="n">current</span> <span class="n">year</span><span class="o">/</span><span class="n">month</span><span class="o">/</span><span class="n">week</span><span class="o">/</span><span class="n">day</span>
                    <span class="n">iom_nf90_open</span> <span class="o">~~~</span> <span class="nb">open</span> <span class="n">existing</span> <span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">kariho4</span>
<span class="mi">0</span><span class="o">/</span><span class="n">NEMO</span><span class="o">/</span><span class="n">FORCINGS</span><span class="o">/</span><span class="mi">2010</span><span class="n">_2013</span><span class="o">/</span><span class="n">AMM60bdy_NNA_R12_bdyV_y2010m01</span><span class="o">.</span><span class="n">nc</span> <span class="ow">in</span> <span class="n">READ</span> <span class="n">mode</span>
                   <span class="o">---&gt;</span> <span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">kariho40</span><span class="o">/</span><span class="n">NEMO</span><span class="o">/</span><span class="n">FORCINGS</span><span class="o">/</span><span class="mi">2010</span><span class="n">_2013</span><span class="o">/</span><span class="n">AMM60bdy</span>
<span class="n">_NNA_R12_bdyV_y2010m01</span><span class="o">.</span><span class="n">nc</span> <span class="n">OK</span>
<span class="n">Dim</span> <span class="n">size</span> <span class="k">for</span> <span class="n">vobtcrty</span> <span class="ow">is</span>         <span class="mi">2642</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">levels</span> <span class="k">for</span> <span class="n">vobtcrty</span> <span class="ow">is</span>            <span class="mi">1</span>
          <span class="n">read</span> <span class="n">vobtcrty</span> <span class="p">(</span><span class="n">rec</span><span class="p">:</span>      <span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">kariho40</span><span class="o">/</span><span class="n">NEMO</span><span class="o">/</span><span class="n">FORCINGS</span><span class="o">/</span><span class="mi">2010</span><span class="n">_2013</span><span class="o">/</span><span class="n">AMM60bdy_NNA_R12_bdyV_y2010m01</span><span class="o">.</span><span class="n">nc</span> <span class="n">ok</span>
  <span class="n">fld_init</span> <span class="p">:</span> <span class="n">time</span><span class="o">-</span><span class="n">interpolation</span> <span class="k">for</span> <span class="n">vobtcrty</span> <span class="n">read</span> <span class="n">previous</span> <span class="n">record</span> <span class="o">=</span>      <span class="mi">1</span> <span class="n">at</span> <span class="n">time</span> <span class="o">=</span>   <span class="o">-</span><span class="mf">0.50</span> <span class="n">days</span>

<span class="o">===&gt;&gt;&gt;</span> <span class="p">:</span> <span class="n">W</span> <span class="n">A</span> <span class="n">R</span> <span class="n">N</span> <span class="n">I</span> <span class="n">N</span> <span class="n">G</span>
        <span class="o">===============</span>

<span class="n">previous</span> <span class="n">year</span><span class="o">/</span><span class="n">month</span><span class="o">/</span><span class="n">week</span><span class="o">/</span><span class="n">day</span> <span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">kariho40</span><span class="o">/</span><span class="n">NEMO</span><span class="o">/</span><span class="n">FORCINGS</span><span class="o">/</span><span class="mi">2010</span><span class="n">_20</span>
<span class="mi">13</span><span class="o">/</span><span class="n">AMM60bdy_NNA_R12_bdyT</span> <span class="ow">not</span> <span class="n">present</span> <span class="o">-&gt;</span> <span class="n">back</span> <span class="n">to</span> <span class="n">current</span> <span class="n">year</span><span class="o">/</span><span class="n">month</span><span class="o">/</span><span class="n">week</span><span class="o">/</span><span class="n">day</span>
                    <span class="n">iom_nf90_open</span> <span class="o">~~~</span> <span class="nb">open</span> <span class="n">existing</span> <span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">kariho4</span>
<span class="mi">0</span><span class="o">/</span><span class="n">NEMO</span><span class="o">/</span><span class="n">FORCINGS</span><span class="o">/</span><span class="mi">2010</span><span class="n">_2013</span><span class="o">/</span><span class="n">AMM60bdy_NNA_R12_bdyT_y2010m01</span><span class="o">.</span><span class="n">nc</span> <span class="ow">in</span> <span class="n">READ</span> <span class="n">mode</span>
                   <span class="o">---&gt;</span> <span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">kariho40</span><span class="o">/</span><span class="n">NEMO</span><span class="o">/</span><span class="n">FORCINGS</span><span class="o">/</span><span class="mi">2010</span><span class="n">_2013</span><span class="o">/</span><span class="n">AMM60bdy</span>
<span class="n">_NNA_R12_bdyT_y2010m01</span><span class="o">.</span><span class="n">nc</span> <span class="n">OK</span>
<span class="n">Dim</span> <span class="n">size</span> <span class="k">for</span> <span class="n">votemper</span> <span class="ow">is</span>        <span class="mi">26342</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">levels</span> <span class="k">for</span> <span class="n">votemper</span> <span class="ow">is</span>           <span class="mi">51</span>
          <span class="n">read</span> <span class="n">votemper</span> <span class="p">(</span><span class="n">rec</span><span class="p">:</span>      <span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">kariho40</span><span class="o">/</span><span class="n">NEMO</span><span class="o">/</span><span class="n">FORCINGS</span><span class="o">/</span><span class="mi">2010</span><span class="n">_2013</span><span class="o">/</span><span class="n">AMM60bdy_NNA_R12_bdyT_y2010m01</span><span class="o">.</span><span class="n">nc</span> <span class="n">ok</span>
</pre></div>
</div>
<p>Try neumann boundary conditions (as James does in his ORCHESTRA run):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cn_dyn3d      =  &#39;neumann&#39;               !
nn_dyn3d_dta  =  1
</pre></div>
</div>
<p>I thought that I had some trouble in fldread, but I think it was actually something to do with a missing met
variable...</p>
<p><strong>PENDING</strong>
Try
ln_bdy = .false.
<strong>PENDING</strong>
This works. It blows up with fast velocities at fisrt time step.</p>
<p>Try again with ln_bdy=TRUE
<strong>PENDING</strong>
Crashes:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">jelt</span><span class="p">:</span><span class="n">I</span> <span class="n">think</span> <span class="n">we</span> <span class="n">got</span> <span class="n">stuck</span> <span class="n">here</span> <span class="ow">in</span> <span class="n">fldread</span><span class="o">.</span><span class="n">F90</span><span class="o">.</span> <span class="n">jpk_bdy</span>          <span class="mi">75</span>
          <span class="n">read</span> <span class="n">vozocrtx</span> <span class="p">(</span><span class="n">rec</span><span class="p">:</span>      <span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">kariho40</span><span class="o">/</span><span class="n">NEMO</span><span class="o">/</span><span class="n">FORCINGS</span><span class="o">/</span><span class="mi">2010</span><span class="n">_2013</span><span class="o">/</span><span class="n">AMM60bdy_NNA_R12_bdyU_y2010m01</span><span class="o">.</span><span class="n">nc</span> <span class="n">ok</span>
<span class="n">jelt</span><span class="s2">&quot; pre interp</span>
</pre></div>
</div>
<p>Note to James:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>Update before I jet off to AGU

ln_bdy = F —&gt; It ran to the first time step, when it blew up - which is kind of OK as the restart field was botched.
ln_bdy = T —&gt; It fell over within the sophisticated ERROR trapping:

tail ocean.output
...
previous year/month/week/day file: /work/n01/n01/kariho40/NEMO/FORCINGS/2010_20
 13/AMM60bdy_NNA_R12_bdyU not present -&gt; back to current year/month/week/day
                     iom_nf90_open ~~~ open existing file: /work/n01/n01/kariho4
 0/NEMO/FORCINGS/2010_2013/AMM60bdy_NNA_R12_bdyU_y2010m01.nc in READ mode
                    ---&gt; /work/n01/n01/kariho40/NEMO/FORCINGS/2010_2013/AMM60bdy
 _NNA_R12_bdyU_y2010m01.nc OK
 Dim size for vozocrtx is         2642
 Number of levels for vozocrtx is           51
 jelt:I think we got stuck here in fldread.F90. jpk_bdy          75
           read vozocrtx (rec:      1) in /work/n01/n01/kariho40/NEMO/FORCINGS/2010_2013/AMM60bdy_NNA_R12_bdyU_y2010m01.nc ok
 jelt&quot; pre interp


Recall fldread.F90:

         WRITE(numout,*)&#39;jelt&quot; pre interp&#39;
         IF ( ln_bdy ) THEN
           CALL fld_bdy_interp(dta_read, dta_read_z, dta_read_dz, map, jpk_bdy, igrd, ibdy, fv, dta, fvl, ilendta)
           CALL flush(numout)
           WRITE(numout,*)&#39;jelt&quot; post interp&#39;
         ENDIF
</pre></div>
</div>
<p>Check to see if there is a problem with gdept not existing...
Inserted write statemtsn to see if arrays are empty.</p>
<p>James spotted that this is because igrd=0 when
he expect igrd=2</p>
<p>Could debug on short queue. Edit PBS script and <code class="docutils literal"><span class="pre">namelist_cfg</span> <span class="pre">(nammpp)</span></code>
&#8211;&gt; short_submit_nemo.pbs (1 XIOS, 96 NEMOPROC.
Cold start, so I do&#8217;t have to rebuild restart file.</p>
<p><strong>Short queue should work now</strong></p>
<p>James has a fix in:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">jdha</span><span class="o">/</span><span class="mi">2017</span><span class="o">/</span><span class="n">nemo</span><span class="o">/</span><span class="n">trunk</span><span class="o">/</span><span class="n">NEMOGCM</span><span class="o">/</span><span class="n">CONFIG</span><span class="o">/</span>
</pre></div>
</div>
<p>Copy files across:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>export jdhaMY_SRC=/work/n01/n01/jdha/2017/nemo/trunk/NEMOGCM/CONFIG/AMM60/MY_SRC/
cp $jdhaMY_SRC/bdy_oce.F90 $CDIR/$CONFIG/MY_SRC/bdy_oce.F90
cp $jdhaMY_SRC/bdydta.F90 $CDIR/$CONFIG/MY_SRC/bdydta.F90
</pre></div>
</div>
<p>Recompile:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cd $CDIR
./makenemo -n $CONFIG -m XC_ARCHER_INTEL -j 10
</pre></div>
</div>
<p>Resubmit (to short fewer processors - short queue is off):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">qsub</span> <span class="n">short_submit_nemo</span><span class="o">.</span><span class="n">pbs</span>
</pre></div>
</div>
<p>Core dump error. tail ocean.output:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">dyn_keg</span> <span class="p">:</span> <span class="n">kinetic</span> <span class="n">energy</span> <span class="n">gradient</span> <span class="n">trend</span><span class="p">,</span> <span class="n">scheme</span> <span class="n">number</span><span class="o">=</span>           <span class="mi">0</span>
<span class="o">~~~~~~~</span>

<span class="n">dyn_zad</span> <span class="p">:</span> <span class="n">arakawa</span> <span class="n">advection</span> <span class="n">scheme</span>

<span class="n">dyn</span><span class="p">:</span><span class="n">vor_een</span> <span class="p">:</span> <span class="n">vorticity</span> <span class="n">term</span><span class="p">:</span> <span class="n">energy</span> <span class="ow">and</span> <span class="n">enstrophy</span> <span class="n">conserving</span> <span class="n">scheme</span>
</pre></div>
</div>
<p>Take a look at the namelist setting for the vorticity dynamics. These settings
worked for the SWPacific, though they are different from Karen&#8217;s v3.6...</p>
<p>Karen&#8217;s AMM60
/work/n01/n01/jelt/NEMO/NEMOGCM_jdha/dev_r4621_NOC4_BDY_VERT_INTERP/NEMOGCM/CONFIG/XIOS_AMM60_nemo_harmIT2/EXP_harmIT2/WDIR/output.namelist.dyn</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&amp;</span><span class="n">NAMDYN_VOR</span>
<span class="n">LN_DYNVOR_ENS</span>   <span class="o">=</span> <span class="n">F</span><span class="p">,</span>
<span class="n">LN_DYNVOR_ENE</span>   <span class="o">=</span> <span class="n">F</span><span class="p">,</span>
<span class="n">LN_DYNVOR_MIX</span>   <span class="o">=</span> <span class="n">F</span><span class="p">,</span>
<span class="n">LN_DYNVOR_EEN</span>   <span class="o">=</span> <span class="n">T</span><span class="p">,</span>
<span class="n">LN_DYNVOR_EEN_OLD</span>       <span class="o">=</span> <span class="n">F</span>
<span class="o">/</span>
</pre></div>
</div>
<p>This run
/work/n01/n01/jelt/NEMO/NEMOGCM_jdha/dev_r4621_NOC4_BDY_VERT_INTERP/NEMOGCM/CONFIG/XIOS_AMM60_nemo_harmIT2/EXP_v4/output.namelist.dyn</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&amp;</span><span class="n">NAMDYN_VOR</span>
<span class="n">LN_DYNVOR_ENS</span>   <span class="o">=</span> <span class="n">F</span><span class="p">,</span>
<span class="n">LN_DYNVOR_ENE</span>   <span class="o">=</span> <span class="n">F</span><span class="p">,</span>
<span class="n">LN_DYNVOR_MIX</span>   <span class="o">=</span> <span class="n">F</span><span class="p">,</span>
<span class="n">LN_DYNVOR_EEN</span>   <span class="o">=</span> <span class="n">T</span><span class="p">,</span>
<span class="n">NN_EEN_E3F</span>      <span class="o">=</span>           <span class="mi">1</span><span class="p">,</span>
<span class="n">LN_DYNVOR_MSK</span>   <span class="o">=</span> <span class="n">F</span>
</pre></div>
</div>
<p>/</p>
<p>SWPacific
/work/n01/n01/jelt/SWPacific/trunk_NEMOGCM_r8395/CONFIG/SWPacific/EXP00/output.namelist.dyn</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&amp;</span><span class="n">NAMDYN_VOR</span>
<span class="n">LN_DYNVOR_ENS</span>   <span class="o">=</span> <span class="n">F</span><span class="p">,</span>
<span class="n">LN_DYNVOR_ENE</span>   <span class="o">=</span> <span class="n">F</span><span class="p">,</span>
<span class="n">LN_DYNVOR_MIX</span>   <span class="o">=</span> <span class="n">F</span><span class="p">,</span>
<span class="n">LN_DYNVOR_EEN</span>   <span class="o">=</span> <span class="n">T</span><span class="p">,</span>
<span class="n">NN_EEN_E3F</span>      <span class="o">=</span>           <span class="mi">1</span><span class="p">,</span>
<span class="n">LN_DYNVOR_MSK</span>   <span class="o">=</span> <span class="n">F</span>
<span class="o">/</span>
</pre></div>
</div>
<p>Would would have happened next if it didn&#8217;t crash? Karen&#8217;s tail ocean.output</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">less</span> <span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">jelt</span><span class="o">/</span><span class="n">NEMO</span><span class="o">/</span><span class="n">NEMOGCM_jdha</span><span class="o">/</span><span class="n">dev_r4621_NOC4_BDY_VERT_INTERP</span><span class="o">/</span><span class="n">NEMOGCM</span><span class="o">/</span><span class="n">CONFIG</span><span class="o">/</span><span class="n">XIOS_AMM60_nemo_harmIT2</span><span class="o">/</span><span class="n">EXP_harmIT2</span><span class="o">/</span><span class="n">LOGS</span><span class="o">/</span><span class="n">restart</span><span class="o">/</span><span class="n">ocean</span><span class="o">.</span><span class="n">output_EXP_harmIT2</span>
<span class="o">...</span>
<span class="n">dyn_zad</span> <span class="p">:</span> <span class="n">arakawa</span> <span class="n">advection</span> <span class="n">scheme</span>

<span class="n">dyn</span><span class="p">:</span><span class="n">vor_een</span> <span class="p">:</span> <span class="n">vorticity</span> <span class="n">term</span><span class="p">:</span> <span class="n">energy</span> <span class="ow">and</span> <span class="n">enstrophy</span> <span class="n">conserving</span> <span class="n">scheme</span>
<span class="o">~~~~~~~~~~~</span>

<span class="n">dyn_ldf_iso</span> <span class="p">:</span> <span class="n">iso</span><span class="o">-</span><span class="n">neutral</span> <span class="n">laplacian</span> <span class="n">diffusive</span> <span class="n">operator</span> <span class="ow">or</span>
<span class="o">~~~~~~~~~~~</span>   <span class="n">s</span><span class="o">-</span><span class="n">coordinate</span> <span class="n">horizontal</span> <span class="n">diffusive</span> <span class="n">operator</span>

<span class="n">dyn</span><span class="p">:</span><span class="n">hpg_prj</span> <span class="p">:</span> <span class="n">hydrostatic</span> <span class="n">pressure</span> <span class="n">gradient</span> <span class="n">trend</span>
<span class="o">~~~~~~~~~~~</span>   <span class="n">s</span><span class="o">-</span><span class="n">coordinate</span> <span class="n">case</span><span class="p">,</span> <span class="n">cubic</span> <span class="n">spline</span> <span class="n">pressure</span> <span class="n">Jacobian</span>
<span class="o">...</span>
</pre></div>
</div>
<p>This run:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">tail</span> <span class="o">-</span><span class="mi">100</span> <span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">n01</span><span class="o">/</span><span class="n">jelt</span><span class="o">/</span><span class="n">NEMO</span><span class="o">/</span><span class="n">NEMOGCM_jdha</span><span class="o">/</span><span class="n">dev_r4621_NOC4_BDY_VERT_INTERP</span><span class="o">/</span><span class="n">NEMOGCM</span><span class="o">/</span><span class="n">CONFIG</span><span class="o">/</span><span class="n">XIOS_AMM60_nemo_harmIT2</span><span class="o">/</span><span class="n">EXP_v4</span><span class="o">/</span><span class="n">ocean</span><span class="o">.</span><span class="n">output</span>

<span class="o">...</span>

<span class="n">dyn_zad</span> <span class="p">:</span> <span class="n">arakawa</span> <span class="n">advection</span> <span class="n">scheme</span>

<span class="n">dyn</span><span class="p">:</span><span class="n">vor_een</span> <span class="p">:</span> <span class="n">vorticity</span> <span class="n">term</span><span class="p">:</span> <span class="n">energy</span> <span class="ow">and</span> <span class="n">enstrophy</span> <span class="n">conserving</span> <span class="n">scheme</span>
<span class="o">~~~~~~~~~~~</span>
</pre></div>
</div>
<p>So perhaps it is an issue with dyn_ldf_iso?</p>
<p>Comparing with SEAsia (LN_DYNLDF_BLP=T) instead of Karen&#8217;s (LN_DYNLDF_LAP=T)
Try switching to BLP=T</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>vi namelist_cfg
...
!-----------------------------------------------------------------------
&amp;namdyn_ldf    !   lateral diffusion on momentum
!-----------------------------------------------------------------------
   !                       !  Type of the operator :
   !                           !  no diffusion: set ln_dynldf_lap=..._blp=F
   ln_dynldf_lap =  .false.    !    laplacian operator
   ln_dynldf_blp =  .true.    !  bilaplacian operator
   !                       !  Direction of action  :
   ln_dynldf_lev =  .true.    !  iso-level
   ln_dynldf_hor =  .false.    !  horizontal (geopotential)
   ln_dynldf_iso =  .false.    !  iso-neutral
   !                       !  Coefficient
   nn_ahm_ijk_t  = 0           !  space/time variation of eddy coef
   !                                !  =-30  read in eddy_viscosity_3D.nc file
   !                                !  =-20  read in eddy_viscosity_2D.nc file
   !                                !  =  0  constant
   !                                !  = 10  F(k)=c1d
   !                                !  = 20  F(i,j)=F(grid spacing)=c2d
   !                                !  = 30  F(i,j,k)=c2d*c1d
   !                                !  = 31  F(i,j,k)=F(grid spacing and local velocity)
   !                                !  = 32  F(i,j,k)=F(local gridscale and deformation rate)
   ! Caution in 20 and 30 cases the coefficient have to be given for a 1 degree grid (~111km)
   rn_ahm_0      =  0.     !  horizontal laplacian eddy viscosity   [m2/s]
   rn_ahm_b      =      0.     !  background eddy viscosity for ldf_iso [m2/s]
   rn_bhm_0      = -1.25e+10      !  horizontal bilaplacian eddy viscosity [m4/s]
   !                       !  Smagorinsky settings (nn_ahm_ijk_t  = 32) :
   rn_csmc       = 3.5         !  Smagorinsky constant of proportionality
   rn_minfac     = 1.0         !  multiplier of theorectical lower limit
   rn_maxfac     = 1.0         !  multiplier of theorectical upper limit
/
</pre></div>
</div>
<p>Submit:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">qsub</span> <span class="n">short_submit_nemo</span>
</pre></div>
</div>
<p>Still get a core dump with the last ocean.output at:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">dyn</span><span class="p">:</span><span class="n">vor_een</span> <span class="p">:</span> <span class="n">vorticity</span> <span class="n">term</span><span class="p">:</span> <span class="n">energy</span> <span class="ow">and</span> <span class="n">enstrophy</span> <span class="n">conserving</span> <span class="n">scheme</span>
</pre></div>
</div>
<p>So it probably is an issue with the vorticity routine.</p>
<p>Check <code class="docutils literal"><span class="pre">NEMO/OPA_SRC/DYN/dynvor.F90</span></code>. This is where the WRITE statement is made.</p>
<p>&#8212;
<em>(17 Feb 18)</em> Something wrong with domain_cfg.nc</p>
<p>Copy namelist_ref file from AMM60DIR/EXP_harmIT2/namelist_ref</p>
<p>resubmit:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">qsub</span> <span class="n">rs</span>
</pre></div>
</div>
<p>Still had odd islands at j~107</p>
</div>
<div class="section" id="next-steps">
<h3>Next steps<a class="headerlink" href="#next-steps" title="Permalink to this headline">¶</a></h3>
<p>Tidy code in MY_SRC. Probably some debugging WRITE statements to remove.
Do something smarter with the link to the initial conditions. Add a symbolic link
from run directory to $INPUTS</p>
</div>
<div class="section" id="update-tides-code-with-nico-s-version">
<h3>Update tides code with Nico&#8217;s version.<a class="headerlink" href="#update-tides-code-with-nico-s-version" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="mpp-decomposition-for-land-suppression">
<h3>MPP decomposition for land suppression<a class="headerlink" href="#mpp-decomposition-for-land-suppression" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="backup-to-repo-key-files">
<h3>Backup to repo key files<a class="headerlink" href="#backup-to-repo-key-files" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="rebuild-the-output-and-inspect-rebuild-and-inspect-nemo-output-rst">
<h3>Rebuild the output and inspect <a href="#id7"><span class="problematic" id="id8">`rebuild_and_inspect_NEMO_output.rst`_</span></a><a class="headerlink" href="#rebuild-the-output-and-inspect-rebuild-and-inspect-nemo-output-rst" title="Permalink to this headline">¶</a></h3>
<p>&#8212;</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Setting up AMM60 in NEMO v4</a><ul>
<li><a class="reference internal" href="#issues-that-arose">Issues that arose</a></li>
<li><a class="reference internal" href="#recipe-notes">Recipe Notes</a></li>
<li><a class="reference internal" href="#collect-essential-files">Collect essential files</a></li>
<li><a class="reference internal" href="#build-tools">Build TOOLS</a><ul>
<li><a class="reference internal" href="#generate-new-coordinates-file">1. Generate new coordinates file</a></li>
<li><a class="reference internal" href="#generate-bathymetry-file">2. Generate bathymetry file</a></li>
<li><a class="reference internal" href="#generate-initial-conditions">3. Generate initial conditions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#generate-a-domain-configuration-file">4. Generate a domain configuration file</a><ul>
<li><a class="reference internal" href="#generate-weights-for-atm-forcing">5. Generate weights for atm forcing</a></li>
<li><a class="reference internal" href="#generate-boundary-conditions-with-nrct-pynemo-create-netcdf-abstraction-wrapper">6. Generate boundary conditions with NRCT/PyNEMO: Create netcdf abstraction wrapper</a></li>
<li><a class="reference internal" href="#edit-the-namelist-cfg">7. Edit the namelist_cfg</a></li>
<li><a class="reference internal" href="#initial-conditions-from-amm60-run-cold-starts">Initial conditions from AMM60 run. Cold starts</a></li>
<li><a class="reference internal" href="#cold-start">Cold start</a></li>
<li><a class="reference internal" href="#next-steps">Next steps</a></li>
<li><a class="reference internal" href="#update-tides-code-with-nico-s-version">Update tides code with Nico&#8217;s version.</a></li>
<li><a class="reference internal" href="#mpp-decomposition-for-land-suppression">MPP decomposition for land suppression</a></li>
<li><a class="reference internal" href="#backup-to-repo-key-files">Backup to repo key files</a></li>
<li><a class="reference internal" href="#rebuild-the-output-and-inspect-rebuild-and-inspect-nemo-output-rst">Rebuild the output and inspect `rebuild_and_inspect_NEMO_output.rst`_</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/AMM60_archer_livljobs.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, NOC.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
      |
      <a href="_sources/AMM60_archer_livljobs.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>